function addSettingsPopover(){$("a[id^=options_]").css("visibility","visible").each(function(){$(this).popover({html:!0,placement:$(this).attr("pop-placement")?$(this).attr("pop-placement"):"auto",content:$("#alignmentOptions"),container:1==$(this).closest("#viewerWrapper").length?"#right-panel":"body"})}).on("show.bs.popover",function(t){var e=$(this).attr("id").substring(8);$(this).data("bs.popover").$tip.find("#exportOptions");$("#currentAlignmentIndex").val(e),1==$("#exportOptions").length?($("#alignmentOptions").show(),""==e?$("#exportOptions").hide():$("#exportOptions").show()):$("a[id^=options_]").each(function(){$(this).data("bs.popover")&&$(this).data("bs.popover").$tip&&1==$(this).data("bs.popover").$tip.find("#exportOptions").length&&(""==e?$(this).data("bs.popover").$tip.find("#exportOptions").hide():$(this).data("bs.popover").$tip.find("#exportOptions").show())})})}function resetChainMappingColours(){for(s in chainMapping.structures)for(c in chainMapping.structures[s])for(r in chainMapping.structures[s][c])delete chainMapping.structures[s][c][r].rgb}!function(A){var C={gapChar:"-"},t=!1,M=!1,P=null,S=0,B=0,v=!1,k=0,E=0,R=[[136,221,204],[213,178,64],[187,187,221],[255,136,119],[136,187,221],[255,187,102],[187,221,102],[255,204,238],[166,206,227],[187,136,187],[204,238,204],[166,206,227]],r={init:function(e){return t||(t=!0,A(document).keydown(function(t){if(M&&A(".fancybox-desktop:visible").length<1){var e=t;if(v)e.preventDefault();else{var n=A("span.cursor").closest(".alignTbl");if(32==e.keyCode)e.preventDefault(),y();else if(8==e.keyCode||46==e.keyCode)e.preventDefault(),w(8==e.keyCode);else{if(27==e.keyCode)return void(n.data("startEditRegion",null),n.data("endEditRegion",null),A(".shadowCursor").removeClass("shadowCursor"));if((e.ctrlKey||e.metaKey)&&90==e.keyCode)return void function(t){var e,n=A("body").data("editHistory");null==n||n.length<1||(n=n.pop(),i(t,n,!0,!0),0<(e=A(".alignTbl").not(t)).length&&(i(e,n,!0,!1),A(".cursor").removeClass("cursor"),t.find("tr[seqno="+P.seqno+"]").find("span").eq(P.seqidx).addClass("cursor")))}(n)}T(null,e)}}else 27==t.keyCode&&(A(".hoverResidue").removeClass("hoverResidue"),A(".selectResidue").removeClass("selectResidue"))})),this.each(function(){var t=A.extend({},{type:"target-template",chaingroups:[],keyseq_sequence:e.keyseq_sequence,keyseq_chain_name:e.keyseq_chain_name||["A"],keyseq_annotation:e.keyseq_annotation},e.templateData);if(e.nowrap&&(t.nowrap=!0),e.charts&&e.keyseq_annotation){for(key in t.qmLength=0,t.charts=e.charts,e.keyseq_annotation)break;e.keyseq_annotation[key].qmean&&(t.pageResidueCount=e.pageResidueCount,S=48),B=12}e.resetColourCycle&&(k=0),e.firstDraw=!0,A(this).data("templateData",t),D(A(this),null,e),r.toggleIdenticalSeqs.call(this,{chaingroups:t.chaingroups},!1),r.resizeToParent.call(A(this),{redrawAnnotation:!1}),j(A(this)),n(A(this))})},toggleIdenticalSeqs:function(h,c){return A(this).each(function(){for(var t=A(this),e=L(t),n=0;n<h.chaingroups.length;n++){var i=h.chaingroups[n].filter(function(){return!0});if(!(i.length<2)){for(var a=i[0],s=e.find('tr[chain="'+a+'"]').first().text(),r=s.substring(0,s.lastIndexOf(".")+1)+"("+i.join("")+")",s=s.substring(0,s.lastIndexOf("."))+"."+a.charAt(0),o="",l=1;l<i.length;l++)o+="[chain="+i[l]+"]",l<i.length-1&&(o+=",");t.find("tr"+o).toggle(),e.find("tr"+o).toggle(),"none"==e.find("tr[chain="+i[1]+"]").css("display")?e.find("tr[chain="+a+"]").find("td").html(r):e.find("tr[chain="+a+"]").find("td").html(s)}}void 0!==c&&!c||j(t)})},drawAlignment:function(t){return this.each(function(){D(A(this),t?t.seqs:null,t||null),n(A(this))})},getFormattedAlignment:function(t){return e(A(this).attr("id").substring(8),t.format)},exportAlignment:function(t){return this.each(function(){A("#formattedAlignment").show(),A("#alignmentFormatSelect").val(t.format),a(),A("<a href='#formattedAlignment' title='Copy & Paste Alignment'/>'").fancybox({helpers:{title:{type:"inside"}}}).trigger("click"),A("#formattedAlignmentTextarea").focus(),A("#formattedAlignmentTextarea").select()})},html2image:function(t){A.fancybox.close(),A(".popover").hide();var e=A("#currentAlignmentIndex").val(),e=function(t){$alignNameTbl=L(t);var a,s,r,e=t.closest(".alignTblContainer").outerWidth(),n=t.closest(".alignTblContainer").outerHeight(),o='<svg xmlns="http://www.w3.org/2000/svg"  width="'+(e+=10)+'" height="'+n+'"><rect x="0" y="0" fill="white" width="'+e+'" height="'+n+'"/>',i=$alignNameTbl.outerWidth()+10,l=$alignNameTbl.offset().left-10,h=t.find("td:eq(0)"),e=h.outerWidth(),c=A("<div>").append(A("#"+t.attr("id")+"_features svg").first().clone()).html().replace(/name="[\d_]+" /g,"").replace(/r="4" /g,""),e=(o=(o=o+'<defs><clipPath id="cp2"><rect x="0" y="0" width="'+e+'" height="'+n+'"/></clipPath></defs><g transform="translate('+i+',0)" clip-path="url(#cp2)">')+c.substring(c.indexOf("</defs>")+7,c.indexOf("</svg>"))+"</g>",t.find("tr:visible"));e.each(function(t,n){A(this).find("span.ligandContact").each(function(t,e){a=n.offsetTop+e.offsetTop,s||(s=A(e).outerWidth(),r=A(e).outerHeight());A(e).css("color");o+='<rect style="fill:#CC4444;fill-opacity:0.8;" width="'+s+'" height="'+r+'" x="'+(A(e).offset().left-l)+'" y="'+a+'" />'})}),o+='<text text-anchor="end" font-size="'+h.css("font-size")+"\" font-family='"+h.css("font-family")+"'>",(e=$alignNameTbl.find("tr:visible")).each(function(t,e){var n=A(this).find("td").css("padding-top"),n=parseInt(n.substring(0,n.length-2));a=e.offsetTop+12+n,o+='<tspan x="'+(i-2)+'" y="'+a+'">'+e.textContent.replace("QMEAN","")+"</tspan>"}),o+="</text>",(e=t.find("tr:visible")).offset().left;return e.each(function(t,i){o+='<text text-anchor="middle" font-size="'+h.css("font-size")+"\" font-family='"+h.css("font-family")+"'>",A(this).find("span").each(function(t,e){var n;s||(s=A(e).outerWidth(),r=A(e).outerHeight()),"relative"!=e.style.position&&(n="fill:"+(n=A(e).css("color"))+";","bold"==e.style.fontWeight&&(n+="font-weight:bold;"),0<n.length&&(n=' style="'+n+'" '),a=i.offsetTop+e.offsetTop+12,o+='<tspan x="'+(A(e).offset().left-l+s/2)+'" y="'+a+'"'+n+">"+e.textContent+"</tspan>")}),o+="</text>",(td=A(this).find("td")[1])&&(o+='<text text-anchor="start" font-size="'+h.css("font-size")+"\" font-family='"+h.css("font-family")+"'><tspan x=\""+(A(td).offset().left-l+10)+'" y="'+a+'">'+td.textContent+"</tspan></text>")}),e.each(function(t,i){A(this).find("span").not(".ligandContact").each(function(t,e){a=i.offsetTop+e.offsetTop;var n=A(e).css("backgroundColor");n&&"transparent"!=n&&"rgb(255, 255, 255)"!=n&&(o+='<rect x="'+(A(e).offset().left-l)+'" y="'+a+'" width="'+s+'" height="'+r+'" style="fill:'+n+';"/>')})}),o+"</svg>"}($alTbl=A("#alignTbl"+e)),e=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),e=(window.URL||window.webkitURL||window).createObjectURL(e),n=new Image,i=document.createElement("canvas"),a=i.getContext("2d");n.onload=function(){i.width=this.naturalWidth,i.height=this.naturalHeight,a.drawImage(this,0,0),i.toBlob(function(t){saveAs(t,"alignment.png")},"image/png")},n.src=e},colourAllAlignments:function(e){resetChainMappingColours(),e.features?A(".alignTbl").each(function(){let n=[];A(this).find("tr[struc_id]").each(function(t,e){e=e.getAttribute("struc_id");-1==n.indexOf(e)&&n.push(e)});var t={};for(struc_id in e.features)-1<n.indexOf(struc_id)&&(t[struc_id]=e.features[struc_id]);0==Object.keys(t).length?A(this).removeData("features"):A(this).data("features",t),H("features",A(this))}):(e.col?e.col!=chainMapping.defaultColourScheme&&e.col!=jQuery.cookie("colourScheme")&&jQuery.cookie("colourScheme",e.col,{expires:365,path:"/"}):(e.col=chainMapping.defaultColourScheme,e.col||(e.col=jQuery.cookie("colourScheme"))),A(".alignTbl").each(function(){A(this).removeData("features"),H(e.col,A(this))})),u()},changeExportFormat:function(t){return this.each(function(){a()})},secondaryStructure:function(t){t&&jQuery.cookie("secStruct",t.sstype,{expires:365,path:"/"});var l=null,l=t?t.sstype:A.cookie("secStruct"),t=(B="none"==(l=null==l?"dssp":l)?0:12,this.each(function(){A(this).data("templateData")&&(j(A(this)),"secstruc"==A.cookie("colourScheme")&&H("secstruc",A(this)))})),e=null,n=null,i=null;if("undefined"!=typeof globalTemplateData?(A("#alignTbl"),"undefined"!=typeof globalTemplateData&&(n=globalTemplateData)):A(this).data("templateData")&&("model-template"==A(this).data("templateData").type?i=!0:(n=[],this.each(function(){A(this).data("templateData")&&(n=n.concat(A(this).data("templateData").templates))}))),0<A("#pv:visible",currentWin.document).length){if(i)this.each(function(){var t=A(this).data("templateData");if(t){var e=t.struc_id;if(pv_viewer.get(e)){var n=pv_viewer.get(e).structure(),i=(pv_viewer.rm(e),"none"==l);if(!i)for(var a=0;a<t.keyseq_chain_name.length;a++){var s=t.keyseq_chain_name[a],r=(r=t.templates[0].trg_offset)||1,o=t.keyseq_annotation[s][l+"_string"],s=n.select({chain:s});o?s.eachResidue(function(t){t.full().setSS(o[t.num()-r])}):i=!0}i&&n.select("protein").eachResidue(function(t){t.full().setSS("")}),pv_viewer.cartoon(e,n,{color:pv.color.uniform("white")})}}});else for(var a=0;a<n.length;a++)if(n[a].selected){var s=n[a].struc_id,e=pv_viewer.get(s).structure();if(pv_viewer.rm(s),"none"==l)e.select("protein").eachResidue(function(t){t.full().setSS("")});else if(n[a].targets)for(var r=0;r<n[a].targets.length;r++)for(var o=n[a].targets[r],h=0;h<o.chain.length;h++)c=(c=o.annotation[o.chain[h]][l+"_string"])||o.annotation[o.chain[h]][l],e.select({chain:o.chain[h]}).eachResidue(function(t){t.full().setSS(c[t.num()-1])});else{var c=(c=n[a].annotation[l+"_string"])||n[a].annotation[l];e.select({chain:n[a].chain}).eachResidue(function(t){t.full().setSS(c?c[t.num()-1]:"")})}pv_viewer.cartoon(s,e,{color:pv.color.uniform("white")})}}else if(0<A("#ngl:visible",currentWin.document).length)if(i)this.each(function(){var t=A(this).data("templateData");if(t)for(var e=t.struc_id,n="none"==l,i=0;i<t.keyseq_chain_name.length;i++){var a=t.keyseq_chain_name[i],s=(s=t.templates[0].trg_offset)||1,r=t.keyseq_annotation[a][l+"_string"];for(comp in r||(n=!0),ngl_stage.compList)if(ngl_stage.compList[comp].name==e){ngl_stage.compList[comp].structure.eachResidue(function(t){t.chainname==a&&(t.sstruc=n?"":r[t.resno-s].toLowerCase())});break}}});else for(a=0;a<n.length;a++)if(n[a].selected){if(ngl_stage.eachRepresentation(function(t){if(t.name&&!t.name.match(/(ligands|dna|over)/)){var e=t.name;for(comp in ngl_stage.compList)ngl_stage.compList[comp].name==e&&ngl_stage.compList[comp].removeRepresentation(t)}}),"none"==l)for(comp in ngl_stage.compList)ngl_stage.compList[comp].name==n[a].struc_id&&ngl_stage.compList[comp].structure.eachResidue(function(t){t.sstruc=""});else if(n[a].targets){for(r=0;r<n[a].targets.length;r++)for(o=n[a].targets[r],h=0;h<o.chain.length;h++)for(comp in c=(c=o.annotation[o.chain[h]][l+"_string"])||o.annotation[o.chain[h]][l],ngl_stage.compList)if(ngl_stage.compList[comp].name==n[a].struc_id){ngl_stage.compList[comp].structure.eachResidue(function(t){t.chainname==o.chain[h]&&(t.sstruc=c[t.resno-1].toLowerCase())});break}}else for(comp in c=n[a].annotation[l+"_string"]||n[a].annotation[l],ngl_stage.compList)if(ngl_stage.compList[comp].name==n[a].struc_id){ngl_stage.compList[comp].structure.eachResidue(function(t){t.chainname==n[a].chain&&(t.sstruc=c?c[t.resno-1].toLowerCase():"")});break}for(comp in s=n[a].struc_id,ngl_stage.compList)ngl_stage.compList[comp].name==s&&ngl_stage.compList[comp].addRepresentation("cartoon",{name:s,sele:"not :_ and not nucleic and not :-",smoothSheet:!0,aspectRatio:6,roughness:1})}return changeRep(A.cookie("defaultRepr")),u(),t},targetMismatch:function(e){return e.match?jQuery.cookie("targetMismatch",e.match,{expires:365,path:"/"}):jQuery.removeCookie("targetMismatch",{path:"/"}),this.each(function(){var t;A(this).find("span.targetMismatch").removeClass("targetMismatch"),"fade"==e.match?(A("#enhanceMismatch_cb").prop("checked",!1),A(this).find("span[nm]").addClass("targetMismatch")):"enhance"==e.match&&(A("#fadeMismatch_cb").prop("checked",!1),(t=A(this).find("span")).not("[nm]").addClass("targetMismatch"),t.not("[s]").addClass("targetMismatch"))})},viewerInitialised:function(t){let e=null;e=chainMapping.defaultColourScheme||(A(this).data("features")?"features":A.cookie("colourScheme")),-1<["qmean_local","confClass","bfactor","bfactor_range","secstruc"].indexOf(e)?A(".alignTbl:first").alignment("colourAllAlignments",{col:e}):u(t),0<A("#pv:visible",currentWin.document).length&&pv_viewer.fitParent()},updateColoursSingleResidue:function(t){u({singleResidue:t})},resizeToParent:function(t,s){return s=!t||t.redrawAnnotation,this.each(function(){var t,e,n,i,a=A(this);a.is(":visible")&&a.data("templateData")&&((t=(n=A(this).find("tr:visible td").first()).find("span").first()[0])&&(i=a.width()-n.width(),e=(e=a.parent().closest("table").parent()).width()-(a.offset().left-e.offset().left)-i,a.data("templateData").nowrap&&(e=1e7),i=n.text().length,t=Math.floor(e/t.getBoundingClientRect().width),a.data("options").textOnly&&(t=Math.floor(e/(n.width()/n.text().length))),(t-=t%5)<1&&(t=5),e=0<a.find("tr:hidden").length,n=a.data("templateData").chaingroups,t!=i?(a.attr("cols_cookie")&&A.cookie(a.attr("cols_cookie"),t,{expires:365,path:"/"}),D(a,null,{cols:t}),s&&j(a),e&&r.toggleIdenticalSeqs.call(a,{chaingroups:n})):(s&&j(a),A("#"+(i=a).attr("id")+"_features").css("top",i.position().top))))})},toggleEditMode:function(t){A(this).attr("id").substring("8");(M=t&&null!=t.edit?t.edit:!M)?(A("a[id^=gapEdit_]").css("opacity",1),A(".hoverResidue").removeClass("hoverResidue"),null==P&&(P={seqno:1,seqidx:0}),A(this).find("tr[seqno="+P.seqno+"]").find("span").eq(P.seqidx).addClass("cursor")):(A("a[id^=gapEdit_]").css("opacity",.6),A(".cursor").removeClass("cursor"))},removeGappedColumns:function(t){var e=A(this).data("templateData").templates,n=function(t,e){for(var n="",i="",a=0;a<t.length;a++)"-"==t.charAt(a)&&"-"==e.charAt(a)||(n+=t.charAt(a),i+=e.charAt(a));return[n,i]}(e[0].trg_seq,e[0].tpl_seq);e[0].trg_seq=n[0],e[0].tpl_seq=n[1],D(A(this))}};function L(t){return A("#alignNameTbl"+t.attr("id").substring(8))}function n(s){var r;A(document).mouseup(function(){var t,e,n;A.data(s,"downchain")&&(t=A("#offscreen_selection span"),window.getSelection&&0<t.length?(e=window.getSelection(),(n=document.createRange()).setStart(t.get(0),0),n.setEndAfter(t.get(-1),0),e.addRange(n)):document.selection&&(document.body.createTextRange(),document.selection.empty()),A.data(s,"downchain",null)),s.data("mouseDragEdit",null)}),A(document).mousemove(function(){A.data(s,"downchain")&&(window.getSelection?(windowSelection=window.getSelection()).removeAllRanges():document.selection&&document.selection.empty())}),s.off(),(null==s.data("options")||"textOnly"in s.data("options")&&!s.data("options").textOnly)&&(r=null),s.data("templateData")&&s.data("templateData").charts?s.on("mouseover mousedown mouseup mousemove dblclick","td",function(t){var e,n,i,a=A(this).find("span");0!=a.length&&(e=a[0].getBoundingClientRect().width,i=A(this),t.pageX||t.pageY?n=t.pageX-i.offset().left:(t.clientX||t.clientY)&&(n=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-i.offset().left),$span=A(a[Math.floor(n/e)]),r!=$span.text()?(r=$span.text(),o(s,$span,"mouseover",t)):(r=$span.text(),o(s,$span,t.type,t)))}):s.on("mouseover mousedown mouseup mousemove dblclick","span",function(t){o(s,A(this),t.type,t)})}function o(t,n,e,i){var a=n.text();if(M&&function(t,e){if(e.stopPropagation(),e.preventDefault(),!v){var n,i=t.closest(".alignTbl"),a=t.closest("tr"),s=t.closest("tr").attr("seqno"),r=a.attr("chain");r||(r=a.attr("keyseqtype"),a.attr("keyseqchain")),i.data("templateData");if("mouseover"!=e.type)if("dblclick"==e.type)!t.hasClass("shadowCursor")||i.data("mouseDragEdit")||("-"==t.text()?w:y)();else if("mousedown"==e.type){if(!t.hasClass("shadowCursor")){var o=A(".shadowCursor").first();if(e.shiftKey&&o){if(o.closest("tr").attr("seqno")!=s)return;A(".shadowCursor").removeClass("shadowCursor");var l,h=(l=i.find("tr[seqno="+s+"]").find("span")).index(o),r=l.index(t);h<r?(i.data("startEditRegion",o),i.data("endEditRegion",t)):(a=h,h=r,r=a,i.data("startEditRegion",t),i.data("endEditRegion",o)),l.slice(h,r).each(function(){A(this).addClass("shadowCursor")}),i.data("mouseDragEdit",!1)}else A(".shadowCursor").removeClass("shadowCursor"),t.addClass("shadowCursor"),i.data("mouseDragEdit",!0),i.data("startEditRegion",t),i.data("endEditRegion",t)}A(".cursor").removeClass("cursor"),t.addClass("cursor")}else"mousemove"==e.type?((a=window.getSelection?window.getSelection():document.selection)&&(a.removeAllRanges?a.removeAllRanges():a.empty&&a.empty()),i.data("mouseDragEdit")&&0!=(n=i.data("startEditRegion")).length&&(r=0,r=e.pageX>n.offset().left?(e.pageX-n.offset().left)/n.outerWidth()|0:(e.pageX-n.offset().left-n.outerWidth())/n.outerWidth()|0,A(".shadowCursor").removeClass("shadowCursor"),0<r?n.nextAll(":lt("+r+")").addClass("shadowCursor"):r<0&&n.prevAll().slice(0,Math.abs(r)).each(function(){A(this).addClass("shadowCursor")}),n.addClass("shadowCursor"))):"mouseup"==e.type&&(n=i.data("startEditRegion"))&&(h=(l=i.find("tr[seqno="+s+"]").find("span")).index(o),P={seqno:s,seqidx:l.index(t)},i.data("startEditRegion",A("span.shadowCursor").first()),i.data("endEditRegion",A("span.shadowCursor").last()),i.data("mouseDragEdit",!1))}}(n,i),a!=C.gapChar){var s=n.attr("s");if(s){var r,o,l,h,c,u,d,p,i=n.closest("tr"),g=i.attr("chain"),f=i.attr("keyseqchain"),g=g||(i.attr("keyseqchain")?i.attr("keyseqchain"):null),m=i.attr("struc_id"),i=(!m&&i.attr("tpl_id")&&(m=i.attr("tpl_id")),t.data("templateData"));if("mouseover"==e){if(null!=W[a.toUpperCase()]){let e=W[a.toUpperCase()].triplet+" "+s+(g?" "+g:"");if(chainMapping.structures[m])for(let t=0;t<chainMapping.annotations.length;t++)chainMapping.annotations[t].active&&null!=chainMapping.structures[m][g][s][chainMapping.annotations[t].key]&&(r=chainMapping.structures[m][g][s][chainMapping.annotations[t].key],e+="; "+chainMapping.annotations[t].label+": "+("number"==typeof r?r.toFixed("ramachandran"==chainMapping.annotations[t].key?4:2):r));n.attr("title",e)}g&&A("body").trigger("highlightResidue",{src:"alignment",struc_id:m,chain:g,resno:parseInt(s)})}M||i&&(a=!("target-template"==i.type&&"target-template"==g),"mousedown"==e?(A.data(t,"downspan",n),A.data(t,"downchain",g+f+m),A(".hoverResidue").removeClass("hoverResidue"),A(".selectResidue").removeClass("selectResidue")):"mousemove"!=e&&"mouseup"!=e||(A.data(t,"downchain")&&(window.getSelection?((d=window.getSelection()).removeAllRanges(),p=document.createRange()):document.selection&&document.selection.empty()),g&&A.data(t,"downchain")==g+f+m?"mousemove"==e&&null!=A.data(t,"lastMouseDrag")&&A.data(t,"lastMouseDrag")==g+f+m+n.index()||(A.data(t,"lastMouseDrag",g+f+m+n.index()),i=t.find("tr["+(f?'keyseqchain="'+f+'"':m?'struc_id="'+m+'"':'chain="'+g+'"')+"]"),h=A.data(t,"downspan"),l=n,c=i.index(h.closest("tr")),u=i.index(l.closest("tr")),"mouseup"==e&&h.index()==l.index()&&c==u?(n.addClass("selectResidue"),a&&A("body").trigger("centerResRange",{src:"alignment",struc_id:m,chain:f||g,min:s,max:s})):((u<c||c==u&&h.index()>l.index())&&(o=c,l=h,h=n,c=u,u=o),h.index()==l.index()&&c==u||(A(".selectResidue").removeClass("selectResidue"),h.addClass("selectResidue"),l.addClass("selectResidue"),i.each(function(t){t<c||u<t||(t==c?h.nextUntil(l):t==u?l.prevUntil(l):A(this).find("span")).addClass("selectResidue")})),a&&"mouseup"==e&&A("body").trigger("centerResRange",{src:"alignment",struc_id:m,chain:f||g,min:parseInt(h.attr("s")),max:parseInt(l.attr("s"))})),0<(n=t.find(".selectResidue")).length&&(A("#offscreen_selection").html(""),n.clone().appendTo(A("#offscreen_selection")),window.getSelection?(d=window.getSelection(),(p=document.createRange()).setStart(A("#offscreen_selection span").get(0),0),p.setEndAfter(A("#offscreen_selection span").get(-1),0),d.addRange(p)):document.selection&&(document.body.createTextRange(),document.selection.empty()))):A.data(t,"downchain")))}}}function I(t,e){var n;if(!(null==e||e.length<1))return(n=null==(n=A("body").data("editHistory"))?[]:n).push(e),A("body").data("editHistory",n),0<(n=A(".alignTbl").not(t)).length&&(i(n,e,!1),A(".cursor").removeClass("cursor")),1}function i(t,r,o,l){t.each(function(){if(null!=A(this).data("templateData")){for(var t=A(this).data("templateData").templates,e=r,n=0;n<e.length;n++)for(var i=e[n],a=0;a<i.length;a++)for(var s=0;s<t.length;s++)if(t[s].id==i[a].template.id){o?(t[s].trg_seq=i[a].trg_seq,t[s].tpl_seq=i[a].tpl_seq):(t[s].trg_seq=i[a].template.trg_seq,t[s].tpl_seq=i[a].template.tpl_seq),l&&(P=i[a].currentCursor,n==e.length-1&&q(t[s]));break}A(this).is(":visible")&&D(A(this),null,{firstDraw:!1})}})}function q(t){if(!(A("#seqid_"+t.id).length<1)){for(var e=0,n=0,i=0;i<t.trg_seq.length;i++)"-"==t.trg_seq.charAt(i)||"-"==t.tpl_seq.charAt(i)?e++:t.trg_seq.charAt(i)==t.tpl_seq.charAt(i)&&n++;A("#seqid_"+t.id).text((n/(t.trg_seq.length-e)*100).toFixed(2))}}function T(t,e){var n,i,a,s,r,o,l,h,c;null==t&&(38==e.keyCode?t="up":40==e.keyCode?t="down":37==e.keyCode?t="left":39==e.keyCode&&(t="right")),null!=t&&(e&&e.preventDefault(),(n=(e=A("span.cursor").first()).closest("tr")).closest(".alignTbl"),i=n.attr("seqno"),o=a=e.index(),0<(s=n.prevAll("[seqno="+i+"]")).length&&(o+=(r=s.find("span")).length),l=i,o=o,"up"==t&&0<n.index()?(l=(c=n.prev()).attr("seqno"),h=c.find("span:eq("+a+")")):"down"==t&&0<n.next().length?(l=(c=n.next()).attr("seqno"),h=c.find("span:eq(rowidx)"),h=(h=n.next().find("span")).length>a?h.eq(a):h.last()):"left"==t?0==e.prev().length?0<s.length&&(h=r.last(),o--):(h=e.prev(),o--):"right"==t&&(0<e.next().length?(h=e.next(),o++):0<(c=n.nextAll("[seqno="+i+"]:eq(0)")).length&&(h=c.find("span").first(),o++)),null!=h&&(e.removeClass("cursor"),h.addClass("cursor"),P={seqno:l,seqidx:o}))}function y(){var t=[],e=A("span.cursor").first(),n=e.closest("tr"),i=n.attr("seqno"),a=n.closest(".alignTbl");if(!e.hasClass("shadowCursor")){if(0!=a.find("span.shadowCursor").length)return;e.addClass("shadowCursor")}if(null!=a.data("templateData")){for(var s,r,o=a.find("span.shadowCursor").last(),l=o.index(),h=o[0]==e[0],c=a.find("tr"),u=o.closest("tr"),d=A(),p=0,g=(c.filter("[seqno="+i+"]").each(function(){p++;var t=A(this).find("span");if(A(this)[0]==u[0])return d=d.add(t.slice(0,l+1)),!1;d=d.add(t)}),d.index(e)),f=d.text(),m=a.data("templateData").templates,v=null!=n.attr("keyseqchain"),b=v?null:c.filter("[seqno=1]").slice(0,p),o=e.nextAll(".shadowCursor").addBack(),y=0;y<m.length;y++)if(!(null==m[y].selected||m[y].selected<1)){if(v)s=m[y].trg_seq,r=m[y].tpl_seq,b=c.filter("[seqno="+(m[y].selected+1)+"]").slice(0,p);else{if(m[y].selected!=i-1)continue;s=m[y].tpl_seq,r=m[y].trg_seq}b.find("span").slice(0,f.length).text();for(var w="",_=!1,x=!1,C=0;C<f.length;C++)if(C<g)w+=s.charAt(w.length);else if(_){if("-"==f.charAt(C)){w+=s.charAt(w.length-1),x=!0;break}w+=s.charAt(w.length-1)}else w+="-",_=!0;x?s=w+s.substring(w.length):_&&(s=w+s.substring(w.length-1),h||(r=r.substring(0,w.length-1)+"-"+r.substring(w.length-1))),s.length>r.length?r+=Array(s.length-r.length+1).join("-"):r.length>s.length&&(s+=Array(r.length-s.length+1).join("-"));var M={template:m[y],trg_seq:m[y].trg_seq,tpl_seq:m[y].tpl_seq,currentCursor:{seqno:P.seqno,seqidx:P.seqidx}};v?(m[y].trg_seq=s,m[y].tpl_seq=r):(m[y].trg_seq=r,m[y].tpl_seq=s),q(m[y]),t[t.length]=M}1==o.length&&A(".shadowCursor").removeClass("shadowCursor"),0<t.length?(T("right"),a.data("templateData"),h&&(a.data("startEditRegion",null),a.data("endEditRegion",null)),I(a,[t])&&D(a,null,{firstDraw:!1})):V(e,'<strong style="color:red">The pairwise alignment already contains a gap at this position</strong>')}}function V(t,e){v=!0,t.removeAttr("title").popover({html:!0,content:e,placement:"top"}).popover("show"),setTimeout(function(){t.popover("destroy"),v=!1},2e3)}function w(t){var e=[],n=A("span.cursor").first(),i=n.closest("tr"),a=i.attr("seqno"),s=i.closest(".alignTbl"),r=s.find("span.shadowCursor").length<2;if(t){if("-"!=n.prev().text())return;r&&n.removeClass("shadowCursor"),(n=n.prev()).addClass("shadowCursor")}else if("-"!=n.text())return;if(null!=s.data("templateData")){if(!n.hasClass("shadowCursor")){if(0!=s.find("span.shadowCursor").length)return;n.addClass("shadowCursor")}for(var o,l,h=s.find("span.shadowCursor").last(),c=h.index(),u=s.find("tr"),d=h.closest("tr"),p=A(),g=0,f=(u.filter("[seqno="+a+"]").each(function(){g++;var t=A(this).find("span");if(A(this)[0]==d[0])return p=p.add(t.slice(0,c+1)),!1;p=p.add(t)}),p.index(n)),m=p.text(),v=s.data("templateData").templates,b=null!=i.attr("keyseqchain"),y="",w=b?null:u.filter("[seqno=1]").slice(0,g),_=(n.nextAll(".shadowCursor").addBack(),0);_<v.length;_++)if(!(null==v[_].selected||v[_].selected<1)){if(b)o=v[_].trg_seq,l=v[_].tpl_seq,w=u.filter("[seqno="+(v[_].selected+1)+"]").slice(0,g);else{if(v[_].selected!=a-1)continue;o=v[_].tpl_seq,l=v[_].trg_seq}for(var y=w.find("span").slice(0,m.length).text(),x="",C=!1,M=0;M<m.length;M++)if(M!=f)if(M<f)x+=o.charAt(x.length);else if("-"==m.charAt(M)){if("-"!=y.charAt(M)){if(C)break;x+="-",0}}else C=!0,x+=o.charAt(x.length+1);(o=r?x+o.substring(x.length+1):x+"-"+o.substring(x.length+1)).length>l.length?l+=Array(o.length-l.length+1).join("-"):l.length>o.length&&(o+=Array(l.length-o.length+1).join("-"));var k={template:v[_],trg_seq:v[_].trg_seq,tpl_seq:v[_].tpl_seq,currentCursor:{seqno:P.seqno,seqidx:P.seqidx}};b?(v[_].trg_seq=o,v[_].tpl_seq=l):(v[_].trg_seq=l,v[_].tpl_seq=o),q(v[_]),e[e.length]=k}0<e.length?(t&&T("left"),r&&(s.data("startEditRegion",null),s.data("endEditRegion",null)),I(s,[e])&&D(s,null,{firstDraw:!1})):V(n,'<strong style="color:red">No valid gaps to be deleted in the selected range</strong>')}}function N(t,e){var n;if(!(n=t.templates?function(t,n){var i=0,a=[],s=[],r=[],e="";if(A.each(t.templates,function(t,e){!e||n&&!e.selected||e.trg_seq&&(s[s.length]=e,a[a.length]="",r[r.length]=(a.length,0),i=Math.max(e.trg_seq.length,i))}),s.sort(function(t,e){return t.selected<e.selected?-1:t.selected>e.selected?1:0}),0!=s.length){for(var o=null,l=(t.keyseq_sequence?o=t.keyseq_sequence:(o=s[0].trg_seq,t.templates[0].up_res_num||(o=o.replace(/-/g,""))),0);l<i;){for(var h=0,c=0,u=0;u<s.length;u++){for(c=0;s[u].trg_seq.charAt(r[u]+c)==C.gapChar;)c++;h=Math.max(c,h)}for(c=0;c<h;)e+=C.gapChar,c++;e+=o.charAt(l++);for(u=0;u<s.length;u++)if(s[u].tpl_seq){for(c=0;s[u].trg_seq.charAt(r[u])==C.gapChar;)a[u]+=s[u].tpl_seq.charAt(r[u]++),c++;for(;c<h;)a[u]+=C.gapChar,c++;a[u]+=s[u].tpl_seq.charAt(r[u]++)}}return a.target=e,q((a.templates=s)[0]),a}}(t,!0):n))if((n=[]).templates=["empty"],t.keyseq_sequence)n.target=t.keyseq_sequence;else{for(var i=0;i<t.templates.length;i++)if(t.templates[i].trg_seq){n.target=t.templates[i].trg_seq.replace(/-/g,"");break}var a=t.templates[i].trg_seq.length-n.target.length;1==t.templates.length&&0<a&&A("#alignmentWarning_"+e.attr("id").substring(8)).html('<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert">&times;</button><strong>Note: </strong> '+a+" gaps were removed from your target sequence</div>")}return n}var $={};function D(t,r,o){$alignNameTbl=L(t),t.removeData("clustalColours");let l=t.data().templateData;if(l=l||A("#alignTbl").data().templateData){r=r||N(l,t);for(var e=0,n=0;n<r.length;n++){var i=r[n].match(/[a-zA-Z]/g);i&&(e+=i.length)}for(var h,c={cols:60,fastDraw:!1,textOnly:2e4<e,showResiduePosition:!0},c=(0==(o=t.data("options")?A.extend(t.data("options"),o):(!(o=o||{}).cols&&t.attr("cols_cookie")&&A.cookie(t.attr("cols_cookie"))&&(o.cols=A.cookie(t.attr("cols_cookie"))),A.extend(c,o))).cols&&(o.cols=50),o.cols=parseInt(o.cols),t.attr("id").substring(8)),u=o.fastDraw,d=(o.textOnly?(A("#alignTbl"+c+"_features").remove(),t.off()):u&&(A("#alignTbl"+c+"_features").html(""),(h=$["timer"+c])&&clearTimeout(h),o.fastDraw=!1,h=setTimeout(function(){D(t,r)},10),$["timer"+c]=h),t.data("options",o),document.getElementById(t.attr("id")));d.hasChildNodes();)d.removeChild(d.lastChild);for(d=document.getElementById($alignNameTbl.attr("id"));d&&d.hasChildNodes();)d.removeChild(d.lastChild);var p,g="SEQRES"==(p=(p=l.target_name||("model-template"==l.type?l.struc_id:l.type.split("-")[0])).charAt(0).toUpperCase()+p.substring(1)).toUpperCase(),f=(void 0!==l.templates&&l.templates[0].modelAtomSeqs?l.templates[0].modelAtomSeqs[0].seq:r.target).length;let a="",s="";if(l.nowrap){a='<tr><td style="padding-top:0px;">',s='<tr><td style="padding-top:0px;border-right:none">&nbsp;</td></tr>';for(let t=r.templates[0].trg_offset;t<f+r.templates[0].trg_offset;t++)0<t&&(0<t&&t%10==0?a=(a+='<span style="position:relative;color:#A2A2A2;">&nbsp;<span style="position:absolute;left:0px;top:8px;font-size:.7em;">|</span>')+'<span style="position:absolute;left:0px;top:0px;font-size:.8em;">'+t+"</span></span>":a+="<span>&nbsp;</span>")}a+="</td></tr>";var m={},v={};for(let i=0;i<f;i+=o.cols){let n=1;for(var b=0;b<l.keyseq_chain_name.length;b++){var y=[];let t;t=void 0!==l.templates&&l.templates[0].modelAtomSeqs?l.templates[0].modelAtomSeqs[b].seq:r.target;var w=l.keyseq_chain_name[b];s+='<tr seqno="'+n+'" '+G(l.keyseq_description)+"><td"+(0<i&&0==b||l.charts?' style="position:relative; padding-top:'+(S+B+10)+'px"':"")+">"+(0<S?'<div style="position:absolute; right:4px; top:'+(S+B)/2+'px ">QMEAN</div>':"")+p+(1<l.keyseq_chain_name.length?":"+w:"")+"</td></tr>";let e=r.templates[0].trg_offset||1;void 0!==l.templates&&l.templates[0].modelAtomSeqs&&(e=l.templates[0].modelAtomSeqs[b].trg_offset),a+=`<tr seqno="${n}" keyseqtype="${l.type}"`,!l.struc_id||o.textOnly&&o.fastDraw||(a+=` struc_id="${l.struc_id}" keyseqchain="${w}"`),a+="><td"+(0<i&&0==b||l.charts?' style="padding-top:'+(S+B+10)+'px"':"")+">",o.fastDraw?a+=z(t.substring(i,i+o.cols)):o.textOnly?a+="<span>"+t.substring(i,i+o.cols)+"</span>":(a+=Q(t.substring(i,i+o.cols),{alIndex:i,pos:O(t.substring(0,i)),offset:e,annotation:l.keyseq_annotation?l.keyseq_annotation[w]:null,seqres:g,up_res_num:l.templates&&l.templates[b]&&l.templates[b].up_res_num?l.templates[b].up_res_num:null,resmap:y,keyseq:!0}),m[w]||(m[w]=[]),m[w]=m[w].concat(y)),a+="</td></tr>",n+=1}for(let t=0;t<r.length;t++){var _,x="model-template"!=l.type&&r.templates[t].struc_id?[]:null,C=l.templates[0].modelAtomSeqs?l.templates[0].modelAtomSeqs[t].seq:r.target;r.templates[t].tpl_seq?(s+='<tr seqno="'+n+'" '+(null!=r.templates[t].id?'tpl_id="'+r.templates[t].id+'"':"")+' chain="'+r.templates[t].chain+'"'+G(r.templates[t].description)+'><td nowrap align="left" >'+r.templates[t].qname+"</td></tr>",_=r.templates[t].offset?r.templates[t].offset+1:1,a+=`<tr seqno="${n}" `+(null!=r.templates[t].id?'tpl_id="'+r.templates[t].id+'"':"")+(o.textOnly&&o.fastDraw||"model-template"==l.type||!r.templates[t].struc_id?"":' struc_id="'+r.templates[t].struc_id+'"')+' qname="'+r.templates[t].qname+'" chain="'+r.templates[t].chain+'"><td nowrap align="left">',o.fastDraw?a+=z(r[t].substring(i,i+o.cols)):o.textOnly?a+="<span>"+r[t].substring(i,i+o.cols)+"</span>":(a+=Q(r[t].substring(i,i+o.cols),{alIndex:i,pos:O(r[t].substring(0,i)),offset:_,seqres:g,annotation:r.templates[t].annotation,targetSeq:C.substring(i,i+o.cols),pdb_res_num:l.templates[t].pdb_res_num?l.templates[t].pdb_res_num.slice(i,i+o.cols):null,resmap:x,keyseq:!1}),x&&(v[r.templates[t].struc_id]||(v[r.templates[t].struc_id]={}),v[r.templates[t].struc_id][r.templates[t].chain]||(v[r.templates[t].struc_id][r.templates[t].chain]=[]),v[r.templates[t].struc_id][r.templates[t].chain]=v[r.templates[t].struc_id][r.templates[t].chain].concat(x))),a+="</td></tr>",n+=1):n+=1}}if(-1==chainMapping.alignments.indexOf(t.attr("id"))){if(l.modelLabel)if("model-template"==l.type)for(kchn in m)chainMapping.chainMeta[l.struc_id]||(chainMapping.chainMeta[l.struc_id]={}),chainMapping.chainMeta[l.struc_id][kchn]||(chainMapping.chainMeta[l.struc_id][kchn]={display:l.modelLabel});else for(let t=0;t<l.templates.length;t++)chainMapping.chainMeta[l.templates[t].struc_id]||(chainMapping.chainMeta[l.templates[t].struc_id]={}),chainMapping.chainMeta[l.templates[t].struc_id][l.templates[t].chain]||(chainMapping.chainMeta[l.templates[t].struc_id][l.templates[t].chain]={display:l.modelLabel});for(kchn in chainMapping.alignments.push(t.attr("id")),m)if("model-template"==l.type){l.md5&&(chainMapping.targets[l.md5]||(chainMapping.targets[l.md5]={}),chainMapping.targets[l.md5][l.struc_id]||(chainMapping.targets[l.md5][l.struc_id]=[])),chainMapping.structures[l.struc_id]||(chainMapping.structures[l.struc_id]={}),chainMapping.structures[l.struc_id][kchn]||(chainMapping.structures[l.struc_id][kchn]=[]);for(let n=0;n<m[kchn].length;n++)if(m[kchn][n]){let t=!1,e=null;e=chainMapping.structures[l.struc_id][kchn][m[kchn][n][1]]?(t=!0,chainMapping.structures[l.struc_id][kchn][m[kchn][n][1]]):{trgno:m[kchn][n][1],trgname:m[kchn][n][0],chn:kchn,resno:m[kchn][n][1],resname:m[kchn][n][0]},3==m[kchn][n].length&&("qmean"in m[kchn][n][2].anno&&(e.qm=m[kchn][n][2].anno.qmean),"qmeanbrane"in m[kchn][n][2].anno&&(e.qmb=m[kchn][n][2].anno.qmeanbrane),"consistency"in m[kchn][n][2].anno&&(e.c=m[kchn][n][2].anno.consistency)),t||(l.md5&&(chainMapping.targets[l.md5][l.struc_id][m[kchn][n][1]]||(chainMapping.targets[l.md5][l.struc_id][m[kchn][n][1]]=[]),chainMapping.targets[l.md5][l.struc_id][m[kchn][n][1]].push(e)),chainMapping.structures[l.struc_id][kchn][m[kchn][n][1]]=e)}}else for(let n=0;n<m[kchn].length;n++)for(var M in v)for(var k in chainMapping.targets[l.md5]||(chainMapping.targets[l.md5]={}),chainMapping.targets[l.md5][M]||(chainMapping.targets[l.md5][M]=[]),chainMapping.structures[M]||(chainMapping.structures[M]={}),v[M])if(chainMapping.structures[M][k]||(chainMapping.structures[M][k]=[]),v[M][k][n]){let t=!1,e=null;chainMapping.structures[M][k][v[M][k][n][1]]?(t=!0,e=chainMapping.structures[M][k][v[M][k][n][1]]):(e={chn:k,resno:v[M][k][n][1],resname:v[M][k][n][0]},m[kchn][n]&&(e.trgno=m[kchn][n][1],e.trgname=m[kchn][n][0])),3==v[M][k][n].length&&("qmean"in v[M][k][n][2].anno&&(e.qm=v[M][k][n][2].anno.qmean),"qmeanbrane"in v[M][k][n][2].anno&&(e.qmb=v[M][k][n][2].anno.qmean),"consistency"in v[M][k][n][2].anno&&(e.c=v[M][k][n][2].anno.consistency)),t||(m[kchn][n]&&(chainMapping.targets[l.md5][M][m[kchn][n][1]]||(chainMapping.targets[l.md5][M][m[kchn][n][1]]=[]),chainMapping.targets[l.md5][M][m[kchn][n][1]].push(e)),chainMapping.structures[M][k][v[M][k][n][1]]=e)}}var P,c=A.cookie("secStruct");c&&"none"==c||t.addClass("ss"),$alignNameTbl.last().append(s),t.last().append(a),!l.nowrap&&o.showResiduePosition&&t.find("tr").each(function(t,e){P=0<t&&1==e.getAttribute("seqno")?"padding-top:"+(S+B+10)+"px;":"";t=A(this).find("span[s]").last().attr("s");t&&A(this).append('<td style="padding-left:8px; font-size:.8em; text-align:right; '+P+'">'+t+"</td>")}),u||(chainMapping.defaultColourScheme?(A("#"+chainMapping.defaultColourScheme+"Button").prop("checked",!0),H(chainMapping.defaultColourScheme,t)):H(A.cookie("colourScheme"),t),r=null,o.firstDraw||j(t))}}function O(t){t=t.match(/[^-]/g);return t?t.length:0}function G(t){return t?' title="'+t+'" ':""}function z(t){for(var e="",n=0;n<t.length;n++)e+="<span>"+t.charAt(n)+"</span>";return e}function Q(i,a){if(!i)return"";let s=a.pos;var r=a.alIndex,o=a.seqres,l=null!=a.targetSeq,h=[];let c=null;for(let n=0;n<i.length;n++){var u=i.charAt(n);let t=null,e=null;var d,p,g;if(u==C.gapChar)h.push('<span nm="true">-</span>'),a.resmap&&a.resmap.push(null);else if(a.pdb_res_num?(e=a.pdb_res_num[n]-a.offset,d=a.pdb_res_num[n-1],g=a.pdb_res_num[n],p=a.pdb_res_num[n+1],t=a.pdb_res_num[n],d&&d!=g-1&&d!=g?(0<n&&"-"==i.charAt(n-1)&&(h[n-1]=h[n-1].substring(0,h[n-1].length-9)+' class="insert_r">-</span>'),h.push(`<span s="${t}" r="${u.toUpperCase()}"`+(l&&a.targetSeq.charAt(n)!=u?' nm="true"':"")+' class="insert_l">'+u+"</span>")):p&&g!=p-1&&p!=g?(h.push(`<span s="${t}" r="${u.toUpperCase()}"`+(l&&a.targetSeq.charAt(n)!=u?' nm="true"':"")+' class="insert_r">'+u+"</span>"),n<i.length-2&&"-"==i.charAt(n+1)&&(h.push('<span nm="true" class="insert_l">-</span>'),n++)):h.push(`<span s="${t}" r="${u.toUpperCase()}"`+(l&&a.targetSeq.charAt(n)!=u?' nm="true"':"")+">"+u+"</span>")):a.up_res_num?(e=r+n,d=a.up_res_num[r+n-1],p=a.up_res_num[r+n],g=a.up_res_num[r+n+1],null==p&&(p=c+=1),null==g&&(d=p-1,g=p+1),t=p,h.push("<span "+(0<r+n&&d!=p-1?'class="insert_l"':"")+(r+n<r+i.length-1&&p!=g-1?'class="insert_r"':"")+` s="${p}" r="${u.toUpperCase()}"`+(l&&a.targetSeq.charAt(n)!=u?' nm="true"':"")+">"+u+"</span>"),c=p):o?(e=r+n,t=r+n+a.offset,h.push(`<span s="${t}" r="${u.toUpperCase()}"`+(l&&a.targetSeq.charAt(n)!=u?' nm="true"':"")+">"+u+"</span>")):(e=s,t=s+a.offset,h.push(`<span s="${t}" r="${u.toUpperCase()}"`+(l&&a.targetSeq.charAt(n)!=u?' nm="true"':"")+">"+u+"</span>"),s++),a.resmap){var f=[u.toUpperCase(),t];if(a.annotation)for(var m in f.push({anno:{}}),a.annotation)a.annotation[m]&&a.annotation[m][e]&&(f[f.length-1].anno[m]=a.annotation[m][e]),a.keyseq&&"qmean"==m&&null==a.annotation.qmean[e]&&(h[h.length-1]='<span nores="true" '+h[h.length-1].substring(6));a.resmap.push(f)}}return h.join("")}function F(t,e,n){t[n][e]?t[n][e]++:t[n][e]=1}var Y=[238,51,17],K=[17,119,238],Z=[17,204,17],J=[255,102,0],tt=[17,187,187],et=[238,119,119],nt=[204,68,204],it=[204,204,0],W={A:{name:"Alanine",triplet:"ALA",hydrophobic:.7,size:.11},C:{name:"Cysteine",triplet:"CYS",hydrophobic:.78,size:.35},D:{name:"Aspartate",triplet:"ASP",hydrophobic:.11,size:.45},E:{name:"Glutamate",triplet:"GLU",hydrophobic:.11,size:.56},F:{name:"Phenylalanine",triplet:"PHE",hydrophobic:.81,size:.7},G:{name:"Glycine",triplet:"GLY",hydrophobic:.46,size:0},H:{name:"Histidine",triplet:"HIS",hydrophobic:.14,size:.62},I:{name:"Isoleucine",triplet:"ILE",hydrophobic:1,size:.43},K:{name:"Lysine",triplet:"LYS",hydrophobic:.07,size:.55},L:{name:"Leucine",triplet:"LEU",hydrophobic:.92,size:.43},M:{name:"Methionine",triplet:"MET",hydrophobic:.71,size:.57},N:{name:"Asparagine",triplet:"ASN",hydrophobic:.11,size:.44},P:{name:"Proline",triplet:"PRO",hydrophobic:.32,size:.31},Q:{name:"Glutamine",triplet:"GLN",hydrophobic:.11,size:.55},R:{name:"Arginine",triplet:"ARG",hydrophobic:0,size:.77},S:{name:"Serine",triplet:"SER",hydrophobic:.41,size:.23},T:{name:"Threonine",triplet:"THR",hydrophobic:.42,size:.34},V:{name:"Valine",triplet:"VAL",hydrophobic:.97,size:.32},W:{name:"Tryptophan",triplet:"TRP",hydrophobic:.4,size:1},Y:{name:"Tyrosine",triplet:"TYR",hydrophobic:.36,size:.82},B:{name:"Aspartate or Asparagine",triplet:"ASX"},Z:{name:"Glutamate or Glutamine",triplet:"GLX"},J:{name:"Leucine or Isoleucine",triplet:"XLE"},X:{name:"Unknown",triplet:"UNC"},"?":{name:"Unknown",triplet:"UNC"},hydrophobic:"LIFWVM",polar:"RKDENQ",small:"TDN",large:"WYRFH",aliphatic:"ILV",charged:"HKRED",positive:"HKR",negative:"ED",tiny:"AGS",aromatic:"FYWH",proline:"P",serThr:"ST"};function H(h,c){var t,e,n,i=c.find("span");if(0!=i.length){if(A.each(i,function(t,e){e.style.backgroundColor&&(e.style.backgroundColor="")}),c.data("features")||c.removeData("features"),null==h&&(h="rainbow"),c.data("features"))for(let o in c.data("features")){let s=0,r=c.find("tr[struc_id]");r.filter("[struc_id="+o+"]").each(function(t,e){if(s>parseInt(e.getAttribute("seqno")))return!1;s=parseInt(e.getAttribute("seqno"));let i=e.getAttribute("chain");i=i||e.getAttribute("keyseqchain");e=r.filter("tr[seqno="+s+"]").find(" span[s]");for(let t=0;t<c.data("features")[o].length;t++){var n=c.data("features")[o][t],a=n.rgb.split(",").map(Number);if(n.frmChn!=n.toChn)console.error("THIS IS AN ERROR "+n);else if(-1!=n.frmChn.indexOf(i))for(let t=n.resStart;t<n.resEnd+1;t++)chainMapping.structures[o][i][t]&&(chainMapping.structures[o][i][t].rgb=a)}e.each(function(t,e){var n=parseInt(e.getAttribute("s"));chainMapping.structures[o][i][n]&&(e.style.backgroundColor="rgba("+chainMapping.structures[o][i][n].rgb+",.6)")})})}else if("chain"==h||"uniqueChain"==h||"template"==h){let o=null;if("undefined"!=typeof globalTemplateData){if(!(o=globalTemplateData).chainColoursAssigned){for(var a=0;a<globalTemplateData.length;a++)for(var s=globalTemplateData[a],r=(s.chainColours={chain:[],unique:[],template:R[a%R.length]},s.chain_name?"chain_name":"chain"),l=0;l<s[r].length;l++){s.chainColours.unique[1<s[r][l].length?s[r][l].join(""):s[r][l]]=R[E],E++,E%=12;for(var u=0;u<s[r][l].length;u++)s.chainColours.chain[s[r][l][u]]=R[k],k++,k%=R.length}globalTemplateData.chainColoursAssigned=!0}}else o=c.data("templateData").templates,A(".alignTbl").each(function(){var n=A(this).data("templateData");if(n&&n.templates&&!n.chainColoursAssigned){for(let e=0;e<n.templates.length;e++)if(n.templates[e].chainColours={chain:[],unique:[]},"model-template"==n.type)for(let t=0;t<n.keyseq_chain_name.length;t++)n.templates[e].chainColours.chain[n.keyseq_chain_name[t]]=R[k],n.templates[e].chainColours.unique[n.keyseq_chain_name[t]]=R[E],k++,k%=R.length;else n.templates[e].chainColours.chain[n.templates[e].chain]=R[k],n.templates[e].chainColours.unique[n.templates[e].chain]=R[E],k++,k%=R.length;E++,E%=R.length,n.chainColoursAssigned=!0}});o?A.each(c.find("tr[struc_id]"),function(t,e){let i=e.getAttribute("struc_id");var a=e.getAttribute("keyseqchain");if(!(a=a||e.getAttribute("chain")))return!1;var s,r=A(this).find("span[s]");for(let t=0;t<o.length;t++)if(o[t].struc_id==i){s=o[t];let n;if("chain"==h)n=s.chainColours.chain[a];else if("template"==h)n=s.chainColours.template;else for(chns in s.chainColours.unique)if(-1<chns.indexOf(a)){n=s.chainColours.unique[chns];break}n&&r.each(function(t,e){e.style.backgroundColor="rgb("+n+",.6)",i&&(e=parseInt(e.getAttribute("s")),chainMapping.structures[i]&&chainMapping.structures[i][a]&&chainMapping.structures[i][a][e]&&(chainMapping.structures[i][a][e].rgb=n))})}}):c.find("span").each(function(t,e){e.style.backgroundColor="rgba("+R[A(".alignTbl").index(c)%R.length]+",.6)"})}else if("rainbow"==h){let r=!1,o=0,l=c.find("tr");l.each(function(t,e){var n=e.getAttribute("struc_id");let i=e.getAttribute("chain");i=i||e.getAttribute("keyseqchain"),0==t&&(r="model-template"==e.getAttribute("keyseqtype"));t=parseInt(e.getAttribute("seqno"));if(t<=o)return!1;if(o=t,!r||null!=e.getAttribute("keyseqtype")){$span=l.filter("[seqno="+o+"]").find("span[s]:not([nores])");for(let t=0;t<$span.length;t++){var a,s=$span[t].getAttribute("s");null!=s&&(a=t/$span.length*(1.5*Math.PI-Math.PI/2)+Math.PI/2,a=[Math.round(127.5*(Math.sin(a+Math.PI)+1)),Math.round(255*Math.sin(a-Math.PI/2)),Math.round(127.5*(Math.sin(a)+1))],$span[t].style.backgroundColor="rgba("+a+",.6)",n&&chainMapping.structures[n]&&chainMapping.structures[n][i]&&(s=parseInt(s),chainMapping.structures[n][i][s]&&(chainMapping.structures[n][i][s].rgb=a)))}}})}else if("qmean_local"==h){let l="qm";"undefined"!=typeof qmeanbraneActive&&qmeanbraneActive&&(l="qmb"),c.find("tr[struc_id]").each(function(){let s=A(this).attr("struc_id"),r=A(this).attr("chain");r=r||A(this).attr("keyseqchain");var t=A(this).find("span[s]");let o=!0,e=!1;for(chn in chainMapping.structures[s]){for(res in chainMapping.structures[s][chn])if(chainMapping.structures[s][chn][res])if(chainMapping.structures[s][chn][res][l]){if(valExists=!0,1<chainMapping.structures[s][chn][res][l]){o=!1;break}}else chainMapping.structures[s][chn][res].bfactor&&(e=!0);if(!o)break}if(e)return U(c,"bfactor_range",A(this)),!0;A.each(t,function(t,e){var n=parseInt(e.getAttribute("s"));if(!chainMapping.structures[s][r][n])return!0;let i=chainMapping.structures[s][r][n][l];if(null==i)return!0;o||(i/=100);var a=qmeanLocalColour(i,.6),e=(e.style.backgroundColor=a).substring(5).split(",").slice(0,3).map(Number);chainMapping.structures[s][r][n].rgb=e})})}else if("confClass"==h)c.find("tr[struc_id]").each(function(){let a=A(this).attr("struc_id"),s=A(this).attr("chain");s=s||A(this).attr("keyseqchain");var t=A(this).find("span[s]");let r=!0;let e=!1;for(chn in chainMapping.structures[a]){for(res in chainMapping.structures[a][chn])if(chainMapping.structures[a][chn][res])if(chainMapping.structures[a][chn][res].qm){if(1<chainMapping.structures[a][chn][res].qm){r=!1;break}}else chainMapping.structures[a][chn][res].bfactor&&(e=!0);if(!r)break}if(e)return U(c,"bfactor_range",A(this)),!0;A.each(t,function(t,e){var n=parseInt(e.getAttribute("s"));if(!chainMapping.structures[a][s][n])return!0;let i=chainMapping.structures[a][s][n].qm;if(!i)return!0;r&&(i*=100),rgb=90<i?[0,83,214]:70<i?[101,203,243]:50<i?[255,219,19]:[255,125,69],e.style.backgroundColor="rgba("+rgb+",.6)",chainMapping.structures[a][s][n].rgb=rgb})});else if(-1<h.indexOf("consistency")){let o=0,l=1;"consistency"!=h&&(o=999,l=-99,c.find("tr[struc_id]").each(function(){var e=A(this).attr("struc_id");let n=A(this).attr("chain");if(!(n=n||A(this).attr("keyseqchain")))return!0;for(let t=0;t<chainMapping.structures[e][n].length;t++)chainMapping.structures[e][n][t]&&chainMapping.structures[e][n][t].c&&(o=Math.min(o,chainMapping.structures[e][n][t].c),l=Math.max(l,chainMapping.structures[e][n][t].c))})),c.find("tr[struc_id]").each(function(){var e=A(this).attr("struc_id");let n=A(this).attr("chain");if(!(n=n||A(this).attr("keyseqchain")))return!0;var i=A(this).find("span[s]").toArray();for(let t=0;t<i.length;t++){var a=[127,195,45],s=parseInt(i[t].getAttribute("s")),r=chainMapping.structures[e][n][s].c;r&&(l!=o&&((r=(parseFloat(r)-o)/(l-o))<.5?(a[0]=Math.round(255*(1-r)),a[1]=Math.round(160*r),a[2]=Math.round(90*r)):(a[0]=Math.round(127),a[1]=Math.round(20+175*r),a[2]=45)),i[t].style.backgroundColor="rgba("+a+",0.6)",e&&(chainMapping.structures[e][n][s].rgb=a))}})}else if("clustal"==h){let a=c.data("clustalColours");a||(t=N(c.data("templateData"),c),a=function(t){for(var e,n=[],i=0;i<t[0].length;i++){n[i]={};for(var a=0,s=0;s<t.length;s++)(e=t[s].charAt(i).toUpperCase())==C.gapChar?a++:(F(n,e,i),"Q"!=e&&"E"!=e||F(n,"QE",i),"E"==e||"D"==e?F(n,"ED",i):-1<"/[WLVIMAFCYHP]/".indexOf(e)?F(n,"WLVIMAFCYHP",i):"K"==e||"R"==e?F(n,"KR",i):"T"!=e&&"S"!=e||F(n,"TS",i));n[i].gapCount=a;var r,o={};for(r in n[i])o[r+"_nogap"]=(n[i][r]/t.length).toFixed(2),n[i][r]=(n[i][r]/(t.length-a)).toFixed(2);for(r in o)n[i][r]=o[r]}return n}(t.concat(t.target)),c.data("clustalColours",a));let s,e=0,r;c.find("tr").each(function(){if(parseInt(A(this).attr("seqno"))<e)return!1;let n=A(this).attr("struc_id"),i=A(this).attr("chain");i=i||A(this).attr("keyseqchain"),e=parseInt(A(this).attr("seqno"));var t=c.find("tr[seqno="+e+"] span");A.each(t,function(t,e){null!=a[t]&&e.hasAttribute("r")&&("P"==(s=e.getAttribute("r"))?r=it:"G"==s?r=J:"H"!=s&&"Y"!=s||!(.6<=a[t].WLVIMAFCYHP||.5<a[t].P)?"D"==s&&(.5<=a[t].N||.5<=a[t].ED&&.5<=!a[t].QE)||"E"==s&&(.5<=a[t].ED||.5<=a[t].QE)?r=nt:"C"==s&&.85<=a[t].C?r=et:"N"==s&&(.5<=a[t].N||.85<=a[t].D)||"Q"==s&&(.6<=a[t].KR||.5<=a[t].QE)||"S"==s&&(.5<=a[t].TS||.8<=a[t].WLVIMAFCYHP)||"T"==s&&(.5<=a[t].TS||.6<=a[t].WLVIMAFCYHP)?r=Z:"R"!=s&&"K"!=s||!(.6<=a[t].KR||.85<=a[t].Q)?(-1<"/[WLVIMAF]/".indexOf(s)&&(.5<=a[t].P||.6<=a[t].WLVIMAFCYHP)||("A"==s||"C"==s)&&(.5<=a[t].P||.6<=a[t].WLVIMAFCYHP||.85<=a[t].S))&&(r=K):r=Y:r=tt,r&&(e.style.backgroundColor="rgb("+r+",.5)",n&&chainMapping.structures[n]&&chainMapping.structures[n][i]&&(t=parseInt(e.getAttribute("s")),chainMapping.structures[n][i][t]&&(chainMapping.structures[n][i][t].rgb=r))))})})}else if("secstruc"==h){let e=A.cookie("secStruct");null==e&&(e="dssp");var o=c.data("templateData"),d=c.find("tr");let s,r;if(o.keyseq_annotation)for(let t=0;t<o.keyseq_chain_name.length;t++){r=o.struc_id;var p=o.keyseq_chain_name[t];if(o.keyseq_annotation[p]&&o.keyseq_annotation[p][e]){var g=X(o.keyseq_annotation[p],e).replace(/[GI]/g,"H").replace(/B/g,"E");for(let t=0;t<g.length;t++)chainMapping.structures[r][p][t+1]&&(chainMapping.structures[r][p][t+1].ss=g[t])}else if(chainMapping.structures[r])for(let t=0;t<chainMapping.structures[r][p].length;t++)chainMapping.structures[r][p][t]&&(chainMapping.structures[r][p][t].ss=null)}else if(o.templates)for(let t=0;t<o.templates.length;t++){var f=o.templates[t];if(f.annotation&&f.annotation[e]){var m=X(f.annotation,e).replace(/[GI]/g,"H").replace(/B/g,"E");if(chainMapping.structures[f.struc_id])for(let t=0;t<m.length;t++)chainMapping.structures[f.struc_id][f.chain]&&chainMapping.structures[f.struc_id][f.chain][t+1]&&(chainMapping.structures[f.struc_id][f.chain][t+1].ss=m[t]);else console.warn("no chain mapping found for "+f.struc_id+" "+f.chain)}else if(f.struc_id&&"none"!=e){let e=!1;for(let t=0;!e&&t<chainMapping.structures[f.struc_id][f.chain].length;t++)chainMapping.structures[f.struc_id][f.chain][t]&&chainMapping.structures[f.struc_id][f.chain][t].ss&&(e=!0);e||fetchSecStruc(f.struc_id)}}let n=0;for(let t=0;t<d.length;t++){var v=d.eq(t);if(parseInt(v.attr("seqno"))<n)break;n=parseInt(v.attr("seqno"));let i=v.attr("chain"),a=(i=i||v.attr("keyseqchain"),r=v.attr("struc_id"),null);if(!r){if("model-template"==o.type)for(let t=0;t<o.templates.length;t++)if(o.templates[t].chain==i){o.templates[t].annotation&&o.templates[t].annotation[e]&&(a=(a=X(o.templates[t].annotation,e)).replace(/[GI]/g,"H").replace(/B/g,"E"));break}if(!a)continue}v=($row=d.filter('[seqno="'+n+'"]')).find("span[s]").toArray();A.each(v,function(t,e){let n=null;s=parseInt(e.getAttribute("s")),a?"E"==a[s-1]?n=[51,204,51]:"H"==a[s-1]&&(n=[153,153,230]):chainMapping.structures[r][i][s]&&("E"==chainMapping.structures[r][i][s].ss?n=[51,204,51]:"H"==chainMapping.structures[r][i][s].ss&&(n=[153,153,230]),chainMapping.structures[r][i][s].rgb=n),e.style.backgroundColor="rgba("+n+",.6)"})}}else if(-1<["hydrophobic","size","charged","cysteine"].indexOf(h)||W[h])c.find("tr").each(function(){let i=A(this).attr("struc_id"),a=A(this).attr("chain");a=a||A(this).attr("keyseqchain");var t=A(this).find("span");A.each(t,function(t,e){if((res=e.getAttribute("r"))&&W[res]){var n=function(t,e){{var n;return"hydrophobic"!=t?"size"!=t?"charged"==t?-1<W.positive.indexOf(e)?[100,100,255]:-1<W.negative.indexOf(e)?[255,100,100]:void 0:"cysteine"==t?"C"==e?[202,168,14]:null:-1<W[t].indexOf(e)?[20,80,250]:null:null!=(n=W[e][t])?[Math.round(255*n),255-Math.round(255*n),0]:void 0:null!=(n=W[e][t])?[Math.round(255*n),0,255-Math.round(255*n)]:void 0}}(h,res);if(!n)return!0;e.style.backgroundColor="rgba("+n+",.6)",i&&chainMapping.structures[i]&&chainMapping.structures[i][a]&&(e=parseInt(e.getAttribute("s")),chainMapping.structures[i][a][e]&&(chainMapping.structures[i][a][e].rgb=n))}})});else if("soa"==h)U(c,"soa");else if(-1<h.indexOf("bfactor"))U(c,h);else if("entropy"==h)U(c,"entropy");else if("indels"==h&&"model-template"==c.data("templateData").type&&c.data("templateData").templates[0].tpl_seq){var b=c.data("templateData");let a=b.struc_id,n=99999999,i=0;var y=[],w=[];for(let e=0;e<b.templates.length;e++)if(b.templates[e].struc_id==a){trgOffset=b.templates[e].trg_offset?b.templates[e].trg_offset-1:0,i=b.templates[e].residue_from?(n=Math.min(n,b.templates[e].residue_from),Math.max(i,b.templates[e].residue_to)):(n=0,99999999999);for(let t=0;t<b.templates[e].trg_seq.length;t++)"-"!=b.templates[e].trg_seq.charAt(t)&&(w[t]="X"),"-"!=b.templates[e].tpl_seq.charAt(t)&&(y[t]="X")}let e=null,s=1+trgOffset,r=[],o=[];for(let t=0;t<b.templates[0].trg_seq.length;t++){if(!y[t])for(let t=0;-1==r.indexOf(s)&&t<b.keyseq_chain_name.length;t++)s>=n&&s<=i&&r.push(s);if(w[t])e=s,s++;else if(null!=e)for(let t=0;-1==o.indexOf(s)&&t<b.keyseq_chain_name.length;t++){b.keyseq_chain_name[t];s>=n&&s<=i&&o.push(s),s-1>=n&&s<=i&&o.push(s-1)}}for(let t=0;t<b.keyseq_chain_name.length;t++){let i=b.keyseq_chain_name[t];var _=c.find("tr[keyseqchain="+i+"]");A.each(_.find("span[s]:not([nores])"),function(t,e){var n=parseInt(e.getAttribute("s"));if(-1<r.indexOf(n))rgb=[80,214,80];else{if(!(-1<o.indexOf(n)))return!0;rgb=[100,100,255]}e.style.backgroundColor="rgba("+rgb+",.6)",chainMapping.structures[a][i][n].rgb=rgb})}}!A.cookie("targetMismatch")||"fade"==A.cookie("targetMismatch")?i.filter("[nm]").addClass("targetMismatch"):"enhance"==A.cookie("targetMismatch")&&(i.not("[nm]").addClass("targetMismatch"),i.not("[s]").addClass("targetMismatch")),M&&(P&&c.find("tr[seqno="+P.seqno+"]").find("span").eq(P.seqidx).addClass("cursor"),c.data("startEditRegion")&&c.data("endEditRegion")&&(t=c.data("startEditRegion"),i=c.data("endEditRegion"),n=(e=t.closest("tr")).attr("seqno"),e=e.siblings("[seqno="+n+"]").addBack().find("span"),n=(n=c.find("tr[seqno="+n+"]").find("span")).slice(e.index(t),e.index(i)+1).addClass("shadowCursor"),c.data("startEditRegion",n.first()),c.data("endEditRegion",n.last())))}}function U(n,c,t){if(!n.data("options").textOnly){let o=!1,l=null,e=null,h="bfactor_range"==c;h&&(c="bfactor"),(t||n.find("tr[struc_id]")).each(function(){l=A(this).attr("struc_id"),e=A(this).attr("qname");let r=A(this).attr("chain");if(!(r=r||A(this).attr("keyseqchain")))return!0;var t=A(this).find("span[s]");A.each(t,function(t,e){var n,i=parseInt(e.getAttribute("s"));if(!(chainMapping.structures[l]&&chainMapping.structures[l][r]&&chainMapping.structures[l][r][i]&&c in chainMapping.structures[l][r][i]))return!0;o=!0;let a=chainMapping.structures[l][r][i][c],s=[0,200,0];"entropy"==c?s=a<1.9?[Math.floor(a/1.9*256),Math.floor(a/1.9*256),255]:[255,256-Math.floor((a-1.9)/1.9*256),256-Math.floor((a-1.9)/1.9*256)]:"soa"==c?(a=Math.max(0,Math.min(1,.01*a)),s=[Math.floor(255*(1-a)),0,255-Math.floor(255*(1-a))]):"bfactor"==c&&(h?(n=chainMapping.annotations.map(t=>t.key).indexOf("bfactor_range"),chainMapping.annotations[n].rangeColours[l]&&chainMapping.annotations[n].rangeColours[l][r]&&(s=chainMapping.annotations[n].rangeColours[l][r][i])):s=a<=10?[0,0,255]:10<a&&a<=15?[115,115,255]:15<a&&a<=20?[170,170,255]:20<a&&a<=25?[215,215,255]:25<a&&a<=30?[255,215,215]:30<a&&a<=35?[255,170,170]:35<a&&a<=40?[255,115,115]:[255,0,0]),e.style.backgroundColor="rgba("+s+",.6)",chainMapping.structures[l][r][i].rgb=s})}),o||(!e||"soa"!=c&&"entropy"!=c||"undefined"==typeof SCORE_URL?"bfactor"==c&&fetchBFactors(l,"bfactor")&&U(n,c+(h?"_range":"")):A.getJSON(SCORE_URL.replace("xxxx.0",e.match(/\w{4}\.\d+/)[0])+c,function(e,t){if(e.error)console.error("Could not fetch "+c+" values");else{for(chn in e)for(let t=0;t<e[chn].values.length;t++)null!=e[chn].values[t]&&chainMapping.structures[l]&&chainMapping.structures[l][chn]&&chainMapping.structures[l][chn][t+e[chn].offset+1]&&(chainMapping.structures[l][chn][t+e[chn].offset+1][c]=e[chn].values[t]);H(c,n),u()}}))}}function u(n){if(n&&n.singleResidue||("function"==typeof colourRama&&colourRama(),"function"==typeof colourModelBars&&colourModelBars()),void 0!==currentWin){if(0<A("#pv:visible",currentWin.document).length){let e=[];if(pv_viewer.forEach(function(t){e.push(t.name())}),0!=e.length){for(let i in chainMapping.structures)-1<e.indexOf(i)&&pv_viewer.get(i)&&pv_viewer.get(i).colorBy(new pv.color.ColorOp(function(t,e,n){t=t.residue();chainMapping.structures[i][t.chain().name()]&&chainMapping.structures[i][t.chain().name()][t.num()]&&chainMapping.structures[i][t.chain().name()][t.num()].rgb?(e[n]=chainMapping.structures[i][t.chain().name()][t.num()].rgb[0]/255,e[n+1]=chainMapping.structures[i][t.chain().name()][t.num()].rgb[1]/255,e[n+2]=chainMapping.structures[i][t.chain().name()][t.num()].rgb[2]/255):(e[n]=.9,e[n+1]=.9,e[n+2]=.9),e[n+3]=1}));pv_viewer.requestRedraw()}}if(0<A("#ngl:visible",currentWin.document).length)if(n&&n.singleResidue){var i=n.singleResidue;for(schemeId in NGL.ColormakerRegistry.userSchemes)-1<schemeId.indexOf("singleres")&&(NGL.ColormakerRegistry.removeScheme(schemeId),ngl_stage.eachRepresentation(function(t){if(t.repr.colorScheme==schemeId)for(schemeId2 in NGL.ColormakerRegistry.userSchemes)if(schemeId2.endsWith(t.name))return void t.setColor(schemeId2)}));if(i){let n=i.struc_id;getNGLComponentByName(n)&&ngl_stage.eachRepresentation(function(t){var e;t.name==n&&chainMapping.structures[n]&&(e=NGL.ColormakerRegistry.addScheme(function(t){for(chn in chainMapping.structures[n])" "==chn&&A("#ngl_status").html("NGL cannot colour or select chains named whitespace!");this.atomColor=function(t){return ngl_picked_atom&&t.structure.name==ngl_picked_atom.structure.name&&t.index==ngl_picked_atom.index?16711680:chainMapping.structures[n][t.chainname]&&chainMapping.structures[n][t.chainname][t.resno]&&chainMapping.structures[n][t.chainname][t.resno].rgb?chainMapping.structures[n][t.chainname][t.resno].rgb[0]<<16|chainMapping.structures[n][t.chainname][t.resno].rgb[1]<<8|chainMapping.structures[n][t.chainname][t.resno].rgb[2]:16777215}},"singleres"),t.setColor(e))})}}else{var a,i=n;let e=[],t=(ngl_stage.eachRepresentation(function(t){e.push(t.name)}),i&&i.strucId?i.strucId:null);for(a in ngl_stage.compList)if(void 0!==ngl_stage.compList[a].structure){let n=ngl_stage.compList[a].name;if(!t||n==t){for(schemeId in NGL.ColormakerRegistry.userSchemes)-1<schemeId.indexOf(n)&&-1==schemeId.indexOf("membrane")&&NGL.ColormakerRegistry.removeScheme(schemeId);ngl_stage.eachRepresentation(function(t){var e;(t.name==n||t.name.endsWith(".highlight")||"drug.surroundings"==t.name)&&chainMapping.structures[n]&&(e=NGL.ColormakerRegistry.addScheme(function(t){for(chn in chainMapping.structures[n])" "==chn&&A("#ngl_status").html("NGL cannot colour or select chains named whitespace!");this.atomColor=function(t){return chainMapping.structures[n][t.chainname]&&chainMapping.structures[n][t.chainname][t.resno]&&chainMapping.structures[n][t.chainname][t.resno].rgb?chainMapping.structures[n][t.chainname][t.resno].rgb[0]<<16|chainMapping.structures[n][t.chainname][t.resno].rgb[1]<<8|chainMapping.structures[n][t.chainname][t.resno].rgb[2]:16777215}},n),t.setColor(e))})}}}}}function j(t){var a=A.cookie("secStruct"),e=(null==a&&(a="dssp"),t.attr("id")+"_features");if(A("#"+e).html(""),0==A("#"+e).length||a&&"none"==a)t.removeClass("ss"),L(t).removeClass("ss");else{t.addClass("ss"),L(t).addClass("ss");var r=t.position().top,o=t.find("td").first().width(),n=t.find("span")[0],l=n.getBoundingClientRect().width,i=n.getBoundingClientRect().height,h=t.position().left;if(!(o<1)){p=Raphael(e,o,t.height()),A("#"+e).css("top",t.position().top);var c=t.data("templateData");if(c){var u=t.find("tr:visible");if(c.keyseq_annotation)for(var d=0;d<c.keyseq_chain_name.length;d++){var g,f=c.keyseq_chain_name[d];function m(e,n,i){setTimeout(function(){var m,v,y,w,t,_,C,M,k,P,E,R,L;m=e,v=c.keyseq_annotation[n],y=a,w=g,t=i,_=r,C=o,M=l,k=c.pageResidueCount<5e3,P=null!=v.qmean,w=w||1,E=m.set(),R=m.set(),L=m.set(),t.each(function(t,e){if(0!=(span=A(e).find("span").toArray()).length){var n=e.getAttribute("struc_id");let t=e.getAttribute("chain");t=t||e.getAttribute("keyseqchain");var i=S-B,a=A(e).position().top-_+A(span[0]).position().top-B,r=a,o=e.getBoundingClientRect().left,l=span[0],e=span[span.length-1].getBoundingClientRect().right-o;if(P){m.path("M0,"+r+"L"+C+","+r+"L"+C+","+(r-i)+"L0,"+(r-i)).attr({"stroke-width":.4,stroke:"#888"});for(var h=Math.round(3);h<10;h++){var c=r-1/.7*(h/10-.3)*i,u=m.path("M0,"+c+"L"+C+","+c);5==h?u.attr({"stroke-width":.7,opacity:.8,stroke:"#888","stroke-dasharray":"-"}):E.push(u)}}for(var d,p,g,f="",h=0;h<span.length;h++)(l=span[h]).hasAttribute("s")?(p=(g=parseInt(l.getAttribute("s")))-w,v[y+"_string"]&&v[y+"_string"][p]?f+=v[y+"_string"][p]:f+="-",x=l.getBoundingClientRect().left-o,r=a,r-=2,P&&(c=r-1/.7*((p=Math.max(.3,chainMapping.structures[n][t][g].qm))-.3)*(i-2),k?(g="245,80,0",.5<p&&(g=Math.round(490*(1-p))+",80,"+(b=Math.round(255*p))),(s=m.path("M"+x+","+r+"L"+x+","+c+"L"+(x+M)+","+c+"L"+(x+M)+","+r)).attr({fill:"rgba("+g+",.6)",stroke:"#333"})):d=(d=(d=(d+="M"+x+" "+r)+"L"+x+" "+c)+"L"+(x+M)+" "+c)+"L"+(x+M)+" "+r),0):f+="-";txt=m.text(2,a+B/2,f),R.push(txt),txt.node.setAttribute("textLength",e-4+"px"),txt.node.firstChild.setAttribute("textLength",e-4+"px"),L.push(m.path(d))}}),R.attr({"text-anchor":"start","font-family":"consolas"}),L.attr({stroke:"#555"}),E.attr({"stroke-width":.9,stroke:"#888",opacity:.6,"stroke-dasharray":". "})},0)}c.keyseq_annotation[f]&&(g=c.templates[0].trg_offset||1,c.keyseq_annotation[f][a]&&st(p,at(c.keyseq_annotation[f],a,g),u.filter('[keyseqchain="'+f+'"]'),u.filter('[keyseqchain="'+f+'"]').find("span[s]").toArray(),r,h,o,l,i),c.charts&&m(p,f,u.filter('[keyseqchain="'+f+'"]')))}for(var v=0,y=1;y<u.length;y++){var w=u.eq(y);if(parseInt(w.attr("seqno"))<v)break;if(v=parseInt(w.attr("seqno")),!w.attr("keyseqtype"))for(var _=w.attr("tpl_id"),C=w.attr("chain"),M=($row=_?u.filter('[tpl_id="'+_+'"]'):u.filter('[chain="'+C+'"]')).find("span[s]").toArray(),k=0;k<c.templates.length;k++)(_?c.templates[k].id==_:c.templates[k].chain==C)&&c.templates[k].annotation&&c.templates[k].annotation[a]&&st(p,at(c.templates[k].annotation,a),$row,M,r,h,o,l,i)}}}}}function X(t,e){var n=t[e];return"string"==typeof n&&(t[e+"_string"]=n.replace(/[GI]/g,"H").replace(/B/g,"E")),t[e+"_string"]}function at(t,e,n){if(n=n||1,"string"==typeof t[e]){t[e+"_string"]=t[e];for(var i=t[e].replace(/[GI]/g,"H").replace(/B/g,"E"),a=null,s=0;s<i.length;s++)"H"!=i[s]&&"E"!=i[s]||(res_index=s+n,null==a?a=[[res_index,res_index,i[s]]]:a[a.length-1][1]==res_index-1&&a[a.length-1][2]==i[s]?a[a.length-1][1]=res_index:a.push([res_index,res_index,i[s]]));t[e]=a}return t[e]}function st(t,e,n,i,a,r,o,l,c){if(null!=e){n.attr("seqno");for(var u=0,d=i.length,p=0;p<e.length;p++)if("E"==e[p][2]||"H"==e[p][2]){for(var g,f=null,m=null,v=e[p][0];v<=e[p][1];v++)if(!(i[u].getAttribute("s")>v)){for(s=u;s<d;s++)if(i[s].getAttribute("s")==v){u=s,f=A(i[s]);break}if(f)break}for(v=e[p][1];v>=e[p][0];v--){for(s=u;s<d;s++)if(i[s].getAttribute("s")==v){u=s,m=A(i[s]);break}if(m)break}if(null==f||null==m)u=0;else{thisRow=f.closest("tr"),startRowIdx=n.index(thisRow),endRowIdx=n.index(m.closest("tr"));var b=f.position();startResLeft=b.left-r,spanTop=b.top,endResLeft=m.position().left-r,rightLimit=thisRow.width()-l-l;for(var y=startRowIdx;y<endRowIdx+1;y++)if(y>startRowIdx&&(thisRow=n.eq(y),spanTop=thisRow.find("span").first().position().top),g=thisRow.position().top+spanTop-a,"E"==e[p][2]){P=k=M=C=x=_=w=void 0;var w=t,_=g,x=startResLeft-(y-startRowIdx)*o,C=endResLeft+(endRowIdx-y)*o,M=l,k=c,P=rightLimit;_+=1,k-=2,padding=2,x=Math.max(-M,Math.round(x)),C=Math.min(P,Math.round(C+M)),(s=w.path("M"+x+","+(_-padding)+"L"+(C-6)+","+(1.5+_)+"L"+(C-6)+","+(_-padding)+"L"+(C+padding)+","+(k/2+_)+"L"+(C-6)+","+(k+_+padding)+"L"+(C-6)+","+(k-1.5+_)+"L"+x+","+(k+_+padding)+"L"+x+","+(_-padding))).attr({"stroke-width":.7,fill:"#DDD","fill-opacity":.3,stroke:"#226","stroke-dasharray":"5 2"}),s}else P=t,M=g,w=startResLeft-(y-startRowIdx)*o,C=endResLeft+(endRowIdx-y)*o,k=l,x=c,_=rightLimit,M+=2,x-=4,padding=2,w=Math.max(-k,Math.round(w)),C=Math.min(_,Math.round(C+k)),(h=P.rect(w,M-padding,C-w,x+2*padding,4)).attr({"stroke-width":.7,fill:"#DDD","fill-opacity":.3,stroke:"#226"}),h}}}}function a(){var t="";"Multi FASTA"==A("#alignmentFormatSelect").val()?A(".alignTbl:visible").each(function(){t=t+e(A(this).attr("id").substring(8),"FASTA")+"\n"}):t=e(A("#currentAlignmentIndex").val(),A("#alignmentFormatSelect").val()),A("#formattedAlignmentTextarea").val(t),A("#formattedAlignmentTextarea").focus(),A("#formattedAlignmentTextarea").select()}function e(t,e){e=e||"fasta";var n=A("#alignNameTbl"+t),i=A("#alignTbl"+t),a=[],s=[],r=[],t=0<A("#alignTbl"+t+" :visible").first().length?":visible":"",o=0,n=n.find("tr[seqno]"+t).each(function(t,e){parseInt(e.getAttribute("seqno"))>o&&o++});if(n.slice(0,o).each(function(e){var t=A(this).attr("seqno");a[e]=A(this).text(),r[e]=A(this).attr("title"),breakCount=0,i.find('tr[seqno="'+t+'"]').each(function(t){s[e]||(s[e]=""),s[e]+=A(this).find("td").first().text(),breakCount+=A(this).find(".insert_l,.insert_r").length}),0<breakCount&&(a[e]="MULTIPLE_SEGMENTS_OF_"+a[e]+" - WARNING - CONTAINS NON-SEQUENTIAL SEGMENTS")}),-1<e.search(/fasta/i)){var l=a,h=s,c=r;if(!h||0==h.length)return"No templates selected";for(var u="",d=0;d<l.length;d++){u+=">"+l[d]+(c&&c[d]?" "+c[d]:"")+"\n";for(var p=0;p<h[d].length;p+=72)u+=h[d].substring(p,p+72)+"\n"}return u}if(-1<e.search(/clustal/i)){var g=a,f=s;if(!f||0==f.length)return"No templates selected";for(var m=0,v=0;v<g.length;v++)m=Math.max(m,g[v].length);m+=2;for(var b="CLUSTAL\n\n",y=0;y<f[0].length;y+=60){for(v=0;v<g.length;v++){b+=g[v];for(var w=g[v].length;w<m;w++)b+=" ";b+=f[v].substring(y,y+60)+"\n"}b+="\n"}return b=b.substring(0,b.length-2)}return""}A.fn.alignment=function(t){return r[t]?r[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void A.error("Method "+t+" does not exist on alignment.min.js"):r.init.apply(this,arguments)}}(jQuery),Object.keys||(Object.keys=function(t){var e,n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);return n}),$(document).on("click",".alignmentOptions input[name=csRadioGroup]",function(){delete chainMapping.defaultColourScheme,$(".alignTbl:first").alignment("colourAllAlignments",{col:$(this).val()})}),$(document).on("click","#viewerSelect input[name=3dRG]",function(){showViewer($(this).val())}),$("body").on("highlightResidue",function(t,n){if("alignment"!=n.src){n.multiple||$(".hoverResidue").removeClass("hoverResidue");let e=$('.alignTbl tr[struc_id^="'+n.struc_id+'"]:visible');if(0<(e=0==e.length?$('.alignTbl tr[tpl_id="'+n.struc_id+'"]:visible'):e).length){let t=e.filter('[chain="'+n.chain+'"]');0<(t=0==t.length?e.filter('[keyseqchain="'+n.chain+'"]'):t).length&&t.find("span[s="+n.resno+"]").addClass("hoverResidue")}}}).on("selectResidue",function(t,n){if("alignment"!=n.src){$(".hoverResidue").removeClass("hoverResidue"),$(".selectResidue").removeClass("selectResidue");let e=$('.alignTbl tr[struc_id^="'+n.struc_id+'"]:visible');if(0<(e=0==e.length?$('.alignTbl tr[tpl_id="'+n.struc_id+'"]:visible'):e).length){let t=e.filter('[chain="'+n.chain+'"]');0<(t=0==t.length?e.filter('[keyseqchain="'+n.chain+'"]'):t).length&&t.find("span[s="+n.resno+"]").addClass("selectResidue")}}}),$("body").on("click",function(t){$(".poponthis").each(function(){$(this).is(t.target)||0!==$(this).has(t.target).length||0!==$(".popover").has(t.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})}),addSettingsPopover(),0<$("#bgColSlider").length&&$("#bgColSlider").slider({value:$.cookie("bg_r")?$.cookie("bg_r"):255,min:0,max:255,step:1,slide:function(t,e){pv_viewer.options("background",[e.value/255,e.value/255,e.value/255]),ngl_stage&&ngl_stage.setParameters({backgroundColor:"rgb("+e.value+","+e.value+","+e.value+")"}),jQuery.cookie("bg_r",e.value,{expires:365,path:"/"})},change:function(t,e){pv_viewer.options("background",[e.value/255,e.value/255,e.value/255]),ngl_stage&&ngl_stage.setParameters({backgroundColor:"rgb("+e.value+","+e.value+","+e.value+")"}),jQuery.cookie("bg_r",e.value,{expires:365,path:"/"}),e.value<180?$(".viewerStatus").addClass("status_dark"):$(".viewerStatus").removeClass("status_dark")}}),$.cookie("bg_r")&&$.cookie("bg_r")<180&&$(".viewerStatus").addClass("status_dark");const chainMapping={structures:{},targets:{},alignments:[],chainMeta:{},annotations:[{key:"qm",label:"Confidence",active:!0},{key:"qmb",label:"QMEANBrane",active:!1},{key:"c",label:"Consistency",active:!0},{key:"entropy",label:"Entropy",active:!0},{key:"soa",label:"Solvent Accessibility",active:!0},{key:"bfactor",label:"B-factor",active:!0},{key:"bfactor_range",label:"B-factor range",active:!0}]};let annotationsModified=!1;function processAnnotations(d){if(0<$("#pv:visible",currentWin.document).length&&(pv_viewer.rm("model_"+(d||"*")+".label"),pv_viewer.rm("model_"+(d||"*")+".selected")),0<$("#ngl:visible",currentWin.document).length)for(const i in modelData)if(!d||i==d){var e=getNGLComponentByName("model_"+i);if(e){var n=[];for(let t=0;t<e.reprList.length;t++)(-1<e.reprList[t].name.indexOf(".label")||-1<e.reprList[t].name.indexOf(".selected"))&&n.push(e.reprList[t]);for(let t=0;t<n.length;t++)e.removeRepresentation(n[t])}}var s,t,p=[],g=$("#annotate").val().split(/\r?\n/),f={};for(let i=0;i<g.length;i++){let a,r,e,o,l,h,c,u=!1,t=(g[i]=g[i].trim().replace(/\s{1,}/g," ").replace(/\s*= */g,"="),g[i]);-1<t.search(/label=\"(.+)\"/i)&&(s=t.match(/label=\"(.+)\" ?/i),c=s[1],t=t.replace(s[0],"").trim());let n=!1;var m=t.split(" ");for(let t=0;t<m.length;t++){var v=m[t].split("=");if(2!=v.length)n=!0;else switch(v[0].toUpperCase()){case"MOTIF":a=v[1];break;case"COLOUR":case"COLOR":r=255*(r=new NGL.Color(v[1].toLowerCase())).r+","+255*r.g+","+255*r.b;break;case"TARGET":e=parseInt(v[1]);break;case"CHAIN":o=v[1];break;case"START":l=parseInt(v[1]);break;case"END":h=parseInt(v[1]);break;case"LABEL":c=v[1];break;case"SIDECHAINS":u="on"==v[1];break;default:n=!0}}if(a){let t=!1;try{rxtest=RegExp(a,"g"),t=!0}catch(t){}t||(console.error("Motif regex is invalid"),n=!0)}if(n=null!=r||null!=c||u?n:!0)0<g[i].length&&"?"!=g[i].charAt(0)?p.push("?"+g[i]):p.push(g[i]);else{p.push(g[i]);for(const C in modelData)if(!modelData[C].status||"COMPLETED"==modelData[C].status){let s={};for(let t=0;t<modelData[C].targets.length;t++)if(null==e||e==t+1){var b=modelData[C].targets[t];let e=b.target_sequence,n=b.id,i=(e||(e=b.templates[0].trg_seq,b.templates[0].tpl_seq&&(e=e.replaceAll("-","")),n=b.keyseq_chain_name,b.templates[0].trg_offset&&(e="-".repeat(b.templates[0].trg_offset-1)+e)),"string"!=typeof n&&(n=n.join("")),f["model_"+C]||(f["model_"+C]=[]),a);null==i&&(i=e.substring(l?l-1:0,h||e.length));for(let t=0;t<n.length;t++){var y=n.charAt(t);if(null==o||y==o){s[y]||(s[y]={labelled:[],selected:[]});var w=RegExp(i,"g");for(const M of e.matchAll(w)){let e=M.index+1,n=e+M[0].length-1;if(4==M.length&&(e+=M[1].length,n=e+M[2].length-1),!(l&&l>n)&&(!(h&&h<e)&&(l&&(e=Math.max(e,l)),h&&(n=Math.min(n,h)),r&&f["model_"+C].push({frmChn:y,toChn:y,resStart:e,resEnd:n,rgb:r}),c||u))){c&&"default"==c.toLowerCase()&&(c="default");var _=Math.floor((n-e)/2)+e;for(let t=e;t<=n;t++)u&&s[y].selected.push(t),"default"==c&&s[y].labelled.push(t);c&&"default"!=c&&s[y].labelled.push(_)}}}}}if((c||u)&&(null==d||d==C))if(0<$("#pv:visible",currentWin.document).length){var x=pv_viewer.get("model_"+C);!x||(x=x.structure().residueSelect(function(t){if(s[t.chain().name()]&&(-1<s[t.chain().name()].selected.indexOf(t.num())||-1<s[t.chain().name()].labelled.indexOf(t.num())))return-1<s[t.chain().name()].labelled.indexOf(t.num())&&t.eachAtom(function(t){"CA"==t.name()&&pv_viewer.label(`model_${C}.label`,"default"!=c?c:t.residue()._name+" "+t.residue()._chain.name()+t.residue().num(),t.pos(),{fontSize:12,fontColor:"#CCC"})}),-1<s[t.chain().name()].selected.indexOf(t.num())}))&&pv_viewer.ballsAndSticks(`model_${C}.selected`,x)}else if(0<$("#ngl:visible",currentWin.document).length){x=getNGLComponentByName("model_"+C);if(x){let n="",i=!1;for(chn in s)if(0!=s[chn].labelled.length){0<n.length&&(n+=" or "),n+="( :"+chn+" and (";let e=null;for(let t=0;t<s[chn].labelled.length;t++)i=!0,e=(e&&s[chn].labelled[t]==e+1||(e&&(n+="-"+e),0<t&&(n+=" or "),n+=s[chn].labelled[t]),s[chn].labelled[t]);e&&(n+="-"+e),n+=") and .CA) "}i&&x.addRepresentation("label",{name:"model_"+C+".label",sele:n,labelType:"format",labelFormat:"default"!=c?c:"%(resname)s %(chainname)s%(resno)s",fontWeight:"bold",radiusScale:1.4,xOffset:.3}),n="";let a=!1;for(chn in s)if(0!=s[chn].selected.length){0<n.length&&(n+=" or "),n+="( :"+chn+" and (";let e=null;for(let t=0;t<s[chn].selected.length;t++)a=!0,e=(e&&s[chn].selected[t]==e+1||(e&&(n+="-"+e),0<t&&(n+=" or "),n+=s[chn].selected[t]),s[chn].selected[t]);e&&(n+="-"+e),n+=")) "}a&&x.addRepresentation("ball+stick",{name:"model_"+C+".selected",sele:n,colorScheme:"element"})}}}}}d||(t=p.join("\n"),"undefined"!=typeof annotationsURL&&-1==t.search(/^\?/m)&&$.ajax({type:"POST",url:annotationsURL,data:{annotations:t,csrfmiddlewaretoken:csrf},success:function(t){annotationsModified=!1},error:function(t){console.error(t)}}),chainMapping.defaultColourScheme="features",$("#annotate").val()!=t&&$("#annotate").val(t),$(".alignTbl:first").alignment("colourAllAlignments",{features:f}))}$("#annotate").on("keyup",function(t){var e=t.keyCode||t.which;"keyup"==t.type&&13==e?processAnnotations():annotationsModified=!0}),$("body").on("centerResRange selectResidue",function(t,r){if(r.struc_id&&0!=$("#annotate:visible").length){let a=r.resno,s=r.resno;for(var o in null==a&&(a=r.min,s=r.max),modelData)if("model_"+o==r.struc_id){for(let i=0;i<modelData[o].targets.length;i++){var l=modelData[o].targets[i];let e=l.target_sequence,t=l.id,n=0;if(e||(e=l.templates[0].trg_seq,l.templates[0].tpl_seq&&(e=e.replaceAll("-","")),t=l.keyseq_chain_name,l.templates[0].trg_offset&&(n=l.templates[0].trg_offset-1)),-1<t.indexOf(r.chain)){l=e.substring(a-1-n,s-n);let t=$("#annotate").val();"\n"!=t.charAt(t.length-1)&&(t+="\n"),t+="motif="+l,1<modelData[o].targets.length&&(t+=" target="+(i+1)),$("#annotate").val(`${t} start=${a} end=${s}\n`).scrollTop($("#annotate")[0].scrollHeight);break}}break}}});var currentWin=window,main_NGL_module=null,main_pv=null,main_ngl=null,plip_bond_num_dash=5,plip_bond_radius=.1,plip_higlight_factor=2,plip_higlight_bond_num_dash=1,PLIP=PLIP||{},opacity_fadeout_ligand=(PLIP.AbstractViewer=null,.3),opacity_fadeout_protein=.3;function takeSnapshot(e,t){var n;".png"==e&&(e="structure.png"),0<$("#pv:visible",currentWin.document).length&&$("#pv canvas")[0].toBlob(function(t){saveAs(t,e)}),0<$("#ngl:visible",currentWin.document).length&&(t=t||1,n=$("#snapshot_bg_transparent_checkbox").is(":checked"),ngl_stage.makeImage({factor:t,antialias:!1,trim:!1,transparent:n}).then(function(t){NGL.download(t,e)}))}function resetStructure(){$(".hoverResidue").removeClass("hoverResidue"),$(".selectResidue").removeClass("selectResidue"),0<$("#pv:visible",currentWin.document).length&&(pv_viewer.show("*ligands"),pv_viewer.hide("*ligands_lines"),pv_viewer.rm("*res"),pv_viewer.autoZoom(),pv_viewer.requestRedraw()),0<$("#ngl:visible",currentWin.document).length&&(ngl_stage.eachRepresentation(function(t){-1<t.name.indexOf("hover")&&"none"!=t.repr.selection.string&&t.setSelection("none")}),ngl_stage.autoView(1200))}function spin(t){"undefined"!=typeof pv_viewer&&pv_viewer.spin(t),null!=ngl_stage&&(t?ngl_stage.setSpin([0,1,0],-.005):ngl_stage.setSpin(0))}function detach(t){if(currentWin==window){if(0<$("#pv:visible",currentWin.document).length)currentWin=window.open(t.replace("xx","pv"),"_blank","resizable=1,status=1,toolbar=1,location=1,height=700,width=700"),main_pv=pv_viewer;else{if(!(0<$("#ngl:visible",currentWin.document).length))return;main_ngl=ngl_stage,main_NGL_module=NGL,currentWin=window.open(t.replace("xx","ngl"),"_blank","resizable=1,status=1,toolbar=1,location=1,height=700,width=700")}$("#left-panel").is(".ui-resizable")&&$("#left-panel").resizable("destroy"),$("#left-panel").removeClass().addClass("detached"),$("#right-panel").hide(),$(window).trigger("resize")}}function attachPV(){pv_viewer=main_pv,attach()}function attachNGL(){var t=ngl_stage.viewerControls.getOrientation();NGL=main_NGL_module,(ngl_stage=main_ngl).removeAllComponents(),showNGL(t),attach()}function attach(){if(currentWin=window,t=$("#right-panel").attr("class"))for(var t=t.split(/\s+/),e=0;e<t.length;e++)3==(size=t[e].split("-")).length&&$("#left-panel").addClass(size[0]+"-"+size[1]+"-"+(12-parseInt(size[2])));$("#left-panel").removeClass("detached").resizable({handles:"e",stop:function(){}}),$("#right-panel").show(),$(window).trigger("resize"),"undefined"!=typeof superposeTemplates&&superposeTemplates(!0),refreshBondsAndLigandHighlights()}function refreshBondsAndLigandHighlights(t){refreshHighlightLigands(t),refreshBonds(t)}function refreshBonds(t){void 0===t?plip_bonds.refreshAll():plip_bonds.refresh(t)}function refreshHighlightLigands(t){void 0===t?all_ligands.redrawAll():all_ligands.redraw(t)}function centerOnLigand(t,e){0<$("#pv:visible",currentWin.document).length&&centerOnLigandPV(t,e),0<$("#ngl:visible",currentWin.document).length&&centerOnLigandNGL(t,e)}function highlightLigand(t,e,n){$(".ligandContact").removeClass("ligandContact");for(var i={},a=0;a<e.length;a++)e[a]&&"_"!=e[a].charAt(0)&&(res=e[a].substring(1),i[chain=e[a].charAt(0)]||(i[chain]=[]),i[chain].push(res));var s,r=$(".alignTbl tr[struc_id="+n+"]"),o=r[0].hasAttribute("keyseqchain")?"keyseqchain":"chain";for(s in i)for(var l=r.filter("["+o+"="+s+"]").find("span").toArray(),a=0;a<i[s].length;a++)for(var h=0;h<l.length;h++)if(l[h].getAttribute("s")==i[s][a]){l[h].className="ligandContact";break}0<$("#pv:visible",currentWin.document).length&&highlightLigandPV(i,e,n),0<$("#ngl:visible",currentWin.document).length&&highlightLigandNGL(t,e,n)}function selectResidues(t,e,n,i){if(null!=t||null!=e)return 0<$("#pv:visible",currentWin.document).length?highlightResiduesPV(t,e,n,i):0<$("#ngl:visible",currentWin.document).length?highlightResiduesNGL(t,e,n,i):void 0;0<$("#pv:visible",currentWin.document).length&&pv_viewer.rm(n+"_res"),0<$("#ngl:visible",currentWin.document).length&&("undefined"!=typeof all_ligands&&"undefined"!=typeof plip_residues?highlightLigandNGL(all_ligands.getVisibleLigandIds(n),plip_residues.getVisibleResiduesResId(n),n,i):highlightResiduesNGL([],[],n,i))}function changeRep(t){t=t||"cartoon",0<$("#pv:visible",currentWin.document).length&&(changeRepPV(t),null!=pv_viewer&&0<pv_viewer.all().length&&("undefined"!=typeof detached&&detached?window.opener.updatecols():updatecols())),0<$("#ngl:visible",currentWin.document).length&&(changeRepNGL(t),"undefined"!=typeof detached&&detached?window.opener.updatecols():updatecols())}function updatecolsSingleRes(t){$(".alignTbl:first").alignment("updateColoursSingleResidue",t)}function updatecols(){$(".alignTbl:first").alignment("viewerInitialised")}function fetchSecStruc(t){if(0<$("#pv:visible",currentWin.document).length){if(pv_viewer.get(t))return fetchSecStrucPV(t,pv_viewer.get(t).structure())}else if(0<$("#ngl:visible",currentWin.document).length&&getNGLComponentByName(t))return fetchSecStrucNGL(t,getNGLComponentByName(t).structure)}function fetchBFactors(t,e,n){if(0<$("#pv:visible",currentWin.document).length){if(pv_viewer.get(t))return fetchBFactorsPV(t,pv_viewer.get(t).structure(),e,n)}else if(0<$("#ngl:visible",currentWin.document).length&&getNGLComponentByName(t))return fetchBFactorsNGL(t,getNGLComponentByName(t).structure,e,n)}function setBFactorRange(t){let e=1e10,n=-1e10,i=0,a=0;for(chn in chainMapping.structures[t])for(res in chainMapping.structures[t][chn]){var s;chainMapping.structures[t][chn][res]&&chainMapping.structures[t][chn][res].bfactor&&(s=chainMapping.structures[t][chn][res].bfactor,e=Math.min(s,e),n=Math.max(s,n),i+=s*s,a++)}i/=a,i=Math.sqrt(i),n=2*i;var r=[];for(let t=0;t<256;t++)r.push([t,t,255]);for(let t=256;t<512;t++)r.push([255,512-t,512-t]);var o,l=chainMapping.annotations.map(t=>t.key).indexOf("bfactor_range");for(chn in chainMapping.annotations[l].rangeColours||(chainMapping.annotations[l].rangeColours={}),chainMapping.annotations[l].rangeColours[t]={},chainMapping.structures[t])for(res in chainMapping.annotations[l].rangeColours[t][chn]=[],chainMapping.structures[t][chn])chainMapping.structures[t][chn][res]&&chainMapping.structures[t][chn][res].bfactor&&(o=chainMapping.structures[t][chn][res].bfactor,o=Math.round(512*(o-e)/(n-e))-1,o=Math.max(o,0),o=Math.min(o,511),chainMapping.annotations[l].rangeColours[t][chn][res]=r[o])}$("body").on("highlightResidue",function(t,e){if("structure"!=e.src&&"varianceChart"!=e.src)return null!=e.chain||null!=e.resno?0<$("#pv:visible",currentWin.document).length?highlightResiduesPV(e.chain,e.resno,e.struc_id,e.multiple):0<$("#ngl:visible",currentWin.document).length?highlightResiduesNGL(e.chain,e.resno,e.struc_id,e.multiple):void 0:(0<$("#pv:visible",currentWin.document).length&&pv_viewer.rm(e.struc_id+"_res"),void(0<$("#ngl:visible",currentWin.document).length&&ngl_stage.getRepresentationsByName(e.struc_id+".hover").list[0].setSelection("none")))}),$("body").on("centerResRange",function(t,e){0<$("#pv:visible",currentWin.document).length&&centerResRangePV(e.chain,e.min,e.max,e.struc_id,e.isDisulfid,e.secondChain),0<$("#ngl:visible",currentWin.document).length&&centerResRangeNGL(e.chain,e.min,e.max,e.struc_id,e.isDisulfid,e.secondChain)}),$("body").on("connectResidues",function(t,e){0<$("#pv:visible",currentWin.document).length&&connectResiduesPV(e.residuePairs),0<$("#ngl:visible",currentWin.document).length&&connectResiduesNGL(e.residuePairs)});var ngl_stage=null,ngl_picked_atom=!1,ngl_picked_component=!1;function getNGL(){var t="white",t=($.cookie("bg_r")&&(t="rgb("+$.cookie("bg_r")+","+$.cookie("bg_r")+","+$.cookie("bg_r")+")"),ngl_stage=new NGL.Stage("ngl",{backgroundColor:t,hoverTimeout:.005,sampleLevel:2,tooltip:!1}),(new NGL.Matrix4).makeRotationX(Math.PI/2)),e=(new NGL.Quaternion).setFromRotationMatrix(t);return ngl_stage.viewerControls.rotate(e),t=(new NGL.Matrix4).makeRotationY(Math.PI),e=(new NGL.Quaternion).setFromRotationMatrix(t),ngl_stage.viewerControls.rotate(e),ngl_stage.signals.clicked.add(function(t){var e;t&&(t.atom||t.bond)&&(e=t.atom||t.closestBondAtom,t.component.autoView(e.resno+":"+e.chainname,1e3),$("body").trigger("selectResidue",{src:"structure",struc_id:t.component.name,chain:e.chainname,resno:e.resno}))}),ngl_stage.signals.hovered.add(function(t){var e,n,i;ngl_stage.mouseObserver.pressed||(t&&(t.atom||t.bond)?(e=t.atom||t.closestBondAtom,ngl_picked_atom&&e.structure.name==ngl_picked_atom.structure.name&&e.index==ngl_picked_atom.index||(n=getNGLRepresentationByName(t.component.name),ngl_picked_atom=e,ngl_picked_component=t.component,i=e.resname+" "+e.resno+e.inscode,"_"!=e.chainname&&(i+=" "+e.chainname),"_"!=e.chainname&&["cartoon","tube","rope"].includes(n.repr.type)&&"CA"==e.atomname||(i+=" "+e.atomname),i+=resAnnoLabel(t.component.name,e.chainname,e.resno),$("#ngl_status").html(i),$("body").trigger("highlightResidue",{src:"structure",struc_id:t.component.name,chain:e.chainname,resno:e.resno}),"undefined"!=typeof detached&&detached?(window.opener.ngl_picked_atom=ngl_picked_atom,window.opener.updatecolsSingleRes({struc_id:t.component.name,chain:e.chainname,resno:e.resno})):updatecolsSingleRes({struc_id:t.component.name,chain:e.chainname,resno:e.resno}))):ngl_picked_atom&&(ngl_picked_atom=!1,$("#ngl_status").text(""),"undefined"!=typeof detached&&detached?(window.opener.ngl_picked_atom=ngl_picked_atom,window.opener.updatecolsSingleRes()):updatecolsSingleRes()))}),ngl_stage}function getNGLComponentByName(t){return ngl_stage.getComponentsByName(t).list[0]}function getNGLRepresentationByName(t){return ngl_stage.getRepresentationsByName(t).list[0]}function removeNGLComponentByName(t){t=getNGLComponentByName(t);ngl_stage.removeComponent(t)}function highlightResiduesNGL(t,e,n,i){var a="";if(!e){var s=getNGLComponentByName(n),r="";if(s){if(1==t.length)r=(e||"")+":"+t;else for(l=0;l<t.length;l++)r+=(e||"")+":"+t[l]+" ";s.autoView(r,1e3)}return r}ngl_stage.eachRepresentation(function(t){-1<t.name.indexOf("hover")&&-1==t.name.indexOf(n)&&"none"!=t.repr.selection.string&&t.setVisibility(!1)});s=getNGLRepresentationByName(n+".hover");if(s){s.setVisibility(!0),i&&(a=s.repr.selection.string+" ").startsWith("none")&&(a=a.substring(5));for(var o=getNGLComponentByName(n).structure,r="",l=0;l<t.length;l++)if(e.length)for(var h=0;h<e.length;h++)e[h][0]==e[h][1]?isResidueInStructureNGL(o,t[l],e[h][0])&&(r+=e[h][0]+":"+t[l]+" "):(console.warn("Not checking if the selection is part of the structure"),r+=e[h][0]+"-"+e[h][1]+":"+t[l]+" ");else isResidueInStructureNGL(o,t[l],e)&&(r+=e+":"+t[l]+" ");return""==(new_selection=a+r)&&(new_selection="none"),s.setSelection(new_selection),new_selection}}function centerResRangeNGL(t,e,n,i,a,s){var r="";if(o=getNGLComponentByName(i)){for(var o=o.structure,l=0;l<t.length;l++)for(var h=s?e:n,c=e;c<=h;c++)a&&c!=e&&c!=h||isResidueInStructureNGL(o,t[l],c)&&(r+=c+":"+t[l]+" ");if(s)for(l=0;l<s.length;l++)isResidueInStructureNGL(o,s[l],n)&&(r+=n+":"+s[l]+" ");""!=r&&getNGLComponentByName(i).autoView(r,1e3)}}function centerOnLigandNGL(t,e){for(var n,i=t[0]+":_",a=1;a<t.length;a++)i+=" "+t[a]+":_";for(n in ngl_stage.compList)if(ngl_stage.compList[n].name==e){ngl_stage.compList[n].autoView(i,1e3);break}}function contactListToNGLSelection(t,e,n){var i,a={},s=null;if(void 0!==n&&null!=n||(n=[]),e&&0<e.length)for(var r=getNGLComponentByName(t).structure,o=0;o<e.length;o++)e[o]&&(s=e[o].charAt(0),i=parseInt(e[o].substring(1)),"_"==s&&-1==n.indexOf(i)&&n.push(i),isResidueInStructureNGL(r,s,i)&&"-"!=s&&(a[s]||(a[s]=[]),a[s][i]=1));var l="",h="";for(s in a){l+=" ( (",h+=" ( (";for(var c=!0,o=0;o<a[s].length;o++)if(a[s][o]){for(c?c=!1:(l+=" or ",h+=" or "),l+=o,h+=o-2,start=o;a[s][++o];);1<o-start&&(l+="-"+(o-1)),h+="-"+(o+1)}l+=") AND :"+s+") ",h+=") AND :"+s+") "}return[l,h,n]}function isResidueInStructureNGL(t,e,n){var i={};try{t.eachChain(function(t){t.chainname==e&&(first_residue=t.residueStore.resno[t.residueOffset],last_residue=t.residueStore.resno[t.residueEnd],t.eachResidue(function(t){if(t.resno==n)throw i}))})}catch(t){if(t===i)return!0}return!1}function highlightLigandNGL(t,e,n,i,a){removeNGLComponentByName(n+"ligandBondsHL"),void 0===i&&(i="undefined"==typeof extra_residues_selection?[]:extra_residues_selection),void 0===a&&(a="undefined"==typeof extra_ranges_selection?[]:extra_ranges_selection),residue_contacts=e.concat(i),ranges_contacts=residue_contacts.concat(a);var s,r,e=contactListToNGLSelection(n,residue_contacts,t),o=(t=e[2],contactListToNGLSelection(n,ranges_contacts));let l=e[0],h=o[1];for(s in""==l&&(l="none"),""==h?(h="none",fadeOutRepresentationNGL(n,n,1)):fadeOutRepresentationNGL(n,n,opacity_fadeout_protein),ngl_stage.compList)if(ngl_stage.compList[s].name==n){for(var c in ngl_stage.compList[s].reprList)ngl_stage.compList[s].reprList[c].name==n+".residuesHighlight"&&ngl_stage.compList[s].reprList[c].setSelection(l),ngl_stage.compList[s].reprList[c].name==n+".highlight"&&(protein_residue_sele_string="protein AND ("+h+")",ngl_stage.compList[s].reprList[c].setSelection(protein_residue_sele_string));break}t&&0<t.length?(r=":_ and ("+t.join(" or ")+")",fadeOutRepresentationNGL(n,n+".ligands",opacity_fadeout_ligand)):0<i.length||0<a.length?(r="none",fadeOutRepresentationNGL(n,n+".ligands",opacity_fadeout_ligand)):(r="none",fadeOutRepresentationNGL(n,n+".ligands",1));e=getNGLRepresentationByName(n+".ligandsHighlight");e&&e.setSelection(r)}function fadeOutRepresentationNGL(t,e,n){(repr=getNGLRepresentationByName(e))&&repr.setParameters({opacity:n})}function connectResiduesNGL(t){var e=[];ngl_stage.compList.forEach(function(t){-1<t.name.indexOf("connect")&&e.push(t)});for(var n=0;n<e.length;n++)ngl_stage.removeComponent(e[n]);if(t)for(n=0;n<t.length;n++){var i,a=getNGLComponentByName(t[n][0].struc_id),s=new NGL.Shape("connect."+n+".line",{disableImpostor:!0});a&&(i=a.structure.getView(new NGL.Selection(t[n][0].res_num+":"+t[n][0].chain+".CA")).getAtomData().position,a=a.structure.getView(new NGL.Selection(t[n][1].res_num+":"+t[n][1].chain+".CA")).getAtomData().position,0<i.length&&0<a.length&&(score=Math.min(1,2*t[n][2]),s.addCylinder(i,a,[.9,1-score,1-score],.2),ngl_stage.addComponentFromObject(s).addRepresentation("buffer")))}}function changeRepNGL(e){switch($("#repBtnLbl").text(e.charAt(0).toUpperCase()+e.substring(1)),jQuery.cookie("defaultRepr",e,{expires:365,path:"/"}),e){case"lines":e="line";break;case"ballAndStick":e="ball+stick";break;case"outline":return}var n,a=null;ngl_stage.eachRepresentation(function(t){if(!t.name.match(/(ligands|dna|over|buffer|membrane)/))for(i in n=t.name.split(".")[0],ngl_stage.compList)if((comp=ngl_stage.compList[i]).name==n){if("surface"==(a=null===a?t.repr.type:a)&&"surface"!=e){console.debug("Adding residuesHighlight representation");comp.addRepresentation(e,{name:n+".residuesHighlight",sele:"none",smoothSheet:!0,roughness:1,surfaceType:"sas",probeRadius:1.4,side:"front",opacity:t.getParameters().opacity,scaleFactor:Math.min(1.5,Math.max(.1,5e4/comp.structure.atomCount))});try{refreshBondsAndLigandHighlights()}catch(t){}}comp.removeRepresentation(t),"surface"==e&&t.name==n+".residuesHighlight"?console.debug("Removing surface residuesHighlight"):comp.addRepresentation(e,{name:t.name,sele:t.getParameters().sele,smoothSheet:!0,surfaceType:"sas",probeRadius:1.4,scaleFactor:Math.min(1.5,Math.max(.1,5e4/comp.structure.atomCount)),roughness:1,side:"front",opacity:t.getParameters().opacity})}})}function setupNGLRepresentations(e,n,t,i,a,s){a&&ngl_stage.viewerControls.orient(a),void 0===t&&(t=!1);var r=$.cookie("defaultRepr");null==r?r="cartoon":"ballAndStick"==r?r="ball+stick":"lines"==r&&(r="line"),e.setName(n),e.addRepresentation(r,{name:n,sele:"not :_ and not nucleic and not :-"+(s?" and not ligand":""),smoothSheet:!0,roughness:1,surfaceType:"sas",probeRadius:1.4,scaleFactor:Math.min(1.5,Math.max(.1,5e4/e.structure.atomCount)),side:"front"}),e.addRepresentation("ball+stick",{name:n+".ligands",colorScheme:"element",sele:":_"+(s?" or ligand":""),side:"front"}),e.addRepresentation("ball+stick",{name:n+".residuesHighlight",colorScheme:"element",sele:"none",aspectRatio:1}),e.addRepresentation("ball+stick",{name:n+".hover",sele:"none"}),t&&(e.addRepresentation("ball+stick",{name:n+".ligandsHighlight",colorScheme:"element",sele:"none"}),"surface"!=r&&e.addRepresentation(r,{name:n+".highlight",sele:"none",smoothSheet:!0,roughness:1,surfaceType:"sas",probeRadius:1.4,scaleFactor:Math.min(1.5,Math.max(.1,5e4/e.structure.atomCount)),side:"front"})),i.forEach(function(t){scheme="line"==t?"element":"base"==t?"resname":"moleculetype",e.addRepresentation(t,{name:n+".dna",colorScheme:scheme,sele:"nucleic and not :_"})}),a?ngl_stage.autoView():"function"==typeof on_viewer_ready_function?on_viewer_ready_function(n,e):e.autoView(1e3),updatecols(n),t&&refreshBondsAndLigandHighlights()}function resAnnoLabel(n,i,a){let s="";if(chainMapping.structures[n]&&chainMapping.structures[n][i]&&chainMapping.structures[n][i][a]){chainMapping.chainMeta[n]&&chainMapping.chainMeta[n][i]&&(s+=" ("+chainMapping.chainMeta[n][i].display+")");for(let e=0;e<chainMapping.annotations.length;e++)if(chainMapping.annotations[e].active&&null!=chainMapping.structures[n][i][a][chainMapping.annotations[e].key]){let t=chainMapping.structures[n][i][a][chainMapping.annotations[e].key];s+="<br><small>"+chainMapping.annotations[e].label+": "+("number"==typeof t?t.toFixed("ramachandran"==chainMapping.annotations[e].key?4:2):t),"qm"==chainMapping.annotations[e].key&&"confClass"==$.cookie("colourScheme")&&(t<1&&(t*=100),90<t?s+=" (Very high)":70<t?s+=" (Confident)":50<t?s+=" (Low)":s+=" (Very low)"),s+="</small>"}}return s}function fetchBFactorsNGL(i,t,a,s){let r=0,o=0;return chainMapping.structures[i]||(chainMapping.structures[i]={}),t.eachResidue(function(t){var n=t.chainname;if(!n.match(/(_|-)/)){let e=0;t.eachAtom(function(t){e+=t.bfactor}),r+=e/t.atomCount,o++,coloursAssigned=!0,chainMapping.structures[i][n]||(chainMapping.structures[i][n]=[]),chainMapping.structures[i][n][t.resno]||(chainMapping.structures[i][n][t.resno]={}),s&&!chainMapping.structures[i].invalidMapping&&chainMapping.structures[i][n][t.resno].resname&&residueProperties[chainMapping.structures[i][n][t.resno].resname].triplet!=t.resname&&(chainMapping.structures[i].invalidMapping=!0),chainMapping.structures[i][n][t.resno][a]=e/t.atomCount}}),"bfactor"==a&&setBFactorRange(i),0<r?r/o:0}function fetchSecStrucNGL(e,t){let n;return t.eachResidue(function(t){(n=t.chainname).match(/(_|-)/)||(chainMapping.structures[e]||(chainMapping.structures[e]={}),chainMapping.structures[e][n]||(chainMapping.structures[e][n]=[]),chainMapping.structures[e][n][t.resno]||(chainMapping.structures[e][n][t.resno]={}),chainMapping.structures[e][n][t.resno].ss=t.sstruc.toUpperCase(),""==chainMapping.structures[e][n][t.resno].ss&&(chainMapping.structures[e][n][t.resno].ss="C"))}),!0}function setColorForAtom(t,e,n){var i=t.structure().createEmptyView();i.addAtom(e),t.colorBy(pv.color.uniform(n),i)}var prevPicked=null;function doPVMouse(t){var e,n,i,a;pv_viewer._mouseHandler._lastMouseDownTime&&(null==pv_viewer._mouseHandler._lastMouseDownTime||pv_viewer._mouseHandler._lastMouseUpTime<pv_viewer._mouseHandler._lastMouseDownTime)||(e=pv_viewer.boundingClientRect(),e=pv_viewer.pick({x:t.clientX-e.left,y:t.clientY-e.top}),null!==prevPicked&&null!==e&&e.target()===prevPicked.atom?"click"==t.type&&("_"!=(n=(t=prevPicked.atom).qualifiedName().split("."))[0].charAt(0)&&t.residue()._isAminoacid&&$("body").trigger("selectResidue",{src:"structure",struc_id:e.object().geom.name(),chain:n[0],resno:t.residue().num()}),pv_viewer.fitTo(t.residue())):(null!==prevPicked&&setColorForAtom(prevPicked.node,prevPicked.atom,prevPicked.color),null!==e?"_"!==(t=(n=e.target()).qualifiedName().split("."))[0].charAt(0)&&n.residue()._isAminoacid?(a=[0,0,0,0],e.node().getColorForAtom(n,a),prevPicked={atom:n,color:a,node:e.node()},setColorForAtom(e.node(),n,"red"),a=e.object().geom.name(),a=n.residue().name()+" "+(i=n.residue().num())+" "+t[0]+resAnnoLabel(a,t[0],i),document.getElementById("pv_status").innerHTML=a,$("body").trigger("highlightResidue",{src:"structure",struc_id:e.object().geom.name(),chain:t[0],resno:n.residue().num()})):document.getElementById("pv_status").innerHTML=n.residue().name()+" "+n.residue().num():(document.getElementById("pv_status").innerHTML="",prevPicked=null),pv_viewer.requestRedraw()))}function highlightResiduesPV(t,n,e,i){i||pv_viewer.rm("*_res");i=pv_viewer.get(e);if(null!=i){var a,i=i.structure();if(n)return a=null,a=n.length?i.select({cnames:t.split("")}).residueSelect(function(t){for(var e=0;e<n.length;e++)if(t.num()>=n[e][0]&&t.num()<=n[e][1])return!0;return!1}):i.select({cnames:t.split("")}).residueSelect(function(t){return t.num()==n}),pv_viewer.ballsAndSticks((e?e+"_":"")+"res",a),a;pv_viewer.fitTo(i.select({cnames:t.split("")})),pv_viewer.requestRedraw()}}function centerResRangePV(e,n,i,t,a,s){var r,t=pv_viewer.get(t);null!=t&&(r=null,r=1==e.length?t.structure().residueSelect(function(t){return s?t.num()==n&&t.chain().name()==e||t.num()==i&&t.chain().name()==s:a?(t.num()==n||t.num()==i)&&t.chain().name()==e:t.num()>=n&&t.num()<=i&&t.chain().name()==e}):t.structure().residueSelect(function(t){return a?(t.num()==n||t.num()==i)&&-1<e.indexOf(t.chain().name()):t.num()>=n&&t.num()<=i&&-1<e.indexOf(t.chain().name())}),pv_viewer.fitTo(r),pv_viewer.requestRedraw())}function centerOnLigandPV(n,t){var t=pv_viewer.get(t+".ligands");null!=t&&(t=(t=t.structure()).residueSelect(function(t){for(var e=0;e<n.length;e++)if(t.num()==n[e])return!0}),pv_viewer.fitTo(t),pv_viewer.requestRedraw())}function highlightLigandPV(s,t,e){pv_viewer.rm("*ligandContactsHL"),null!=pv_viewer.get(e+".ligands")&&s&&(t=pv_viewer.get(e).structure().residueSelect(function(t){var e=t.chain().name(),n=t.num(),i=s[e];if(i)for(var a=0;a<i.length;a++)if(n==i[a])return!0}),pv_viewer.lines(e+"ligandContactsHL",t),pv_viewer.requestRedraw())}function connectResiduesPV(n){if(pv_viewer.rm("connect.*"),n)for(let e=0;e<n.length;e++){var i,a,s,r=pv_viewer.customMesh("connect."+e+".line");let t=pv_viewer.get(n[e][0].struc_id);t&&(i=(t=t.structure()).atom(n[e][0].chain+"."+n[e][0].res_num+".CA"),a=t.atom(n[e][1].chain+"."+n[e][1].res_num+".CA"),i&&a&&(s=pv.vec3.clone(i.pos()),pv.vec3.add(s,s,a.pos()),pv.vec3.scale(s,s,.5),score=Math.min(1,2*n[e][2]),r.addTube(i.pos(),a.pos(),.1,{color:[.9,1-score,1-score]})))}pv_viewer.requestRedraw()}function changeRepPV(t){if("outline"==(t=t.match(/(cartoon|tube|trace|lines|outline|fog)/)?t:"cartoon"))jQuery.cookie("pv_outline",!pv_viewer.options("outline"),{expires:365,path:"/"}),pv_viewer.options("outline",!pv_viewer.options("outline"));else if("fog"==t)jQuery.cookie("pv_fog",!pv_viewer.options("fog"),{expires:365,path:"/"}),pv_viewer.options("fog",!pv_viewer.options("fog"));else if(t.match(/(cartoon|tube|trace|lines|ballAndStick)/)){$("#repBtnLbl").text(t.charAt(0).toUpperCase()+t.substring(1)),jQuery.cookie("defaultRepr",t,{expires:365,path:"/"});var n=[],i=[];pv_viewer.forEach(function(t){var e=t.name();e.match(/(ligand|dna|res|LigandBond|membrane|label|selected)/)||(n.push(e),i.push(t.structure()))});for(var e=0;e<n.length;e++)pv_viewer.rm(n[e]);for(e=0;e<i.length;e++){var a=n[e],s=i[e];switch(t){case"cartoon":pv_viewer.cartoon(a,s,{color:pv.color.uniform("white")});break;case"tube":pv_viewer.tube(a,s,{color:pv.color.uniform("white")});break;case"trace":pv_viewer.trace(a,s,{color:pv.color.uniform("white")});break;case"lines":pv_viewer.lines(a,s,{color:pv.color.uniform("white")});break;case"ballAndstick":pv_viewer.ballsAndSticks(a,s,{color:pv.color.uniform("white")})}}}}function normalize(t){var e=[],n=t[0],i=t[1],a=t[2],n=n*n+i*i+a*a;return 0<n&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e}function dot(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function cross(t,e){var n=[],i=t[0],a=t[1],t=t[2],s=e[0],r=e[1],e=e[2];return n[0]=a*e-t*r,n[1]=t*s-i*e,n[2]=i*r-a*s,n}function distance(t,e){var n=e[0]-t[0],i=e[1]-t[1],e=e[2]-t[2];return Math.sqrt(n*n+i*i+e*e)}function showMembrane(n,r){var o=membraneData[n];if(o){let t=null;if(0<$("#pv:visible",currentWin.document).length){if(!pv_viewer.get(n))return;if(t="pv",!r)return pv_viewer.hide(n+".membrane"),void pv_viewer.requestRedraw();if(pv_viewer.get(n+".membrane"))return pv_viewer.show(n+".membrane"),void pv_viewer.requestRedraw()}if(0<$("#ngl:visible",currentWin.document).length){if(t="ngl",!getNGLComponentByName(n))return;var l=getNGLComponentByName(n+".membrane");if(l)return void l.setVisibility(r);if(!r)return}let e=[0,1,0];1<=dot(o.axis,e)&&(e=[0,0,1]),plane_x=normalize(cross(o.axis,e)),plane_y=normalize(cross(o.axis,plane_x));var h=[],c=[];let i=[];"pv"==t?pv_viewer.get(n).structure().eachAtom(function(t){"CA"==t.name()&&i.push(t.pos())}):"ngl"==t&&getNGLComponentByName(n).structure.eachResidue(function(t){t.eachAtom(function(t){"CA"==t.atomname&&i.push([t.x,t.y,t.z])})});var u=[];let a="",s=1;var d=1.5,p=o.radius/2+24;for(let n=-p;n<p;n+=d)for(let e=-p;e<p;e+=d)if(!(distance(pos=[o.plane_one_center[0]+n*d*plane_x[0]+e*d*plane_y[0],o.plane_one_center[1]+n*d*plane_x[1]+e*d*plane_y[1],o.plane_one_center[2]+n*d*plane_x[2]+e*d*plane_y[2]],o.plane_one_center)>o.radius+8)){pos2=[o.plane_two_center[0]+n*d*plane_x[0]+e*d*plane_y[0],o.plane_two_center[1]+n*d*plane_x[1]+e*d*plane_y[1],o.plane_two_center[2]+n*d*plane_x[2]+e*d*plane_y[2]];let t=0;for(;t<i.length;)distance(pos,i[t])<5?h.push(i.splice(t,1)[0]):distance(pos2,i[t])<5?c.push(i.splice(t,1)[0]):t++;u.push([pos,pos2])}for(let i=0;i<u.length;i++){let n=h,t=0;do{let e=!1;var g=u[i][t++];for(let t=0;t<n.length;t++)if(distance(g,n[t])<5){e=!0;break}e||(a+="ATOM  "+("     "+s++).slice(-5)+"   -  MEM M   1    "+("        "+g[0].toFixed(3)).slice(-8)+("        "+g[1].toFixed(3)).slice(-8)+("        "+g[2].toFixed(3)).slice(-8)+"  1.00  0.00    \n"),n=c}while(t<2)}if(a+="END","pv"==t)pv_viewer.points(n+".membrane",pv.io.pdb(a),{color:pv.color.uniform("#8b8b8b"),pointSize:2}),o.viewTransform&&pv_viewer.setRotation(o.viewTransform);else if("ngl"==t){for(schemeId in NGL.ColormakerRegistry.userSchemes)-1<schemeId.indexOf(n+".membrane")&&NGL.ColormakerRegistry.removeScheme(schemeId);membraneData[n].viewTransform&&ngl_stage.viewerControls.orient(membraneData[n].viewTransform),schemeId=NGL.ColormakerRegistry.addScheme(function(t){this.atomColor=function(){return 9868950}},n+".membrane");l=new Blob([a],{type:"text/plain"});ngl_stage.loadFile(l,{ext:"pdb"}).then(function(t){t.setName(n+".membrane"),t.addRepresentation("point",{name:n+".membrane",pointSize:2,useTexture:!0,forceTransparent:!0,edgeBleach:.6,color:schemeId}),membraneData[n].viewTransform&&ngl_stage.viewerControls.spin([0,1,0],Math.PI),ngl_stage.autoView()})}}}function fetchBFactorsPV(i,t,a,s){let r=0,o=0;return t.eachChain(function(t){(chn=t.name()).match(/(_|-)/)||(chainMapping.structures[i]||(chainMapping.structures[i]={}),chainMapping.structures[i][chn]||(chainMapping.structures[i][chn]=[]),t.eachResidue(function(t){if(t._isAminoacid){let e=0,n=0;t.eachAtom(function(t){e+=t.tempFactor(),n++}),r+=e/n,o++,chainMapping.structures[i][chn][t.num()]||(chainMapping.structures[i][chn][t.num()]={}),s&&!chainMapping.structures[i].invalidMapping&&chainMapping.structures[i][chn][t.num()].resname&&residueProperties[chainMapping.structures[i][chn][t.num()].resname].triplet!=t.name()&&(chainMapping.structures[i].invalidMapping=!0),chainMapping.structures[i][chn][t.num()][a]=e/n}}))}),"bfactor"==a&&setBFactorRange(i),0<r?r/o:0}function fetchSecStrucPV(e,t){return t.eachResidue(function(t){(chn=t.chain().name()).match(/(_|-)/)||(chainMapping.structures[e]||(chainMapping.structures[e]={}),chainMapping.structures[e][chn]||(chainMapping.structures[e][chn]=[]),chainMapping.structures[e][chn][t.num()]||(chainMapping.structures[e][chn][t.num()]={}),chainMapping.structures[e][chn][t.num()].ss=t.ss())}),!0}function midpoint1d(t,e,n){return t+(e-t)*n}function midpoint3d(t,e,n){return[midpoint1d(t[0],e[0],n),midpoint1d(t[1],e[1],n),midpoint1d(t[2],e[2],n)]}function showWaterPV(){pv_viewer.ballsAndSticks("water",pv_viewer.get("template").structure().select({rnames:["HOH"]}))}function showWaterNGL(){log.console("showWaterNGL not implemented")}function showWater(){0<$("#pv:visible",currentWin.document).length&&showWaterPV(),0<$("#ngl:visible",currentWin.document).length&&showWaterNGL()}function toggleBond(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_bonds.getBondById(t,e).toggle(),deHighlightBond(t,e,!0))}function highlightBond(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&plip_bonds.getBondById(t,e).highlight()}function deHighlightBond(t,e,n){PLIP.AbstractViewer.isStructureEnabled(t)&&(null==n&&(n=!0),plip_bonds.getBondById(t,e).dehighlight(!0,n))}function highlightBonds(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_bonds.getBondsById(t,e).forEach(function(t){t.highlight(!1)}),plip_residues.redraw(t))}function deHighlightBonds(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_bonds.getBondsById(t,e).forEach(function(t){t.dehighlight(!1)}),plip_residues.redraw(t))}function clickBonds(t,e,n){toggleBonds(t,e,n),$("#plip_bonds_"+n).prop("checked")&&fitToBonds(t,e,n)}function toggleBonds(t,e,n){var n=$("#plip_bonds_"+n),i=n.prop("checked");n.prop("checked",!i),n.trigger("change")}function changeBondsCheckbox(t,e,n){var i=$("#plip_bonds_"+n),a=i.prop("checked");PLIP.AbstractViewer.isStructureEnabled(t)?(plip_bonds.getBondsById(t,e).forEach(function(t){a?t.show(!1):t.hide(!1),t.dehighlight(!1,!0)}),plip_residues.redraw(t),a&&plip_interactions_fit_bonds&&fitToBonds(t,e,n)):i.prop("checked",!1)}function showBonds(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_bonds.getBondsById(t,e).forEach(function(t){t.show(!1),t.dehighlight(!1,!0)}),plip_residues.redraw(t))}function hideBonds(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_bonds.getBondsById(t,e).forEach(function(t){t.hide(!1),t.dehighlight(!1,!0)}),plip_residues.redraw(t))}function fitToBond(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&plip_bonds.getBondById(t,e).fitView()}function fitToResidue(t,e,n){PLIP.AbstractViewer.isStructureEnabled(t)&&(residue=plip_residues.getResidue(t,e),n?(ligand=all_ligands.getLigandById(t,n),PLIP.AbstractViewer.fitView(t,[ligand],[residue])):PLIP.AbstractViewer.fitView(t,null,[residue]))}function fitToBonds(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&plip_bonds.fitViewBonds(t,e)}function showResidues(t,e,n){PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_residues.getResiduesByResId(t,e).forEach(function(t){t.show(!1)}),plip_residues.redraw(t))}function hideResidues(t,e,n){PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_residues.getResiduesByResId(t,e).forEach(function(t){t.hide(!1)}),plip_residues.redraw(t))}function showLigands(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&(all_ligands.getLigandsById(t,e).forEach(function(t){t.show(!1,!0)}),all_ligands.redraw(t))}function hideLigands(t,e){PLIP.AbstractViewer.isStructureEnabled(t)&&(all_ligands.getLigandsById(t,e).forEach(function(t){t.hide(!1,null,!0)}),all_ligands.redraw(t))}function togglePLIPLigandContacts(t,e,n){($("#togglePLIPLigandContacts_"+t).hasClass("glyphicon-chevron-down")?showPLIPLigandContacts:hidePLIPLigandContacts)(t,e,n)}function showPLIPLigandContacts(t,e,n){$("#PLIPligandContacts_"+t).show(100),setTimeout(function(){$("#togglePLIPLigandContacts_"+t).addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down")},100),void 0!==n&&(showBonds(e,n),fitToBonds(e,n))}function hidePLIPLigandContacts(t,e,n){$("#PLIPligandContacts_"+t).hide(100),setTimeout(function(){$("#togglePLIPLigandContacts_"+t).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up")},100),void 0!==n&&hideBonds(e,n)}document.getElementById("pv")&&(document.getElementById("pv").addEventListener("mousemove",function(t){doPVMouse(t)}),document.getElementById("pv").addEventListener("click",function(t){doPVMouse(t)})),PLIP.Bonds=function(){var i={};this.hasStruc=function(t){return t in i},this.removeStruc=function(t){t in i&&delete i[t]},this.addStruc=function(t){this.hasStruc(t)||(i[t]=[])},this.listStruc=function(){return Object.keys(i)},this.listVisible=function(t){if(this.hasStruc(t))return i[t].filter(function(t){return t.isVisible()});console.error("listVisible: no strucId "+t)},this.getBondById=function(t,e){if(t in i)return i[t].find(function(t){return t.id===e});console.error("getBondById: no strucId "+t),console.trace()},this.getBondsById=function(t,e){if(t in i)return i[t].filter(function(t){return e.includes(t.id)});console.error("getBondsById: no strucId "+t)},this.add=function(t){this.addStruc(t.strucId),i[t.strucId].push(t)};this.showAll=function(t){for(var e=i[t],n=0;n<e.length;n++)e[n].isVisible()||e[n].show(!1);plip_residues.redraw(t)},this.hideAll=function(t){for(var e=i[t],n=0;n<e.length;n++)e[n].isVisible()&&e[n].hide(!1);plip_residues.redraw(t)},this.fitViewBonds=function(t,e){var e=this.getBondsById(t,e),n=e.map(function(t){return t.ligand}).filter(function(t,e,n){return n.indexOf(t)==e}),e=e.map(function(t){return t.residue}).filter(function(t,e,n){return n.indexOf(t)==e});PLIP.AbstractViewer.fitView(t,n,e)},this.refresh=function(t){for(var e=0;e<i[t].length;e++)i[t][e].refresh()},this.refreshAll=function(){for(var t in i)PLIP.AbstractViewer.isStructureEnabled(t)&&this.refresh(t)}},PLIP.Bond=function(t,e,n,i,a,s,r,o,l){var h=!1,c=!1,u=void 0,d="LigandBond"+t,p=void 0,g="LigandBondHighlight"+t;this.show=function(t){null==t&&(t=!0),this.isVisible()?console.info("Bond already visible"):PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(this.draw(),void 0!==this.residue&&this.residue.show(!1),this.ligand.show(t),h=!0,t&&pv_viewer.requestRedraw())},this.hide=function(t){null==t&&(t=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&this.isVisible()&&(this.destroy(),h=!1,void 0!==this.residue&&this.residue.hide(!1),this.ligand.hide(t),t&&pv_viewer.requestRedraw())},this.draw=function(){null==this.coo3?PLIP.AbstractViewer.addBondLine(this.getBondMesh(),this.coo1,this.coo2,plip_bond_num_dash,plip_bond_radius,this.color,!0):(PLIP.AbstractViewer.addBondLine(this.getBondMesh(),this.coo1,this.coo3,plip_bond_num_dash,plip_bond_radius,this.color,!1),PLIP.AbstractViewer.addBondLine(this.getBondMesh(),this.coo2,this.coo3,plip_bond_num_dash,plip_bond_radius,this.color,!1),PLIP.AbstractViewer.addWaterCircle(this.getBondMesh(),this.coo3,2*plip_bond_radius,this.color,!0))},this.destroy=function(){u=PLIP.AbstractViewer.removeMesh(d)},this.refresh=function(){this.destroy(),this.isVisible()&&this.draw(),this.destroyHighlight(),this.isHighlighted()&&this.drawHighlight()},this.toggle=function(){this.isVisible()?this.hide():this.show()},this.isVisible=function(){return h},this.getBondMesh=function(){return u=null==u?PLIP.AbstractViewer.newBondMesh(d):u},this.highlight=function(t){null==t&&(t=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&!this.isHighlighted()&&(this.drawHighlight(),void 0!==this.residue&&this.residue.show(!1),this.ligand.show(t),c=!0)},this.drawHighlight=function(){null==this.coo3?PLIP.AbstractViewer.addBondLine(this.getBondMeshHighlight(),this.coo1,this.coo2,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!0):(PLIP.AbstractViewer.addBondLine(this.getBondMeshHighlight(),this.coo1,this.coo3,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!1),PLIP.AbstractViewer.addBondLine(this.getBondMeshHighlight(),this.coo2,this.coo3,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!1),PLIP.AbstractViewer.addWaterCircle(this.getBondMeshHighlight(),this.coo3,plip_bond_radius*plip_higlight_factor*2,this.color,!0))},this.destroyHighlight=function(){p=PLIP.AbstractViewer.removeMesh(g)},this.dehighlight=function(t){null==t&&(t=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&this.isHighlighted()&&this.isHighlighted()&&(this.destroyHighlight(),void 0!==this.residue&&this.residue.hide(!1),this.ligand.hide(t),c=!1,t&&pv_viewer.requestRedraw())},this.toggleHighlight=function(){this.isHighlighted()?this.dehighlight():this.highlight()},this.isHighlighted=function(){return c},this.getBondMeshHighlight=function(){return p=null==p?PLIP.AbstractViewer.newBondMesh(g):p},this.fitView=function(){PLIP.AbstractViewer.fitView(this.strucId,[this.ligand],[this.residue])},this.getLigand=function(){return this.ligand},this.residue=plip_residues.addResidue(e,o[0],o[1],o[2]),this.residue.addBond(this),this.id=t,this.strucId=e,this.ligand=n,this.coo1=i,this.coo2=a,this.coo3=s,this.color=r,l&&this.show()},PLIP.makeResidueId=function(t,e,n){return t+":"+e+n},PLIP.Residue=function(t,e,n,i){var a=0,s=[];this.show=function(t){null==t&&(t=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&0<++a&&t&&plip_residues.redraw(this.strucId)},this.hide=function(t,e){null==t&&(t=!0),null==e&&(e=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(e?a=Math.max(a-1,0):alert("Did not decrement counter! "+this.id+": "+a),0==a&&t&&plip_residues.redraw(this.strucId))},this.isVisible=function(){return 0<a},this.getOldResId=function(){return this.chain+this.position},this.addBond=function(t){s.push(t)},this.getBonds=function(){return s},this.strucId=t,this.id=PLIP.makeResidueId(e,n,i),this.chain=e,this.one_letter=n,this.position=i},PLIP.Residues=function(){var n={};this.hasStruc=function(t){return t in n},this.removeStruc=function(t){t in n&&delete n[t]},this.addStruc=function(t){this.hasStruc(t)||(n[t]=[])},this.listStruc=function(){return Object.keys(n)},this.getStruc=function(t){if(t in n)return n[t];void 0===t?console.error("StrucId is undefined"):console.error("No such strucId: '"+t+"'"),console.trace()},this.addResidue=function(t,e,n,i){this.addStruc(t);var a=PLIP.makeResidueId(e,n,i),a=this.getResidue(t,a);return void 0===a&&(a=new PLIP.Residue(t,e,n,i),this.getStruc(t).push(a)),a},this.getResidue=function(t,e){if(t in n)return this.getStruc(t).find(function(t){return t.id==e})},this.getResidueByOldResId=function(t,e){if(t in n)return this.getStruc(t).find(function(t){return t.getOldResId()==e})},this.getResiduesByResId=function(t,e){if(t in n)return n[t].filter(function(t){return e.includes(t.id)})},this.getVisibleResidues=function(t){return this.hasStruc(t)?this.getStruc(t).filter(function(t){return t.isVisible()}):[]},this.getVisibleResiduesResId=function(t){return this.getVisibleResidues(t).map(function(t){return t.getOldResId()})},this.redraw=function(t){highlightLigand(all_ligands.getVisibleLigandIds(t),this.getVisibleResiduesResId(t),t),pv_viewer.requestRedraw()},this.redrawAll=function(){for(var t in n)PLIP.AbstractViewer.isStructureEnabled(t)&&this.redraw(t)}},PLIP.Ligands=function(){var n={};this.hasStruc=function(t){return t in n},this.removeStruc=function(t){this.hasStruc(t)&&delete n[t]},this.addStruc=function(t){this.hasStruc(t)||(n[t]=[])},this.listStruc=function(){return Object.keys(n)},this.getStruc=function(t){if(this.hasStruc(t))return n[t];void 0===t?console.error("StrucId "+t+" is undefined"):console.error("No such strucId: '"+t+"'"),console.trace()},this.getLigandById=function(t,e){if(this.hasStruc(t))return n[t].find(function(t){return t.id===e});console.error("getLigandById: no strucId "+t),console.trace()},this.getLigandsById=function(t,e){if(this.hasStruc(t))return n[t].filter(function(t){return e.includes(t.id)});console.error("getLigandsById: no strucId "+t)},this.addLigand=function(t,e){this.addStruc(t);var n=this.getLigandById(t,e);return void 0===n&&(n=new PLIP.Ligand(t,e),this.getStruc(t).push(n)),n},this.getVisibleLigands=function(t){return this.hasStruc(t)?this.getStruc(t).filter(function(t){return t.isVisible()}):[]},this.getVisibleLigandIds=function(t){return this.getVisibleLigands(t).map(function(t){return t.getLigandId()})},this.redraw=function(t){highlightLigand(this.getVisibleLigandIds(t),plip_residues.getVisibleResiduesResId(t),t),pv_viewer.requestRedraw()},this.redrawAll=function(){for(var t in n)PLIP.AbstractViewer.isStructureEnabled(t)&&this.redraw(t)}},PLIP.Ligand=function(t,e){var i=0,a=[],n=[];this.show=function(t,e){null==t&&(t=!0),null==e&&(e=!1),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(i++,e&&a.forEach(function(t){t.show(!1)}),0<i&&t&&all_ligands.redraw(this.strucId))},this.hide=function(t,e,n){null==t&&(t=!0),null==n&&(n=!1),null==e&&(e=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(e?i=Math.max(i-1,0):alert("Did not decrement counter! "+this.id+": "+i),n&&a.forEach(function(t){t.hide(!1)}),0==i&&t&&all_ligands.redraw(this.strucId))},this.addResidue=function(t){-1==a.indexOf(t)&&a.push(t)},this.addBond=function(t){-1==n.indexOf(t)&&n.push(t)},this.isVisible=function(){return 0<i},this.getLigandId=function(){return this.id},this.getResidues=function(){return a},this.strucId=t,this.id=e,this.position=e},PLIP.AbstractViewerPV={newBondMesh:function(t){return pv_viewer.customMesh(t)},addWaterCircle:function(t,e,n,i,a){t.addSphere(e,n,{cap:!0,color:i})},addBondLine:function(t,e,n,i,a,s,r){for(var o=1;o<=i;o++)t.addTube(midpoint3d(e,n,(2*o-2)/(2*i-1)),midpoint3d(e,n,(2*o-1)/(2*i-1)),a,{cap:!0,color:s})},removeMesh:function(t){pv_viewer.rm(t)},fitView:function(t,i,e){var a,s;this.isStructureEnabled(t)&&(a=e.map(function(t){return void 0===t?null:t.chain}),s=e.map(function(t){return void 0===t?null:t.position}),a.length!=s.length&&console.error("queryResidue -Chains and -Positions array lengths don't match: "+a.length+" != "+s.length),e=pv_viewer.get(t).structure().residueSelect(function(t){var e=t.chain().name();if("_"===e){if(!i)return!1;if((ligand_positions=i.map(function(t){return t.position})).includes(t.num()))return!0}for(var n=0;n<a.length;n++)if(a[n]===e&&s[n]===t.num())return!0;return!1}),pv_viewer.fitTo(e),pv_viewer.requestRedraw())},isStructureEnabled:function(t){return!!pv_viewer.get(t)}},PLIP.AbstractViewerNGL={newBondMesh:function(t){return new NGL.Shape(t,{disableImpostor:!0})},addWaterCircle:function(t,e,n,i,a){t.addEllipsoid(e,i,n,[n,0,0],[0,n,0]),a&&ngl_stage.addComponentFromObject(t).addRepresentation("buffer")},addBondLine:function(t,e,n,i,a,s,r){for(var o=1;o<=i;o++)t.addCylinder(midpoint3d(e,n,(2*o-2)/(2*i-1)),midpoint3d(e,n,(2*o-1)/(2*i-1)),s,a);r&&ngl_stage.addComponentFromObject(t).addRepresentation("buffer")},removeMesh:function(t){removeNGLComponentByName(t)},fitView:function(t,e,n){if(this.isStructureEnabled(t)){var i="";if(e&&(i+="(("+(ligand_positions=e.map(function(t){return t.position})).join(" or ")+") and :_)"),void 0!==n[0]){var a,s={};for(a in n){var r,o=n[a];"-"!=(r=o.chain)&&(o=o.position,s[r]?s[r].push(o):s[r]=[o])}for(r in s)""!=i&&(i+=" or "),i+="(("+s[r].join(" or ")+") and :"+r+")"}getNGLComponentByName(t).autoView(i,1e3)}},isStructureEnabled:function(t){return!!getNGLComponentByName(t)}};var plip_interactions_fit_bonds=!0;function togglePlipInteractions(t,e,n){$("#togglePlipInteractions_"+t).hasClass("glyphicon-chevron-down")?($("#togglePlipInteractions_"+t).removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("#plipInteractions_"+t).show(),PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_interactions_fit_bonds=!1,$.when($("#plipInteractions_"+t+" input").each(function(t,e){$(e).prop("checked",!0).trigger("change")})).done(function(){fitToBonds(e,n)}),plip_interactions_fit_bonds=!0)):($("#togglePlipInteractions_"+t).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up"),$("#plipInteractions_"+t).hide(),$("#plipInteractions_"+t+" input").each(function(t,e){$(e).prop("checked",!1).trigger("change")}))}function changeLigandContacts4Checkbox(t,e,n,i){var i=$("#chainContacts4_"+i),a=i.prop("checked");PLIP.AbstractViewer.isStructureEnabled(t)?(plip_residues.getResiduesByResId(t,n).forEach(function(t){a?t.show(!1):t.hide(!1)}),n=all_ligands.getLigandById(t,e),a?n.show(!0,!1):n.hide(!0,null,!1),plip_residues.redraw(t)):i.prop("checked",!1)}function clickLigandContacts4Checkbox(t,e,n,i){PLIP.AbstractViewer.isStructureEnabled(t)&&($("#chainContacts4_"+i).each(function(t,e){$(e).prop("checked",!$(e).prop("checked")).trigger("change")}),$("#chainContacts4_"+i).prop("checked")&&PLIP.AbstractViewer.fitView(t,[all_ligands.getLigandById(t,e)],plip_residues.getResiduesByResId(t,n)))}function toggleResidueContacts(t,e,n){$("#toggleResidueContacts4_"+t).hasClass("glyphicon-chevron-down")?($("#toggleResidueContacts4_"+t).removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("#residueContacts4_"+t).show(),PLIP.AbstractViewer.isStructureEnabled(n)&&($("#residueContacts4_"+t+" input").each(function(t,e){$(e).prop("checked",!0).trigger("change")}),ligand=all_ligands.getLigandById(n,e),PLIP.AbstractViewer.fitView(n,[ligand],ligand.getResidues()))):($("#toggleResidueContacts4_"+t).removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"),$("#residueContacts4_"+t).hide(),PLIP.AbstractViewer.isStructureEnabled(n)&&$("#residueContacts4_"+t+" input").each(function(t,e){$(e).prop("checked",!1).trigger("change")})),updatecols()}function toggleLigandGroup(t,e,n){$("#toggleLigandGroup_"+t).hasClass("glyphicon-chevron-down")?($("#toggleLigandGroup_"+t).addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down"),$("#ligandGroup_"+t).show(),centerOnLigand(e,n)):($("#toggleLigandGroup_"+t).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up"),$("#ligandGroup_"+t+" .glyphicon-chevron-up").each(function(t,e){$(e).trigger("click")}),$("#ligandGroup_"+t).hide()),updatecols()}function toggleAllLigands(t){$("#toggleAllLink").hasClass("glyphicon-chevron-down")?($("#toggleAllLink,span[id^=toggleLigandGroup_]").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("div[id^=ligandGroup_]").show()):($("#toggleAllLink,span[id^=toggleLigandGroup_]").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"),$("div[id^=ligandGroup_]").hide())}function RGBColor(t){this.ok=!1,t=(t=(t="#"==t.charAt(0)?t.substr(1,6):t).replace(/ /g,"")).toLowerCase();var e,c={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(e in c)t==e&&(t=c[e]);for(var u=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(t){return[parseInt(t[1]),parseInt(t[2]),parseInt(t[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(t){return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(t){return[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16)]}}],n=0;n<u.length;n++){var i=u[n].re,a=u[n].process,i=i.exec(t);i&&(channels=a(i),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0)}this.r=this.r<0||isNaN(this.r)?0:255<this.r?255:this.r,this.g=this.g<0||isNaN(this.g)?0:255<this.g?255:this.g,this.b=this.b<0||isNaN(this.b)?0:255<this.b?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var t=this.r.toString(16),e=this.g.toString(16),n=this.b.toString(16);return"#"+(t=1==t.length?"0"+t:t)+(e=1==e.length?"0"+e:e)+(n=1==n.length?"0"+n:n)},this.getHelpXML=function(){for(var t,e=new Array,n=0;n<u.length;n++)for(var i=u[n].example,a=0;a<i.length;a++)e[e.length]=i[a];for(t in c)e[e.length]=t;var s=document.createElement("ul");s.setAttribute("id","rgbcolor-examples");for(n=0;n<e.length;n++)try{var r=document.createElement("li"),o=new RGBColor(e[n]),l=document.createElement("div"),h=(l.style.cssText="margin: 3px; border: 1px solid black; background:"+o.toHex()+"; color:"+o.toHex(),l.appendChild(document.createTextNode("test")),document.createTextNode(" "+e[n]+" -> "+o.toRGB()+" -> "+o.toHex()));r.appendChild(l),r.appendChild(h),s.appendChild(r)}catch(t){}return s}}!function(){this.canvg=function(t,e,n){if(null==t&&null==e&&null==n)for(var a=document.querySelectorAll("svg"),s=0;s<a.length;s++){var r=a[s],o=document.createElement("canvas"),l=(o.width=r.clientWidth,o.height=r.clientHeight,r.parentNode.insertBefore(o,r),r.parentNode.removeChild(r),document.createElement("div"));l.appendChild(r),canvg(o,l.innerHTML)}else{null!=(t="string"==typeof t?document.getElementById(t):t).svg&&t.svg.stop();n=function(t){var C={opts:t,FRAMERATE:30,MAX_VIRTUAL_PIXELS:3e4,log:function(t){}};1==C.opts.log&&"undefined"!=typeof console&&(C.log=function(t){console.log(t)});C.init=function(t){var e=0;C.UniqueId=function(){return"canvg"+ ++e},C.Definitions={},C.Styles={},C.StylesSpecificity={},C.Animations=[],C.Images=[],C.ctx=t,C.ViewPort=new function(){this.viewPorts=[],this.Clear=function(){this.viewPorts=[]},this.SetCurrent=function(t,e){this.viewPorts.push({width:t,height:e})},this.RemoveCurrent=function(){this.viewPorts.pop()},this.Current=function(){return this.viewPorts[this.viewPorts.length-1]},this.width=function(){return this.Current().width},this.height=function(){return this.Current().height},this.ComputeSize=function(t){return null!=t&&"number"==typeof t?t:"x"==t?this.width():"y"==t?this.height():Math.sqrt(Math.pow(this.width(),2)+Math.pow(this.height(),2))/Math.sqrt(2)}}},C.init(),C.ImagesLoaded=function(){for(var t=0;t<C.Images.length;t++)if(!C.Images[t].loaded)return!1;return!0},C.trim=function(t){return t.replace(/^\s+|\s+$/g,"")},C.compressSpaces=function(t){return t.replace(/[\s\r\t\n]+/gm," ")},C.ajax=function(t){var e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return e?(e.open("GET",t,!1),e.send(null),e.responseText):null},C.parseXml=function(t){var e,n;return"undefined"!=typeof Windows&&void 0!==Windows.Data&&void 0!==Windows.Data.Xml?(n=new Windows.Data.Xml.Dom.XmlDocument,(e=new Windows.Data.Xml.Dom.XmlLoadSettings).prohibitDtd=!1,n.loadXml(t,e),n):window.DOMParser?(new DOMParser).parseFromString(t,"text/xml"):(t=t.replace(/<!DOCTYPE svg[^>]*>/,""),(n=new ActiveXObject("Microsoft.XMLDOM")).async="false",n.loadXML(t),n)},C.Property=function(t,e){this.name=t,this.value=e},C.Property.prototype.getValue=function(){return this.value},C.Property.prototype.hasValue=function(){return null!=this.value&&""!==this.value},C.Property.prototype.numValue=function(){var t;return this.hasValue()?(t=parseFloat(this.value),(this.value+"").match(/%$/)&&(t/=100),t):0},C.Property.prototype.valueOrDefault=function(t){return this.hasValue()?this.value:t},C.Property.prototype.numValueOrDefault=function(t){return this.hasValue()?this.numValue():t},C.Property.prototype.addOpacity=function(t){var e,n=this.value;return null!=t.value&&""!=t.value&&"string"==typeof this.value&&(e=new RGBColor(this.value)).ok&&(n="rgba("+e.r+", "+e.g+", "+e.b+", "+t.numValue()+")"),new C.Property(this.name,n)},C.Property.prototype.getDefinition=function(){var t=this.value.match(/#([^\)'"]+)/);return t=(t=t&&t[1])||this.value,C.Definitions[t]},C.Property.prototype.isUrlDefinition=function(){return 0==this.value.indexOf("url(")},C.Property.prototype.getFillStyleDefinition=function(t,e){var n=this.getDefinition();return null!=n&&n.createGradient?n.createGradient(C.ctx,t,e):null!=n&&n.createPattern?(n.getHrefAttribute().hasValue()&&(e=n.attribute("patternTransform"),n=n.getHrefAttribute().getDefinition(),e.hasValue()&&(n.attribute("patternTransform",!0).value=e.value)),n.createPattern(C.ctx,t)):null},C.Property.prototype.getDPI=function(t){return 96},C.Property.prototype.getEM=function(t){var e=12,n=new C.Property("fontSize",C.Font.Parse(C.ctx.font).fontSize);return e=n.hasValue()?n.toPixels(t):e},C.Property.prototype.getUnits=function(){return(this.value+"").replace(/[0-9\.\-]/g,"")},C.Property.prototype.toPixels=function(t,e){var n;return this.hasValue()?(n=this.value+"").match(/em$/)?this.numValue()*this.getEM(t):n.match(/ex$/)?this.numValue()*this.getEM(t)/2:n.match(/px$/)?this.numValue():n.match(/pt$/)?this.numValue()*this.getDPI(t)*(1/72):n.match(/pc$/)?15*this.numValue():n.match(/cm$/)?this.numValue()*this.getDPI(t)/2.54:n.match(/mm$/)?this.numValue()*this.getDPI(t)/25.4:n.match(/in$/)?this.numValue()*this.getDPI(t):n.match(/%$/)?this.numValue()*C.ViewPort.ComputeSize(t):(n=this.numValue(),e&&n<1?n*C.ViewPort.ComputeSize(t):n):0},C.Property.prototype.toMilliseconds=function(){var t;return this.hasValue()?(t=this.value+"").match(/s$/)?1e3*this.numValue():(t.match(/ms$/),this.numValue()):0},C.Property.prototype.toRadians=function(){var t;return this.hasValue()?(t=this.value+"").match(/deg$/)?this.numValue()*(Math.PI/180):t.match(/grad$/)?this.numValue()*(Math.PI/200):t.match(/rad$/)?this.numValue():this.numValue()*(Math.PI/180):0};var e={baseline:"alphabetic","before-edge":"top","text-before-edge":"top",middle:"middle",central:"middle","after-edge":"bottom","text-after-edge":"bottom",ideographic:"ideographic",alphabetic:"alphabetic",hanging:"hanging",mathematical:"alphabetic"};return C.Property.prototype.toTextBaseline=function(){return this.hasValue()?e[this.value]:null},C.Font=new function(){this.Styles="normal|italic|oblique|inherit",this.Variants="normal|small-caps|inherit",this.Weights="normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900|inherit",this.CreateFont=function(t,e,n,i,a,s){s=null!=s?this.Parse(s):this.CreateFont("","","","","",C.ctx.font);return{fontFamily:a||s.fontFamily,fontSize:i||s.fontSize,fontStyle:t||s.fontStyle,fontWeight:n||s.fontWeight,fontVariant:e||s.fontVariant,toString:function(){return[this.fontStyle,this.fontVariant,this.fontWeight,this.fontSize,this.fontFamily].join(" ")}}};var r=this;this.Parse=function(t){for(var e={},n=C.trim(C.compressSpaces(t||"")).split(" "),i={fontSize:!1,fontStyle:!1,fontWeight:!1,fontVariant:!1},a="",s=0;s<n.length;s++)i.fontStyle||-1==r.Styles.indexOf(n[s])?i.fontVariant||-1==r.Variants.indexOf(n[s])?i.fontWeight||-1==r.Weights.indexOf(n[s])?i.fontSize?"inherit"!=n[s]&&(a+=n[s]):("inherit"!=n[s]&&(e.fontSize=n[s].split("/")[0]),i.fontStyle=i.fontVariant=i.fontWeight=i.fontSize=!0):("inherit"!=n[s]&&(e.fontWeight=n[s]),i.fontStyle=i.fontVariant=i.fontWeight=!0):("inherit"!=n[s]&&(e.fontVariant=n[s]),i.fontStyle=i.fontVariant=!0):("inherit"!=n[s]&&(e.fontStyle=n[s]),i.fontStyle=!0);return""!=a&&(e.fontFamily=a),e}},C.ToNumberArray=function(t){for(var e=C.trim(C.compressSpaces((t||"").replace(/,/g," "))).split(" "),n=0;n<e.length;n++)e[n]=parseFloat(e[n]);return e},C.Point=function(t,e){this.x=t,this.y=e},C.Point.prototype.angleTo=function(t){return Math.atan2(t.y-this.y,t.x-this.x)},C.Point.prototype.applyTransform=function(t){var e=this.x*t[0]+this.y*t[2]+t[4],t=this.x*t[1]+this.y*t[3]+t[5];this.x=e,this.y=t},C.CreatePoint=function(t){t=C.ToNumberArray(t);return new C.Point(t[0],t[1])},C.CreatePath=function(t){for(var e=C.ToNumberArray(t),n=[],i=0;i<e.length;i+=2)n.push(new C.Point(e[i],e[i+1]));return n},C.BoundingBox=function(t,e,n,a){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN,this.x=function(){return this.x1},this.y=function(){return this.y1},this.width=function(){return this.x2-this.x1},this.height=function(){return this.y2-this.y1},this.addPoint=function(t,e){null!=t&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=t,this.x2=t),t<this.x1&&(this.x1=t),t>this.x2&&(this.x2=t)),null!=e&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=e,this.y2=e),e<this.y1&&(this.y1=e),e>this.y2&&(this.y2=e))},this.addX=function(t){this.addPoint(t,null)},this.addY=function(t){this.addPoint(null,t)},this.addBoundingBox=function(t){this.addPoint(t.x1,t.y1),this.addPoint(t.x2,t.y2)},this.addQuadraticCurve=function(t,e,n,i,a,s){n=t+2/3*(n-t),i=e+2/3*(i-e);this.addBezierCurve(t,e,n,n+1/3*(a-t),i,i+1/3*(s-e),a,s)},this.addBezierCurve=function(t,e,n,a,s,r,o,l){var h=[t,e],c=[n,a],u=[s,r],d=[o,l];for(this.addPoint(h[0],h[1]),this.addPoint(d[0],d[1]),i=0;i<=1;i++){function p(t){return Math.pow(1-t,3)*h[i]+3*Math.pow(1-t,2)*t*c[i]+3*(1-t)*Math.pow(t,2)*u[i]+Math.pow(t,3)*d[i]}var g,f=6*h[i]-12*c[i]+6*u[i],m=-3*h[i]+9*c[i]-9*u[i]+3*d[i],v=3*c[i]-3*h[i];0==m?0==f||0<(g=-v/f)&&g<1&&(0==i&&this.addX(p(g)),1==i&&this.addY(p(g))):(g=Math.pow(f,2)-4*v*m)<0||(0<(v=(-f+Math.sqrt(g))/(2*m))&&v<1&&(0==i&&this.addX(p(v)),1==i&&this.addY(p(v))),0<(v=(-f-Math.sqrt(g))/(2*m))&&v<1&&(0==i&&this.addX(p(v)),1==i&&this.addY(p(v))))}},this.isPointInBox=function(t,e){return this.x1<=t&&t<=this.x2&&this.y1<=e&&e<=this.y2},this.addPoint(t,e),this.addPoint(n,a)},C.Transform=function(t){for(var e=this,n=(this.Type={},this.Type.translate=function(t){this.p=C.CreatePoint(t),this.apply=function(t){t.translate(this.p.x||0,this.p.y||0)},this.unapply=function(t){t.translate(-1*this.p.x||0,-1*this.p.y||0)},this.applyToPoint=function(t){t.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0])}},this.Type.rotate=function(t){t=C.ToNumberArray(t);this.angle=new C.Property("angle",t[0]),this.cx=t[1]||0,this.cy=t[2]||0,this.apply=function(t){t.translate(this.cx,this.cy),t.rotate(this.angle.toRadians()),t.translate(-this.cx,-this.cy)},this.unapply=function(t){t.translate(this.cx,this.cy),t.rotate(-1*this.angle.toRadians()),t.translate(-this.cx,-this.cy)},this.applyToPoint=function(t){var e=this.angle.toRadians();t.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0]),t.applyTransform([Math.cos(e),Math.sin(e),-Math.sin(e),Math.cos(e),0,0]),t.applyTransform([1,0,0,1,-this.p.x||0,-this.p.y||0])}},this.Type.scale=function(t){this.p=C.CreatePoint(t),this.apply=function(t){t.scale(this.p.x||1,this.p.y||this.p.x||1)},this.unapply=function(t){t.scale(1/this.p.x||1,1/this.p.y||this.p.x||1)},this.applyToPoint=function(t){t.applyTransform([this.p.x||0,0,0,this.p.y||0,0,0])}},this.Type.matrix=function(t){this.m=C.ToNumberArray(t),this.apply=function(t){t.transform(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5])},this.unapply=function(t){var e=this.m[0],n=this.m[2],i=this.m[4],a=this.m[1],s=this.m[3],r=this.m[5],o=1/(e*(+s-0*r)-n*(+a-0*r)+i*(0*a-0*s));t.transform(o*(+s-0*r),o*(0*r-+a),o*(0*i-+n),o*(+e-0*i),o*(n*r-i*s),o*(i*a-e*r))},this.applyToPoint=function(t){t.applyTransform(this.m)}},this.Type.SkewBase=function(t){this.base=e.Type.matrix,this.base(t),this.angle=new C.Property("angle",t)},this.Type.SkewBase.prototype=new this.Type.matrix,this.Type.skewX=function(t){this.base=e.Type.SkewBase,this.base(t),this.m=[1,0,Math.tan(this.angle.toRadians()),1,0,0]},this.Type.skewX.prototype=new this.Type.SkewBase,this.Type.skewY=function(t){this.base=e.Type.SkewBase,this.base(t),this.m=[1,Math.tan(this.angle.toRadians()),0,1,0,0]},this.Type.skewY.prototype=new this.Type.SkewBase,this.transforms=[],this.apply=function(t){for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(t)},this.unapply=function(t){for(var e=this.transforms.length-1;0<=e;e--)this.transforms[e].unapply(t)},this.applyToPoint=function(t){for(var e=0;e<this.transforms.length;e++)this.transforms[e].applyToPoint(t)},C.trim(C.compressSpaces(t)).replace(/\)([a-zA-Z])/g,") $1").replace(/\)(\s?,\s?)/g,") ").split(/\s(?=[a-z])/)),i=0;i<n.length;i++){var a=C.trim(n[i].split("(")[0]),s=n[i].split("(")[1].replace(")",""),s=new this.Type[a](s);s.type=a,this.transforms.push(s)}},C.AspectRatio=function(t,e,n,i,a,s,r,o,l,h){var c=(e=(e=C.compressSpaces(e)).replace(/^defer\s/,"")).split(" ")[0]||"xMidYMid",e=e.split(" ")[1]||"meet",u=n/i,d=a/s,p=Math.min(u,d),g=Math.max(u,d);"meet"==e&&(i*=p,s*=p),"slice"==e&&(i*=g,s*=g),l=new C.Property("refX",l),h=new C.Property("refY",h),l.hasValue()&&h.hasValue()?t.translate(-p*l.toPixels("x"),-p*h.toPixels("y")):(c.match(/^xMid/)&&("meet"==e&&p==d||"slice"==e&&g==d)&&t.translate(n/2-i/2,0),c.match(/YMid$/)&&("meet"==e&&p==u||"slice"==e&&g==u)&&t.translate(0,a/2-s/2),c.match(/^xMax/)&&("meet"==e&&p==d||"slice"==e&&g==d)&&t.translate(n-i,0),c.match(/YMax$/)&&("meet"==e&&p==u||"slice"==e&&g==u)&&t.translate(0,a-s)),"none"==c?t.scale(u,d):"meet"==e?t.scale(p,p):"slice"==e&&t.scale(g,g),t.translate(null==r?0:-r,null==o?0:-o)},C.Element={},C.EmptyProperty=new C.Property("EMPTY",""),C.Element.ElementBase=function(s){if(this.attributes={},this.styles={},this.stylesSpecificity={},this.children=[],this.attribute=function(t,e){var n=this.attributes[t];return null!=n?n:(1==e&&(n=new C.Property(t,""),this.attributes[t]=n),n||C.EmptyProperty)},this.getHrefAttribute=function(){for(var t in this.attributes)if("href"==t||t.match(/:href$/))return this.attributes[t];return C.EmptyProperty},this.style=function(t,e,n){var i=this.styles[t];if(null!=i)return i;var a=this.attribute(t);if(null!=a&&a.hasValue())return this.styles[t]=a;if(1!=n){a=this.parent;if(null!=a){n=a.style(t);if(null!=n&&n.hasValue())return n}}return 1==e&&(i=new C.Property(t,""),this.styles[t]=i),i||C.EmptyProperty},this.render=function(t){var e;"none"!=this.style("display").value&&"hidden"!=this.style("visibility").value&&(t.save(),this.attribute("mask").hasValue()?null!=(e=this.attribute("mask").getDefinition())&&e.apply(t,this):this.style("filter").hasValue()?null!=(e=this.style("filter").getDefinition())&&e.apply(t,this):(this.setContext(t),this.renderChildren(t),this.clearContext(t)),t.restore())},this.setContext=function(t){},this.clearContext=function(t){},this.renderChildren=function(t){for(var e=0;e<this.children.length;e++)this.children[e].render(t)},this.addChild=function(t,e){var n=t;(n=e?C.CreateElement(t):n).parent=this,"title"!=n.type&&this.children.push(n)},this.addStylesFromStyleDefinition=function(){for(var t in C.Styles)if("@"!=t[0]&&h(s,t)){var e=C.Styles[t],n=C.StylesSpecificity[t];if(null!=e)for(var i in e){var a=this.stylesSpecificity[i];(a=void 0===a?"000":a)<n&&(this.styles[i]=e[i],this.stylesSpecificity[i]=n)}}},null!=s&&1==s.nodeType){for(var t=0;t<s.attributes.length;t++){var e=s.attributes[t];this.attributes[e.nodeName]=new C.Property(e.nodeName,e.value)}if(this.addStylesFromStyleDefinition(),this.attribute("style").hasValue())for(var n,i,a=this.attribute("style").value.split(";"),t=0;t<a.length;t++)""!=C.trim(a[t])&&(i=a[t].split(":"),n=C.trim(i[0]),i=C.trim(i[1]),this.styles[n]=new C.Property(n,i));this.attribute("id").hasValue()&&null==C.Definitions[this.attribute("id").value]&&(C.Definitions[this.attribute("id").value]=this);for(t=0;t<s.childNodes.length;t++){var r,o=s.childNodes[t];1==o.nodeType&&this.addChild(o,!0),!this.captureTextNodes||3!=o.nodeType&&4!=o.nodeType||(r=o.value||o.text||o.textContent||"",""!=C.compressSpaces(r)&&this.addChild(new C.Element.tspan(o),!1))}}},C.Element.RenderedElementBase=function(t){this.base=C.Element.ElementBase,this.base(t),this.setContext=function(t){var e,n,i;this.style("fill").isUrlDefinition()?null!=(e=this.style("fill").getFillStyleDefinition(this,this.style("fill-opacity")))&&(t.fillStyle=e):this.style("fill").hasValue()&&("currentColor"==(i=this.style("fill")).value&&(i.value=this.style("color").value),"inherit"!=i.value&&(t.fillStyle="none"==i.value?"rgba(0,0,0,0)":i.value)),this.style("fill-opacity").hasValue()&&(i=(i=new C.Property("fill",t.fillStyle)).addOpacity(this.style("fill-opacity")),t.fillStyle=i.value),this.style("stroke").isUrlDefinition()?null!=(e=this.style("stroke").getFillStyleDefinition(this,this.style("stroke-opacity")))&&(t.strokeStyle=e):this.style("stroke").hasValue()&&("currentColor"==(n=this.style("stroke")).value&&(n.value=this.style("color").value),"inherit"!=n.value&&(t.strokeStyle="none"==n.value?"rgba(0,0,0,0)":n.value)),this.style("stroke-opacity").hasValue()&&(n=(n=new C.Property("stroke",t.strokeStyle)).addOpacity(this.style("stroke-opacity")),t.strokeStyle=n.value),this.style("stroke-width").hasValue()&&(i=this.style("stroke-width").toPixels(),t.lineWidth=0==i?.001:i),this.style("stroke-linecap").hasValue()&&(t.lineCap=this.style("stroke-linecap").value),this.style("stroke-linejoin").hasValue()&&(t.lineJoin=this.style("stroke-linejoin").value),this.style("stroke-miterlimit").hasValue()&&(t.miterLimit=this.style("stroke-miterlimit").value),this.style("stroke-dasharray").hasValue()&&"none"!=this.style("stroke-dasharray").value&&(e=C.ToNumberArray(this.style("stroke-dasharray").value),void 0!==t.setLineDash?t.setLineDash(e):void 0!==t.webkitLineDash?t.webkitLineDash=e:void 0===t.mozDash||1==e.length&&0==e[0]||(t.mozDash=e),n=this.style("stroke-dashoffset").numValueOrDefault(1),void 0!==t.lineDashOffset?t.lineDashOffset=n:void 0!==t.webkitLineDashOffset?t.webkitLineDashOffset=n:void 0!==t.mozDashOffset&&(t.mozDashOffset=n)),void 0!==t.font&&(t.font=C.Font.CreateFont(this.style("font-style").value,this.style("font-variant").value,this.style("font-weight").value,this.style("font-size").hasValue()?this.style("font-size").toPixels()+"px":"",this.style("font-family").value).toString()),this.style("transform",!1,!0).hasValue()&&new C.Transform(this.style("transform",!1,!0).value).apply(t),this.attribute("clip-path",!1,!0).hasValue()&&null!=(i=this.attribute("clip-path",!1,!0).getDefinition())&&i.apply(t),this.style("opacity").hasValue()&&(t.globalAlpha=this.style("opacity").numValue())}},C.Element.RenderedElementBase.prototype=new C.Element.ElementBase,C.Element.PathElementBase=function(t){this.base=C.Element.RenderedElementBase,this.base(t),this.path=function(t){return null!=t&&t.beginPath(),new C.BoundingBox},this.renderChildren=function(t){this.path(t),C.Mouse.checkPath(this,t),""!=t.fillStyle&&("inherit"!=this.style("fill-rule").valueOrDefault("inherit")?t.fill(this.style("fill-rule").value):t.fill()),""!=t.strokeStyle&&t.stroke();var e=this.getMarkers();if(null!=e){if(this.style("marker-start").isUrlDefinition()&&(n=this.style("marker-start").getDefinition()).render(t,e[0][0],e[0][1]),this.style("marker-mid").isUrlDefinition())for(var n=this.style("marker-mid").getDefinition(),i=1;i<e.length-1;i++)n.render(t,e[i][0],e[i][1]);this.style("marker-end").isUrlDefinition()&&(n=this.style("marker-end").getDefinition()).render(t,e[e.length-1][0],e[e.length-1][1])}},this.getBoundingBox=function(){return this.path()},this.getMarkers=function(){return null}},C.Element.PathElementBase.prototype=new C.Element.RenderedElementBase,C.Element.svg=function(t){this.base=C.Element.RenderedElementBase,this.base(t),this.baseClearContext=this.clearContext,this.clearContext=function(t){this.baseClearContext(t),C.ViewPort.RemoveCurrent()},this.baseSetContext=this.setContext,this.setContext=function(t){t.strokeStyle="rgba(0,0,0,0)",t.lineCap="butt",t.lineJoin="miter",t.miterLimit=4,void 0!==t.font&&void 0!==window.getComputedStyle&&(t.font=window.getComputedStyle(t.canvas).getPropertyValue("font")),this.baseSetContext(t),this.attribute("x").hasValue()||(this.attribute("x",!0).value=0),this.attribute("y").hasValue()||(this.attribute("y",!0).value=0),t.translate(this.attribute("x").toPixels("x"),this.attribute("y").toPixels("y"));var e,n,i,a=C.ViewPort.width(),s=C.ViewPort.height();this.attribute("width").hasValue()||(this.attribute("width",!0).value="100%"),this.attribute("height").hasValue()||(this.attribute("height",!0).value="100%"),void 0===this.root&&(a=this.attribute("width").toPixels("x"),s=this.attribute("height").toPixels("y"),e=n=0,this.attribute("refX").hasValue()&&this.attribute("refY").hasValue()&&(n=-this.attribute("refX").toPixels("x"),e=-this.attribute("refY").toPixels("y")),"visible"!=this.attribute("overflow").valueOrDefault("hidden")&&(t.beginPath(),t.moveTo(n,e),t.lineTo(a,e),t.lineTo(a,s),t.lineTo(n,s),t.closePath(),t.clip())),C.ViewPort.SetCurrent(a,s),this.attribute("viewBox").hasValue()&&(n=(e=C.ToNumberArray(this.attribute("viewBox").value))[0],i=e[1],a=e[2],s=e[3],C.AspectRatio(t,this.attribute("preserveAspectRatio").value,C.ViewPort.width(),a,C.ViewPort.height(),s,n,i,this.attribute("refX").value,this.attribute("refY").value),C.ViewPort.RemoveCurrent(),C.ViewPort.SetCurrent(e[2],e[3]))}},C.Element.svg.prototype=new C.Element.RenderedElementBase,C.Element.rect=function(t){this.base=C.Element.PathElementBase,this.base(t),this.path=function(t){var e=this.attribute("x").toPixels("x"),n=this.attribute("y").toPixels("y"),i=this.attribute("width").toPixels("x"),a=this.attribute("height").toPixels("y"),s=this.attribute("rx").toPixels("x"),r=this.attribute("ry").toPixels("y");return this.attribute("rx").hasValue()&&!this.attribute("ry").hasValue()&&(r=s),this.attribute("ry").hasValue()&&!this.attribute("rx").hasValue()&&(s=r),s=Math.min(s,i/2),r=Math.min(r,a/2),null!=t&&(t.beginPath(),t.moveTo(e+s,n),t.lineTo(e+i-s,n),t.quadraticCurveTo(e+i,n,e+i,n+r),t.lineTo(e+i,n+a-r),t.quadraticCurveTo(e+i,n+a,e+i-s,n+a),t.lineTo(e+s,n+a),t.quadraticCurveTo(e,n+a,e,n+a-r),t.lineTo(e,n+r),t.quadraticCurveTo(e,n,e+s,n),t.closePath()),new C.BoundingBox(e,n,e+i,n+a)}},C.Element.rect.prototype=new C.Element.PathElementBase,C.Element.circle=function(t){this.base=C.Element.PathElementBase,this.base(t),this.path=function(t){var e=this.attribute("cx").toPixels("x"),n=this.attribute("cy").toPixels("y"),i=this.attribute("r").toPixels();return null!=t&&(t.beginPath(),t.arc(e,n,i,0,2*Math.PI,!0),t.closePath()),new C.BoundingBox(e-i,n-i,e+i,n+i)}},C.Element.circle.prototype=new C.Element.PathElementBase,C.Element.ellipse=function(t){this.base=C.Element.PathElementBase,this.base(t),this.path=function(t){var e=(Math.sqrt(2)-1)/3*4,n=this.attribute("rx").toPixels("x"),i=this.attribute("ry").toPixels("y"),a=this.attribute("cx").toPixels("x"),s=this.attribute("cy").toPixels("y");return null!=t&&(t.beginPath(),t.moveTo(a,s-i),t.bezierCurveTo(a+e*n,s-i,a+n,s-e*i,a+n,s),t.bezierCurveTo(a+n,s+e*i,a+e*n,s+i,a,s+i),t.bezierCurveTo(a-e*n,s+i,a-n,s+e*i,a-n,s),t.bezierCurveTo(a-n,s-e*i,a-e*n,s-i,a,s-i),t.closePath()),new C.BoundingBox(a-n,s-i,a+n,s+i)}},C.Element.ellipse.prototype=new C.Element.PathElementBase,C.Element.line=function(t){this.base=C.Element.PathElementBase,this.base(t),this.getPoints=function(){return[new C.Point(this.attribute("x1").toPixels("x"),this.attribute("y1").toPixels("y")),new C.Point(this.attribute("x2").toPixels("x"),this.attribute("y2").toPixels("y"))]},this.path=function(t){var e=this.getPoints();return null!=t&&(t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y)),new C.BoundingBox(e[0].x,e[0].y,e[1].x,e[1].y)},this.getMarkers=function(){var t=this.getPoints(),e=t[0].angleTo(t[1]);return[[t[0],e],[t[1],e]]}},C.Element.line.prototype=new C.Element.PathElementBase,C.Element.polyline=function(t){this.base=C.Element.PathElementBase,this.base(t),this.points=C.CreatePath(this.attribute("points").value),this.path=function(t){var e=new C.BoundingBox(this.points[0].x,this.points[0].y);null!=t&&(t.beginPath(),t.moveTo(this.points[0].x,this.points[0].y));for(var n=1;n<this.points.length;n++)e.addPoint(this.points[n].x,this.points[n].y),null!=t&&t.lineTo(this.points[n].x,this.points[n].y);return e},this.getMarkers=function(){for(var t=[],e=0;e<this.points.length-1;e++)t.push([this.points[e],this.points[e].angleTo(this.points[e+1])]);return t.push([this.points[this.points.length-1],t[t.length-1][1]]),t}},C.Element.polyline.prototype=new C.Element.PathElementBase,C.Element.polygon=function(t){this.base=C.Element.polyline,this.base(t),this.basePath=this.path,this.path=function(t){var e=this.basePath(t);return null!=t&&(t.lineTo(this.points[0].x,this.points[0].y),t.closePath()),e}},C.Element.polygon.prototype=new C.Element.polyline,C.Element.path=function(t){this.base=C.Element.PathElementBase,this.base(t);for(var e=(e=this.attribute("d").value).replace(/,/gm," "),n=0;n<2;n++)e=e.replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2");e=(e=e.replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([0-9])([+\-])/gm,"$1 $2");for(n=0;n<2;n++)e=e.replace(/(\.[0-9]*)(\.)/gm,"$1 $2");e=e.replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 "),e=C.compressSpaces(e),e=C.trim(e),this.PathParser=new function(t){this.tokens=t.split(" "),this.reset=function(){this.i=-1,this.command="",this.previousCommand="",this.start=new C.Point(0,0),this.control=new C.Point(0,0),this.current=new C.Point(0,0),this.points=[],this.angles=[]},this.isEnd=function(){return this.i>=this.tokens.length-1},this.isCommandOrEnd=function(){return!!this.isEnd()||null!=this.tokens[this.i+1].match(/^[A-Za-z]$/)},this.isRelativeCommand=function(){switch(this.command){case"m":case"l":case"h":case"v":case"c":case"s":case"q":case"t":case"a":case"z":return!0}return!1},this.getToken=function(){return this.i++,this.tokens[this.i]},this.getScalar=function(){return parseFloat(this.getToken())},this.nextCommand=function(){this.previousCommand=this.command,this.command=this.getToken()},this.getPoint=function(){var t=new C.Point(this.getScalar(),this.getScalar());return this.makeAbsolute(t)},this.getAsControlPoint=function(){var t=this.getPoint();return this.control=t},this.getAsCurrentPoint=function(){var t=this.getPoint();return this.current=t},this.getReflectedControlPoint=function(){return"c"!=this.previousCommand.toLowerCase()&&"s"!=this.previousCommand.toLowerCase()&&"q"!=this.previousCommand.toLowerCase()&&"t"!=this.previousCommand.toLowerCase()?this.current:new C.Point(2*this.current.x-this.control.x,2*this.current.y-this.control.y)},this.makeAbsolute=function(t){return this.isRelativeCommand()&&(t.x+=this.current.x,t.y+=this.current.y),t},this.addMarker=function(t,e,n){null!=n&&0<this.angles.length&&null==this.angles[this.angles.length-1]&&(this.angles[this.angles.length-1]=this.points[this.points.length-1].angleTo(n)),this.addMarkerAngle(t,null==e?null:e.angleTo(t))},this.addMarkerAngle=function(t,e){this.points.push(t),this.angles.push(e)},this.getMarkerPoints=function(){return this.points},this.getMarkerAngles=function(){for(var t=0;t<this.angles.length;t++)if(null==this.angles[t])for(var e=t+1;e<this.angles.length;e++)if(null!=this.angles[e]){this.angles[t]=this.angles[e];break}return this.angles}}(e),this.path=function(t){var e=this.PathParser,n=(e.reset(),new C.BoundingBox);for(null!=t&&t.beginPath();!e.isEnd();)switch(e.nextCommand(),e.command){case"M":case"m":var i=e.getAsCurrentPoint();for(e.addMarker(i),n.addPoint(i.x,i.y),null!=t&&t.moveTo(i.x,i.y),e.start=e.current;!e.isCommandOrEnd();){i=e.getAsCurrentPoint();e.addMarker(i,e.start),n.addPoint(i.x,i.y),null!=t&&t.lineTo(i.x,i.y)}break;case"L":case"l":for(;!e.isCommandOrEnd();){var a=e.current,i=e.getAsCurrentPoint();e.addMarker(i,a),n.addPoint(i.x,i.y),null!=t&&t.lineTo(i.x,i.y)}break;case"H":case"h":for(;!e.isCommandOrEnd();){var s=new C.Point((e.isRelativeCommand()?e.current.x:0)+e.getScalar(),e.current.y);e.addMarker(s,e.current),e.current=s,n.addPoint(e.current.x,e.current.y),null!=t&&t.lineTo(e.current.x,e.current.y)}break;case"V":case"v":for(;!e.isCommandOrEnd();){s=new C.Point(e.current.x,(e.isRelativeCommand()?e.current.y:0)+e.getScalar());e.addMarker(s,e.current),e.current=s,n.addPoint(e.current.x,e.current.y),null!=t&&t.lineTo(e.current.x,e.current.y)}break;case"C":case"c":for(;!e.isCommandOrEnd();){var r=e.current,o=e.getPoint(),l=e.getAsControlPoint(),h=e.getAsCurrentPoint();e.addMarker(h,l,o),n.addBezierCurve(r.x,r.y,o.x,o.y,l.x,l.y,h.x,h.y),null!=t&&t.bezierCurveTo(o.x,o.y,l.x,l.y,h.x,h.y)}break;case"S":case"s":for(;!e.isCommandOrEnd();){r=e.current,o=e.getReflectedControlPoint(),l=e.getAsControlPoint(),h=e.getAsCurrentPoint();e.addMarker(h,l,o),n.addBezierCurve(r.x,r.y,o.x,o.y,l.x,l.y,h.x,h.y),null!=t&&t.bezierCurveTo(o.x,o.y,l.x,l.y,h.x,h.y)}break;case"Q":case"q":for(;!e.isCommandOrEnd();){r=e.current,l=e.getAsControlPoint(),h=e.getAsCurrentPoint();e.addMarker(h,l,l),n.addQuadraticCurve(r.x,r.y,l.x,l.y,h.x,h.y),null!=t&&t.quadraticCurveTo(l.x,l.y,h.x,h.y)}break;case"T":case"t":for(;!e.isCommandOrEnd();){r=e.current,l=e.getReflectedControlPoint(),h=(e.control=l,e.getAsCurrentPoint());e.addMarker(h,l,l),n.addQuadraticCurve(r.x,r.y,l.x,l.y,h.x,h.y),null!=t&&t.quadraticCurveTo(l.x,l.y,h.x,h.y)}break;case"A":case"a":for(;!e.isCommandOrEnd();){function c(t,e){return(t[0]*e[1]<t[1]*e[0]?-1:1)*Math.acos(y(t,e))}var r=e.current,u=e.getScalar(),d=e.getScalar(),p=e.getScalar()*(Math.PI/180),g=e.getScalar(),f=e.getScalar(),h=e.getAsCurrentPoint(),m=new C.Point(Math.cos(p)*(r.x-h.x)/2+Math.sin(p)*(r.y-h.y)/2,-Math.sin(p)*(r.x-h.x)/2+Math.cos(p)*(r.y-h.y)/2),v=Math.pow(m.x,2)/Math.pow(u,2)+Math.pow(m.y,2)/Math.pow(d,2),v=(1<v&&(u*=Math.sqrt(v),d*=Math.sqrt(v)),(g==f?-1:1)*Math.sqrt((Math.pow(u,2)*Math.pow(d,2)-Math.pow(u,2)*Math.pow(m.y,2)-Math.pow(d,2)*Math.pow(m.x,2))/(Math.pow(u,2)*Math.pow(m.y,2)+Math.pow(d,2)*Math.pow(m.x,2)))),g=(isNaN(v)&&(v=0),new C.Point(v*u*m.y/d,v*-d*m.x/u)),v=new C.Point((r.x+h.x)/2+Math.cos(p)*g.x-Math.sin(p)*g.y,(r.y+h.y)/2+Math.sin(p)*g.x+Math.cos(p)*g.y),b=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2))},y=function(t,e){return(t[0]*e[0]+t[1]*e[1])/(b(t)*b(e))},w=c([1,0],[(m.x-g.x)/u,(m.y-g.y)/d]),_=[(m.x-g.x)/u,(m.y-g.y)/d],m=[(-m.x-g.x)/u,(-m.y-g.y)/d],g=c(_,m),x=(y(_,m)<=-1&&(g=Math.PI),1-f?1:-1),_=w+(g=1<=y(_,m)?0:g)/2*x,m=new C.Point(v.x+u*Math.cos(_),v.y+d*Math.sin(_));e.addMarkerAngle(m,_-x*Math.PI/2),e.addMarkerAngle(h,_-x*Math.PI),n.addPoint(h.x,h.y),null!=t&&(y=d<u?u:d,m=d<u?1:u/d,_=d<u?d/u:1,t.translate(v.x,v.y),t.rotate(p),t.scale(m,_),t.arc(0,0,y,w,w+g,1-f),t.scale(1/m,1/_),t.rotate(-p),t.translate(-v.x,-v.y))}break;case"Z":case"z":null!=t&&t.closePath(),e.current=e.start}return n},this.getMarkers=function(){for(var t=this.PathParser.getMarkerPoints(),e=this.PathParser.getMarkerAngles(),n=[],i=0;i<t.length;i++)n.push([t[i],e[i]]);return n}},C.Element.path.prototype=new C.Element.PathElementBase,C.Element.pattern=function(t){this.base=C.Element.ElementBase,this.base(t),this.createPattern=function(t,e){var n=this.attribute("width").toPixels("x",!0),i=this.attribute("height").toPixels("y",!0),a=new C.Element.svg,s=(a.attributes.viewBox=new C.Property("viewBox",this.attribute("viewBox").value),a.attributes.width=new C.Property("width",n+"px"),a.attributes.height=new C.Property("height",i+"px"),a.attributes.transform=new C.Property("transform",this.attribute("patternTransform").value),a.children=this.children,document.createElement("canvas")),r=(s.width=n,s.height=i,s.getContext("2d"));this.attribute("x").hasValue()&&this.attribute("y").hasValue()&&r.translate(this.attribute("x").toPixels("x",!0),this.attribute("y").toPixels("y",!0));for(var o=-1;o<=1;o++)for(var l=-1;l<=1;l++)r.save(),a.attributes.x=new C.Property("x",o*s.width),a.attributes.y=new C.Property("y",l*s.height),a.render(r),r.restore();return t.createPattern(s,"repeat")}},C.Element.pattern.prototype=new C.Element.ElementBase,C.Element.marker=function(t){this.base=C.Element.ElementBase,this.base(t),this.baseRender=this.render,this.render=function(t,e,n){t.translate(e.x,e.y),"auto"==this.attribute("orient").valueOrDefault("auto")&&t.rotate(n),"strokeWidth"==this.attribute("markerUnits").valueOrDefault("strokeWidth")&&t.scale(t.lineWidth,t.lineWidth),t.save();var i=new C.Element.svg;i.attributes.viewBox=new C.Property("viewBox",this.attribute("viewBox").value),i.attributes.refX=new C.Property("refX",this.attribute("refX").value),i.attributes.refY=new C.Property("refY",this.attribute("refY").value),i.attributes.width=new C.Property("width",this.attribute("markerWidth").value),i.attributes.height=new C.Property("height",this.attribute("markerHeight").value),i.attributes.fill=new C.Property("fill",this.attribute("fill").valueOrDefault("black")),i.attributes.stroke=new C.Property("stroke",this.attribute("stroke").valueOrDefault("none")),i.children=this.children,i.render(t),t.restore(),"strokeWidth"==this.attribute("markerUnits").valueOrDefault("strokeWidth")&&t.scale(1/t.lineWidth,1/t.lineWidth),"auto"==this.attribute("orient").valueOrDefault("auto")&&t.rotate(-n),t.translate(-e.x,-e.y)}},C.Element.marker.prototype=new C.Element.ElementBase,C.Element.defs=function(t){this.base=C.Element.ElementBase,this.base(t),this.render=function(t){}},C.Element.defs.prototype=new C.Element.ElementBase,C.Element.GradientBase=function(t){this.base=C.Element.ElementBase,this.base(t),this.stops=[];for(var e=0;e<this.children.length;e++){var n=this.children[e];"stop"==n.type&&this.stops.push(n)}this.getGradient=function(){},this.gradientUnits=function(){return this.attribute("gradientUnits").valueOrDefault("objectBoundingBox")},this.attributesToInherit=["gradientUnits"],this.inheritStopContainer=function(t){for(var e=0;e<this.attributesToInherit.length;e++){var n=this.attributesToInherit[e];!this.attribute(n).hasValue()&&t.attribute(n).hasValue()&&(this.attribute(n,!0).value=t.attribute(n).value)}},this.createGradient=function(t,e,n){function i(t){return n.hasValue()?new C.Property("color",t).addOpacity(n).value:t}var a=this,s=(this.getHrefAttribute().hasValue()&&(a=this.getHrefAttribute().getDefinition(),this.inheritStopContainer(a)),this.getGradient(t,e));if(null==s)return i(a.stops[a.stops.length-1].color);for(var r,o=0;o<a.stops.length;o++)s.addColorStop(a.stops[o].offset,i(a.stops[o].color));return this.attribute("gradientTransform").hasValue()?(t=C.ViewPort.viewPorts[0],(e=new C.Element.rect).attributes.x=new C.Property("x",-C.MAX_VIRTUAL_PIXELS/3),e.attributes.y=new C.Property("y",-C.MAX_VIRTUAL_PIXELS/3),e.attributes.width=new C.Property("width",C.MAX_VIRTUAL_PIXELS),e.attributes.height=new C.Property("height",C.MAX_VIRTUAL_PIXELS),(r=new C.Element.g).attributes.transform=new C.Property("transform",this.attribute("gradientTransform").value),r.children=[e],(e=new C.Element.svg).attributes.x=new C.Property("x",0),e.attributes.y=new C.Property("y",0),e.attributes.width=new C.Property("width",t.width),e.attributes.height=new C.Property("height",t.height),e.children=[r],(r=document.createElement("canvas")).width=t.width,r.height=t.height,(t=r.getContext("2d")).fillStyle=s,e.render(t),t.createPattern(r,"no-repeat")):s}},C.Element.GradientBase.prototype=new C.Element.ElementBase,C.Element.linearGradient=function(t){this.base=C.Element.GradientBase,this.base(t),this.attributesToInherit.push("x1"),this.attributesToInherit.push("y1"),this.attributesToInherit.push("x2"),this.attributesToInherit.push("y2"),this.getGradient=function(t,e){var e="objectBoundingBox"==this.gradientUnits()?e.getBoundingBox():null,n=(this.attribute("x1").hasValue()||this.attribute("y1").hasValue()||this.attribute("x2").hasValue()||this.attribute("y2").hasValue()||(this.attribute("x1",!0).value=0,this.attribute("y1",!0).value=0,this.attribute("x2",!0).value=1,this.attribute("y2",!0).value=0),"objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("x1").numValue():this.attribute("x1").toPixels("x")),i="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("y1").numValue():this.attribute("y1").toPixels("y"),a="objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("x2").numValue():this.attribute("x2").toPixels("x"),e="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("y2").numValue():this.attribute("y2").toPixels("y");return n==a&&i==e?null:t.createLinearGradient(n,i,a,e)}},C.Element.linearGradient.prototype=new C.Element.GradientBase,C.Element.radialGradient=function(t){this.base=C.Element.GradientBase,this.base(t),this.attributesToInherit.push("cx"),this.attributesToInherit.push("cy"),this.attributesToInherit.push("r"),this.attributesToInherit.push("fx"),this.attributesToInherit.push("fy"),this.getGradient=function(t,e){var e=e.getBoundingBox(),n=(this.attribute("cx").hasValue()||(this.attribute("cx",!0).value="50%"),this.attribute("cy").hasValue()||(this.attribute("cy",!0).value="50%"),this.attribute("r").hasValue()||(this.attribute("r",!0).value="50%"),"objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("cx").numValue():this.attribute("cx").toPixels("x")),i="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("cy").numValue():this.attribute("cy").toPixels("y"),a=n,s=i,e=(this.attribute("fx").hasValue()&&(a="objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("fx").numValue():this.attribute("fx").toPixels("x")),this.attribute("fy").hasValue()&&(s="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("fy").numValue():this.attribute("fy").toPixels("y")),"objectBoundingBox"==this.gradientUnits()?(e.width()+e.height())/2*this.attribute("r").numValue():this.attribute("r").toPixels());return t.createRadialGradient(a,s,0,n,i,e)}},C.Element.radialGradient.prototype=new C.Element.GradientBase,C.Element.stop=function(t){this.base=C.Element.ElementBase,this.base(t),this.offset=this.attribute("offset").numValue(),this.offset<0&&(this.offset=0),1<this.offset&&(this.offset=1);t=this.style("stop-color",!0);""===t.value&&(t.value="#000"),this.style("stop-opacity").hasValue()&&(t=t.addOpacity(this.style("stop-opacity"))),this.color=t.value},C.Element.stop.prototype=new C.Element.ElementBase,C.Element.AnimateBase=function(t){this.base=C.Element.ElementBase,this.base(t),C.Animations.push(this),this.duration=0,this.begin=this.attribute("begin").toMilliseconds(),this.maxDuration=this.begin+this.attribute("dur").toMilliseconds(),this.getProperty=function(){var t=this.attribute("attributeType").value,e=this.attribute("attributeName").value;return"CSS"==t?this.parent.style(e,!0):this.parent.attribute(e,!0)},this.initialValue=null,this.initialUnits="",this.removed=!1,this.calcValue=function(){return""},this.update=function(t){if(null==this.initialValue&&(this.initialValue=this.getProperty().value,this.initialUnits=this.getProperty().getUnits()),this.duration>this.maxDuration){if("indefinite"==this.attribute("repeatCount").value||"indefinite"==this.attribute("repeatDur").value)this.duration=0;else if("freeze"!=this.attribute("fill").valueOrDefault("remove")||this.frozen){if("remove"==this.attribute("fill").valueOrDefault("remove")&&!this.removed)return this.removed=!0,this.getProperty().value=this.parent.animationFrozen?this.parent.animationFrozenValue:this.initialValue,!0}else this.frozen=!0,this.parent.animationFrozen=!0,this.parent.animationFrozenValue=this.getProperty().value;return!1}this.duration=this.duration+t;var e,t=!1;return this.begin<this.duration&&(e=this.calcValue(),this.attribute("type").hasValue()&&(e=this.attribute("type").value+"("+e+")"),this.getProperty().value=e,t=!0),t},this.from=this.attribute("from"),this.to=this.attribute("to"),this.values=this.attribute("values"),this.values.hasValue()&&(this.values.value=this.values.value.split(";")),this.progress=function(){var t,e,n,i={progress:(this.duration-this.begin)/(this.maxDuration-this.begin)};return this.values.hasValue()?(t=i.progress*(this.values.value.length-1),e=Math.floor(t),n=Math.ceil(t),i.from=new C.Property("from",parseFloat(this.values.value[e])),i.to=new C.Property("to",parseFloat(this.values.value[n])),i.progress=(t-e)/(n-e)):(i.from=this.from,i.to=this.to),i}},C.Element.AnimateBase.prototype=new C.Element.ElementBase,C.Element.animate=function(t){this.base=C.Element.AnimateBase,this.base(t),this.calcValue=function(){var t=this.progress();return t.from.numValue()+(t.to.numValue()-t.from.numValue())*t.progress+this.initialUnits}},C.Element.animate.prototype=new C.Element.AnimateBase,C.Element.animateColor=function(t){this.base=C.Element.AnimateBase,this.base(t),this.calcValue=function(){var t,e,n=this.progress(),i=new RGBColor(n.from.value),a=new RGBColor(n.to.value);return i.ok&&a.ok?(t=i.r+(a.r-i.r)*n.progress,e=i.g+(a.g-i.g)*n.progress,a=i.b+(a.b-i.b)*n.progress,"rgb("+parseInt(t,10)+","+parseInt(e,10)+","+parseInt(a,10)+")"):this.attribute("from").value}},C.Element.animateColor.prototype=new C.Element.AnimateBase,C.Element.animateTransform=function(t){this.base=C.Element.AnimateBase,this.base(t),this.calcValue=function(){for(var t=this.progress(),e=C.ToNumberArray(t.from.value),n=C.ToNumberArray(t.to.value),i="",a=0;a<e.length;a++)i+=e[a]+(n[a]-e[a])*t.progress+" ";return i}},C.Element.animateTransform.prototype=new C.Element.animate,C.Element.font=function(t){this.base=C.Element.ElementBase,this.base(t),this.horizAdvX=this.attribute("horiz-adv-x").numValue(),this.isRTL=!1,this.isArabic=!1,this.fontFace=null,this.missingGlyph=null,this.glyphs=[];for(var e=0;e<this.children.length;e++){var n=this.children[e];"font-face"==n.type?(this.fontFace=n).style("font-family").hasValue()&&(C.Definitions[n.style("font-family").value]=this):"missing-glyph"==n.type?this.missingGlyph=n:"glyph"==n.type&&(""!=n.arabicForm?(this.isRTL=!0,this.isArabic=!0,void 0===this.glyphs[n.unicode]&&(this.glyphs[n.unicode]=[]),this.glyphs[n.unicode][n.arabicForm]=n):this.glyphs[n.unicode]=n)}},C.Element.font.prototype=new C.Element.ElementBase,C.Element.fontface=function(t){this.base=C.Element.ElementBase,this.base(t),this.ascent=this.attribute("ascent").value,this.descent=this.attribute("descent").value,this.unitsPerEm=this.attribute("units-per-em").numValue()},C.Element.fontface.prototype=new C.Element.ElementBase,C.Element.missingglyph=function(t){this.base=C.Element.path,this.base(t),this.horizAdvX=0},C.Element.missingglyph.prototype=new C.Element.path,C.Element.glyph=function(t){this.base=C.Element.path,this.base(t),this.horizAdvX=this.attribute("horiz-adv-x").numValue(),this.unicode=this.attribute("unicode").value,this.arabicForm=this.attribute("arabic-form").value},C.Element.glyph.prototype=new C.Element.path,C.Element.text=function(t){this.captureTextNodes=!0,this.base=C.Element.RenderedElementBase,this.base(t),this.baseSetContext=this.setContext,this.setContext=function(t){this.baseSetContext(t);var e=this.style("dominant-baseline").toTextBaseline();null!=(e=null==e?this.style("alignment-baseline").toTextBaseline():e)&&(t.textBaseline=e)},this.getBoundingBox=function(){var t=this.attribute("x").toPixels("x"),e=this.attribute("y").toPixels("y"),n=this.parent.style("font-size").numValueOrDefault(C.Font.Parse(C.ctx.font).fontSize);return new C.BoundingBox(t,e-n,t+Math.floor(2*n/3)*this.children[0].getText().length,e)},this.renderChildren=function(t){this.x=this.attribute("x").toPixels("x"),this.y=this.attribute("y").toPixels("y"),this.attribute("dx").hasValue()&&(this.x+=this.attribute("dx").toPixels("x")),this.attribute("dy").hasValue()&&(this.y+=this.attribute("dy").toPixels("y")),this.x+=this.getAnchorDelta(t,this,0);for(var e=0;e<this.children.length;e++)this.renderChild(t,this,e)},this.getAnchorDelta=function(t,e,n){var i=this.style("text-anchor").valueOrDefault("start");if("start"==i)return 0;for(var a=0,s=n;s<e.children.length;s++){var r=e.children[s];if(n<s&&r.attribute("x").hasValue())break;a+=r.measureTextRecursive(t)}return-1*("end"==i?a:a/2)},this.renderChild=function(t,e,n){var i=e.children[n];i.attribute("x").hasValue()?(i.x=i.attribute("x").toPixels("x")+e.getAnchorDelta(t,e,n),i.attribute("dx").hasValue()&&(i.x+=i.attribute("dx").toPixels("x"))):(i.attribute("dx").hasValue()&&(e.x+=i.attribute("dx").toPixels("x")),i.x=e.x),e.x=i.x+i.measureText(t),i.attribute("y").hasValue()?(i.y=i.attribute("y").toPixels("y"),i.attribute("dy").hasValue()&&(i.y+=i.attribute("dy").toPixels("y"))):(i.attribute("dy").hasValue()&&(e.y+=i.attribute("dy").toPixels("y")),i.y=e.y),e.y=i.y,i.render(t);for(n=0;n<i.children.length;n++)e.renderChild(t,i,n)}},C.Element.text.prototype=new C.Element.RenderedElementBase,C.Element.TextElementBase=function(t){this.base=C.Element.RenderedElementBase,this.base(t),this.getGlyph=function(t,e,n){var i,a=e[n],s=null;return s=null==(s=t.isArabic&&(i="isolated",(0==n||" "==e[n-1])&&n<e.length-2&&" "!=e[n+1]&&(i="terminal"),0<n&&" "!=e[n-1]&&n<e.length-2&&" "!=e[n+1]&&(i="medial"),0<n&&" "!=e[n-1]&&(n==e.length-1||" "==e[n+1])&&(i="initial"),void 0===t.glyphs[a]||null!=(s=t.glyphs[a][i])||"glyph"!=t.glyphs[a].type)?s:t.glyphs[a])?t.missingGlyph:s},this.renderChildren=function(t){var e=this.parent.style("font-family").getDefinition();if(null!=e)for(var n=this.parent.style("font-size").numValueOrDefault(C.Font.Parse(C.ctx.font).fontSize),i=this.parent.style("font-style").valueOrDefault(C.Font.Parse(C.ctx.font).fontStyle),a=this.getText(),s=(e.isRTL&&(a=a.split("").reverse().join("")),C.ToNumberArray(this.parent.attribute("dx").value)),r=0;r<a.length;r++){var o=this.getGlyph(e,a,r),l=n/e.fontFace.unitsPerEm,h=(t.translate(this.x,this.y),t.scale(l,-l),t.lineWidth);t.lineWidth=t.lineWidth*e.fontFace.unitsPerEm/n,"italic"==i&&t.transform(1,0,.4,1,0,0),o.render(t),"italic"==i&&t.transform(1,0,-.4,1,0,0),t.lineWidth=h,t.scale(1/l,-1/l),t.translate(-this.x,-this.y),this.x+=n*(o.horizAdvX||e.horizAdvX)/e.fontFace.unitsPerEm,void 0===s[r]||isNaN(s[r])||(this.x+=s[r])}else""!=t.fillStyle&&t.fillText(C.compressSpaces(this.getText()),this.x,this.y),""!=t.strokeStyle&&t.strokeText(C.compressSpaces(this.getText()),this.x,this.y)},this.getText=function(){},this.measureTextRecursive=function(t){for(var e=this.measureText(t),n=0;n<this.children.length;n++)e+=this.children[n].measureTextRecursive(t);return e},this.measureText=function(t){var e=this.parent.style("font-family").getDefinition();if(null!=e){for(var n=this.parent.style("font-size").numValueOrDefault(C.Font.Parse(C.ctx.font).fontSize),i=0,a=this.getText(),s=(e.isRTL&&(a=a.split("").reverse().join("")),C.ToNumberArray(this.parent.attribute("dx").value)),r=0;r<a.length;r++)i+=(this.getGlyph(e,a,r).horizAdvX||e.horizAdvX)*n/e.fontFace.unitsPerEm,void 0===s[r]||isNaN(s[r])||(i+=s[r]);return i}var o=C.compressSpaces(this.getText());if(!t.measureText)return 10*o.length;t.save(),this.setContext(t);o=t.measureText(o).width;return t.restore(),o}},C.Element.TextElementBase.prototype=new C.Element.RenderedElementBase,C.Element.tspan=function(t){this.captureTextNodes=!0,this.base=C.Element.TextElementBase,this.base(t),this.text=C.compressSpaces(t.value||t.text||t.textContent||""),this.getText=function(){return 0<this.children.length?"":this.text}},C.Element.tspan.prototype=new C.Element.TextElementBase,C.Element.tref=function(t){this.base=C.Element.TextElementBase,this.base(t),this.getText=function(){var t=this.getHrefAttribute().getDefinition();if(null!=t)return t.children[0].getText()}},C.Element.tref.prototype=new C.Element.TextElementBase,C.Element.a=function(t){this.base=C.Element.TextElementBase,this.base(t),this.hasText=0<t.childNodes.length;for(var e=0;e<t.childNodes.length;e++)3!=t.childNodes[e].nodeType&&(this.hasText=!1);this.text=this.hasText?t.childNodes[0].value:"",this.getText=function(){return this.text},this.baseRenderChildren=this.renderChildren,this.renderChildren=function(t){var e;this.hasText?(this.baseRenderChildren(t),e=new C.Property("fontSize",C.Font.Parse(C.ctx.font).fontSize),C.Mouse.checkBoundingBox(this,new C.BoundingBox(this.x,this.y-e.toPixels("y"),this.x+this.measureText(t),this.y))):0<this.children.length&&((e=new C.Element.g).children=this.children,e.parent=this,e.render(t))},this.onclick=function(){window.open(this.getHrefAttribute().value)},this.onmousemove=function(){C.ctx.canvas.style.cursor="pointer"}},C.Element.a.prototype=new C.Element.TextElementBase,C.Element.image=function(t){this.base=C.Element.RenderedElementBase,this.base(t);var s,e,n=this.getHrefAttribute().value;""!=n&&(s=n.match(/\.svg$/),C.Images.push(this),this.loaded=!1,s?(this.img=C.ajax(n),this.loaded=!0):(this.img=document.createElement("img"),1==C.opts.useCORS&&(this.img.crossOrigin="Anonymous"),(e=this).img.onload=function(){e.loaded=!0},this.img.onerror=function(){C.log('ERROR: image "'+n+'" not found'),e.loaded=!0},this.img.src=n),this.renderChildren=function(t){var e=this.attribute("x").toPixels("x"),n=this.attribute("y").toPixels("y"),i=this.attribute("width").toPixels("x"),a=this.attribute("height").toPixels("y");0!=i&&0!=a&&(t.save(),s?t.drawSvg(this.img,e,n,i,a):(t.translate(e,n),C.AspectRatio(t,this.attribute("preserveAspectRatio").value,i,this.img.width,a,this.img.height,0,0),t.drawImage(this.img,0,0)),t.restore())},this.getBoundingBox=function(){var t=this.attribute("x").toPixels("x"),e=this.attribute("y").toPixels("y"),n=this.attribute("width").toPixels("x"),i=this.attribute("height").toPixels("y");return new C.BoundingBox(t,e,t+n,e+i)})},C.Element.image.prototype=new C.Element.RenderedElementBase,C.Element.g=function(t){this.base=C.Element.RenderedElementBase,this.base(t),this.getBoundingBox=function(){for(var t=new C.BoundingBox,e=0;e<this.children.length;e++)t.addBoundingBox(this.children[e].getBoundingBox());return t}},C.Element.g.prototype=new C.Element.RenderedElementBase,C.Element.symbol=function(t){this.base=C.Element.RenderedElementBase,this.base(t),this.render=function(t){}},C.Element.symbol.prototype=new C.Element.RenderedElementBase,C.Element.style=function(t){this.base=C.Element.ElementBase,this.base(t);for(var e="",n=0;n<t.childNodes.length;n++)e+=t.childNodes[n].data;e=e.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(^[\s]*\/\/.*)/gm,"");for(var i=(e=C.compressSpaces(e)).split("}"),n=0;n<i.length;n++)if(""!=C.trim(i[n]))for(var a=i[n].split("{"),s=a[0].split(","),r=a[1].split(";"),o=0;o<s.length;o++){var l=C.trim(s[o]);if(""!=l){for(var h={},c=0;c<r.length;c++){var u=r[c].indexOf(":"),d=r[c].substr(0,u),u=r[c].substr(u+1,r[c].length-u);null!=d&&null!=u&&(h[C.trim(d)]=new C.Property(C.trim(d),C.trim(u)))}if(C.Styles[l]=h,C.StylesSpecificity[l]=function(i){function t(t,e){var n=i.match(t);null!=n&&(a[e]+=n.length,i=i.replace(t," "))}var a=[0,0,0];return i=(i=i.replace(/:not\(([^\)]*)\)/g,"     $1 ")).replace(/{[^]*/gm," "),t(_,1),t(x,0),t(M,1),t(k,2),t(P,1),t(E,1),i=(i=i.replace(/[\*\s\+>~]/g," ")).replace(/[#\.]/g," "),t(R,2),a.join("")}(l),"@font-face"==l)for(var p=h["font-family"].value.replace(/"/g,""),g=h.src.value.split(","),f=0;f<g.length;f++)if(0<g[f].indexOf('format("svg")'))for(var m=g[f].indexOf("url"),v=g[f].indexOf(")",m),v=g[f].substr(m+5,v-m-6),b=C.parseXml(C.ajax(v)).getElementsByTagName("font"),y=0;y<b.length;y++){var w=C.CreateElement(b[y]);C.Definitions[p]=w}}}},C.Element.style.prototype=new C.Element.ElementBase,C.Element.use=function(t){this.base=C.Element.RenderedElementBase,this.base(t),this.baseSetContext=this.setContext,this.setContext=function(t){this.baseSetContext(t),this.attribute("x").hasValue()&&t.translate(this.attribute("x").toPixels("x"),0),this.attribute("y").hasValue()&&t.translate(0,this.attribute("y").toPixels("y"))};var i=this.getHrefAttribute().getDefinition();this.path=function(t){null!=i&&i.path(t)},this.getBoundingBox=function(){if(null!=i)return i.getBoundingBox()},this.renderChildren=function(t){var e,n;null!=i&&("symbol"==(e=i).type&&((e=new C.Element.svg).type="svg",e.attributes.viewBox=new C.Property("viewBox",i.attribute("viewBox").value),e.attributes.preserveAspectRatio=new C.Property("preserveAspectRatio",i.attribute("preserveAspectRatio").value),e.attributes.overflow=new C.Property("overflow",i.attribute("overflow").value),e.children=i.children),"svg"==e.type&&(this.attribute("width").hasValue()&&(e.attributes.width=new C.Property("width",this.attribute("width").value)),this.attribute("height").hasValue()&&(e.attributes.height=new C.Property("height",this.attribute("height").value))),n=e.parent,e.parent=null,e.render(t),e.parent=n)}},C.Element.use.prototype=new C.Element.RenderedElementBase,C.Element.mask=function(t){this.base=C.Element.ElementBase,this.base(t),this.apply=function(t,e){var n=this.attribute("x").toPixels("x"),i=this.attribute("y").toPixels("y"),a=this.attribute("width").toPixels("x"),s=this.attribute("height").toPixels("y");if(0==a&&0==s){for(var r=new C.BoundingBox,o=0;o<this.children.length;o++)r.addBoundingBox(this.children[o].getBoundingBox());n=Math.floor(r.x1),i=Math.floor(r.y1),a=Math.floor(r.width()),s=Math.floor(r.height())}var l=e.attribute("mask").value,h=(e.attribute("mask").value="",document.createElement("canvas")),c=(h.width=n+a,h.height=i+s,h.getContext("2d")),u=(this.renderChildren(c),document.createElement("canvas")),d=(u.width=n+a,u.height=i+s,u.getContext("2d"));e.render(d),d.globalCompositeOperation="destination-in",d.fillStyle=c.createPattern(h,"no-repeat"),d.fillRect(0,0,n+a,i+s),t.fillStyle=d.createPattern(u,"no-repeat"),t.fillRect(0,0,n+a,i+s),e.attribute("mask").value=l},this.render=function(t){}},C.Element.mask.prototype=new C.Element.ElementBase,C.Element.clipPath=function(t){this.base=C.Element.ElementBase,this.base(t),this.apply=function(t){var e=CanvasRenderingContext2D.prototype.beginPath,n=(CanvasRenderingContext2D.prototype.beginPath=function(){},CanvasRenderingContext2D.prototype.closePath);CanvasRenderingContext2D.prototype.closePath=function(){},e.call(t);for(var i=0;i<this.children.length;i++){var a,s=this.children[i];void 0!==s.path&&(s.style("transform",!1,!(a=null)).hasValue()&&(a=new C.Transform(s.style("transform",!1,!0).value)).apply(t),s.path(t),CanvasRenderingContext2D.prototype.closePath=n,a&&a.unapply(t))}n.call(t),t.clip(),CanvasRenderingContext2D.prototype.beginPath=e,CanvasRenderingContext2D.prototype.closePath=n},this.render=function(t){}},C.Element.clipPath.prototype=new C.Element.ElementBase,C.Element.filter=function(t){this.base=C.Element.ElementBase,this.base(t),this.apply=function(t,e){for(var n=e.getBoundingBox(),i=Math.floor(n.x1),a=Math.floor(n.y1),s=Math.floor(n.width()),r=Math.floor(n.height()),n=e.style("filter").value,o=(e.style("filter").value="",0),l=0,h=0;h<this.children.length;h++)var c=this.children[h].extraFilterDistance||0,o=Math.max(o,c),l=Math.max(l,c);var u=document.createElement("canvas"),d=(u.width=s+2*o,u.height=r+2*l,u.getContext("2d"));d.translate(-i+o,-a+l),e.render(d);for(h=0;h<this.children.length;h++)"function"==typeof this.children[h].apply&&this.children[h].apply(d,0,0,s+2*o,r+2*l);t.drawImage(u,0,0,s+2*o,r+2*l,i-o,a-l,s+2*o,r+2*l),e.style("filter",!0).value=n},this.render=function(t){}},C.Element.filter.prototype=new C.Element.ElementBase,C.Element.feMorphology=function(t){this.base=C.Element.ElementBase,this.base(t),this.apply=function(t,e,n,i,a){}},C.Element.feMorphology.prototype=new C.Element.ElementBase,C.Element.feComposite=function(t){this.base=C.Element.ElementBase,this.base(t),this.apply=function(t,e,n,i,a){}},C.Element.feComposite.prototype=new C.Element.ElementBase,C.Element.feColorMatrix=function(t){this.base=C.Element.ElementBase,this.base(t);var n=C.ToNumberArray(this.attribute("values").value);switch(this.attribute("type").valueOrDefault("matrix")){case"saturate":var e=n[0],n=[.213+.787*e,.715-.715*e,.072-.072*e,0,0,.213-.213*e,.715+.285*e,.072-.072*e,0,0,.213-.213*e,.715-.715*e,.072+.928*e,0,0,0,0,0,1,0,0,0,0,0,1];break;case"hueRotate":function i(t,e,n){return t+Math.cos(a)*e+Math.sin(a)*n}var a=n[0]*Math.PI/180;n=[i(.213,.787,-.213),i(.715,-.715,-.715),i(.072,-.072,.928),0,0,i(.213,-.213,.143),i(.715,.285,.14),i(.072,-.072,-.283),0,0,i(.213,-.213,-.787),i(.715,-.715,.715),i(.072,.928,.072),0,0,0,0,0,1,0,0,0,0,0,1];break;case"luminanceToAlpha":n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2125,.7154,.0721,0,0,0,0,0,0,1]}function c(t,e,n,i,a,s){return t[n*i*4+4*e+s]}function u(t,e,n,i,a,s,r){t[n*i*4+4*e+s]=r}function d(t,e){t=n[t];return t*(t<0?e-255:e)}this.apply=function(t,e,n,i,a){for(var s=t.getImageData(0,0,i,a),n=0;n<a;n++)for(e=0;e<i;e++){var r=c(s.data,e,n,i,0,0),o=c(s.data,e,n,i,0,1),l=c(s.data,e,n,i,0,2),h=c(s.data,e,n,i,0,3);u(s.data,e,n,i,0,0,d(0,r)+d(1,o)+d(2,l)+d(3,h)+d(4,1)),u(s.data,e,n,i,0,1,d(5,r)+d(6,o)+d(7,l)+d(8,h)+d(9,1)),u(s.data,e,n,i,0,2,d(10,r)+d(11,o)+d(12,l)+d(13,h)+d(14,1)),u(s.data,e,n,i,0,3,d(15,r)+d(16,o)+d(17,l)+d(18,h)+d(19,1))}t.clearRect(0,0,i,a),t.putImageData(s,0,0)}},C.Element.feColorMatrix.prototype=new C.Element.ElementBase,C.Element.feGaussianBlur=function(t){this.base=C.Element.ElementBase,this.base(t),this.blurRadius=Math.floor(this.attribute("stdDeviation").numValue()),this.extraFilterDistance=this.blurRadius,this.apply=function(t,e,n,i,a){void 0===stackBlurCanvasRGBA?C.log("ERROR: StackBlur.js must be included for blur to work"):(t.canvas.id=C.UniqueId(),t.canvas.style.display="none",document.body.appendChild(t.canvas),stackBlurCanvasRGBA(t.canvas.id,e,n,i,a,this.blurRadius),document.body.removeChild(t.canvas))}},C.Element.feGaussianBlur.prototype=new C.Element.ElementBase,C.Element.title=function(t){},C.Element.title.prototype=new C.Element.ElementBase,C.Element.desc=function(t){},C.Element.desc.prototype=new C.Element.ElementBase,C.Element.MISSING=function(t){C.log("ERROR: Element '"+t.nodeName+"' not yet implemented.")},C.Element.MISSING.prototype=new C.Element.ElementBase,C.CreateElement=function(t){var e=(e=t.nodeName.replace(/^[^:]+:/,"")).replace(/\-/g,""),n=null;return(n=new(void 0!==C.Element[e]?C.Element[e]:C.Element.MISSING)(t)).type=t.nodeName,n},C.load=function(t,e){C.loadXml(t,C.ajax(e))},C.loadXml=function(t,e){C.loadXmlDoc(t,C.parseXml(e))},C.loadXmlDoc=function(s,r){C.init(s);function e(t){for(var e=s.canvas;e;)t.x-=e.offsetLeft,t.y-=e.offsetTop,e=e.offsetParent;return window.scrollX&&(t.x+=window.scrollX),window.scrollY&&(t.y+=window.scrollY),t}function n(){C.ViewPort.Clear(),s.canvas.parentNode&&C.ViewPort.SetCurrent(s.canvas.parentNode.clientWidth,s.canvas.parentNode.clientHeight),1!=C.opts.ignoreDimensions&&(o.style("width").hasValue()&&(s.canvas.width=o.style("width").toPixels("x"),s.canvas.style.width=s.canvas.width+"px"),o.style("height").hasValue()&&(s.canvas.height=o.style("height").toPixels("y"),s.canvas.style.height=s.canvas.height+"px"));var t,e,n,i=s.canvas.clientWidth||s.canvas.width,a=s.canvas.clientHeight||s.canvas.height;1==C.opts.ignoreDimensions&&o.style("width").hasValue()&&o.style("height").hasValue()&&(i=o.style("width").toPixels("x"),a=o.style("height").toPixels("y")),C.ViewPort.SetCurrent(i,a),null!=C.opts.offsetX&&(o.attribute("x",!0).value=C.opts.offsetX),null!=C.opts.offsetY&&(o.attribute("y",!0).value=C.opts.offsetY),null==C.opts.scaleWidth&&null==C.opts.scaleHeight||(e=t=null,n=C.ToNumberArray(o.attribute("viewBox").value),null!=C.opts.scaleWidth&&(o.attribute("width").hasValue()?t=o.attribute("width").toPixels("x")/C.opts.scaleWidth:isNaN(n[2])||(t=n[2]/C.opts.scaleWidth)),null!=C.opts.scaleHeight&&(o.attribute("height").hasValue()?e=o.attribute("height").toPixels("y")/C.opts.scaleHeight:isNaN(n[3])||(e=n[3]/C.opts.scaleHeight)),null==t&&(t=e),null==e&&(e=t),o.attribute("width",!0).value=C.opts.scaleWidth,o.attribute("height",!0).value=C.opts.scaleHeight,o.style("transform",!0,!0).value+=" scale("+1/t+","+1/e+")"),1!=C.opts.ignoreClear&&s.clearRect(0,0,i,a),o.render(s),l&&(l=!1,"function"==typeof C.opts.renderCallback&&C.opts.renderCallback(r))}1!=C.opts.ignoreMouse&&(s.canvas.onclick=function(t){t=e(new C.Point((null!=t?t:event).clientX,(null!=t?t:event).clientY));C.Mouse.onclick(t.x,t.y)},s.canvas.onmousemove=function(t){t=e(new C.Point((null!=t?t:event).clientX,(null!=t?t:event).clientY));C.Mouse.onmousemove(t.x,t.y)});var o=C.CreateElement(r.documentElement),l=(o.root=!0,o.addStylesFromStyleDefinition(),!0),i=!0;C.ImagesLoaded()&&(i=!1,n()),C.intervalID=setInterval(function(){var t=!1;if(i&&C.ImagesLoaded()&&(t=!(i=!1)),1!=C.opts.ignoreMouse&&(t|=C.Mouse.hasEvents()),1!=C.opts.ignoreAnimation)for(var e=0;e<C.Animations.length;e++)t|=C.Animations[e].update(1e3/C.FRAMERATE);(t="function"==typeof C.opts.forceRedraw&&1==C.opts.forceRedraw()?!0:t)&&(n(),C.Mouse.runEvents())},1e3/C.FRAMERATE)},C.stop=function(){C.intervalID&&clearInterval(C.intervalID)},C.Mouse=new function(){this.events=[],this.hasEvents=function(){return 0!=this.events.length},this.onclick=function(t,e){this.events.push({type:"onclick",x:t,y:e,run:function(t){t.onclick&&t.onclick()}})},this.onmousemove=function(t,e){this.events.push({type:"onmousemove",x:t,y:e,run:function(t){t.onmousemove&&t.onmousemove()}})},this.eventElements=[],this.checkPath=function(t,e){for(var n=0;n<this.events.length;n++){var i=this.events[n];e.isPointInPath&&e.isPointInPath(i.x,i.y)&&(this.eventElements[n]=t)}},this.checkBoundingBox=function(t,e){for(var n=0;n<this.events.length;n++){var i=this.events[n];e.isPointInBox(i.x,i.y)&&(this.eventElements[n]=t)}},this.runEvents=function(){C.ctx.canvas.style.cursor="";for(var t=0;t<this.events.length;t++)for(var e=this.events[t],n=this.eventElements[t];n;)e.run(n),n=n.parent;this.events=[],this.eventElements=[]}},C}(n||{}),t=(1==t.childNodes.length&&"OBJECT"==t.childNodes[0].nodeName||(t.svg=n),t.getContext("2d"));void 0!==e.documentElement?n.loadXmlDoc(t,e):"<"==e.substr(0,1)?n.loadXml(t,e):n.load(t,e)}},void 0!==Element.prototype.matches?h=function(t,e){return t.matches(e)}:void 0!==Element.prototype.webkitMatchesSelector?h=function(t,e){return t.webkitMatchesSelector(e)}:void 0!==Element.prototype.mozMatchesSelector?h=function(t,e){return t.mozMatchesSelector(e)}:void 0!==Element.prototype.msMatchesSelector?h=function(t,e){return t.msMatchesSelector(e)}:void 0!==Element.prototype.oMatchesSelector?h=function(t,e){return t.oMatchesSelector(e)}:void 0===(h="function"!=typeof jQuery&&"function"!=typeof Zepto?h:function(t,e){return $(t).is(e)})&&(h=Sizzle.matchesSelector);var h,_=/(\[[^\]]+\])/g,x=/(#[^\s\+>~\.\[:]+)/g,M=/(\.[^\s\+>~\.\[:]+)/g,k=/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi,P=/(:[\w-]+\([^\)]*\))/gi,E=/(:[^\s\+>~\.\[:]+)/g,R=/([^\s\+>~\.\[:]+)/g}(),"undefined"!=typeof CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.drawSvg=function(t,e,n,i,a){canvg(this.canvas,t,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:e,offsetY:n,scaleWidth:i,scaleHeight:a})});var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function premultiplyAlpha(t){for(var e=t.data,n=t.width*t.height*4,i=0;i<n;i+=4){var a=e[i+3]/255;e[i]*=a,e[i+1]*=a,e[i+2]*=a}}function unpremultiplyAlpha(t){for(var e=t.data,n=t.width*t.height*4,i=0;i<n;i+=4){var a=e[i+3];0!=a&&(e[i]*=a=255/a,e[i+1]*=a,e[i+2]*=a)}}function stackBlurImage(t,e,n,i){var t=document.getElementById(t),a=t.naturalWidth,s=t.naturalHeight,r=document.getElementById(e),r=(r.style.width=a+"px",r.style.height=s+"px",r.width=a,r.height=s,r.getContext("2d"));r.clearRect(0,0,a,s),r.drawImage(t,0,0),isNaN(n)||n<1||(i?stackBlurCanvasRGBA:stackBlurCanvasRGB)(e,0,0,a,s,n)}function stackBlurCanvasRGBA(e,V,N,n,i,t){if(!(isNaN(t)||t<1)){t|=0;var a,e=document.getElementById(e).getContext("2d");try{try{a=e.getImageData(V,N,n,i)}catch(t){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),a=e.getImageData(V,N,n,i)}catch(t){throw alert("Cannot access local image"),new Error("unable to access local image data: "+t)}}}catch(t){throw alert("Cannot access image"),new Error("unable to access image data: "+t)}premultiplyAlpha(a);for(var s,r,$,o,l,h,c,u,d,p,g,f,m,v,b,y,w,_,x,C,M,k=a.data,D=t+t+1,O=n-1,G=i-1,P=t+1,E=P*(P+1)/2,R=new BlurStack,L=R,A=1;A<D;A++){var z,L=L.next=new BlurStack;A==P&&(z=L)}L.next=R;for(var S=null,B=null,F=o=0,I=mul_table[t],q=shg_table[t],T=0;T<i;T++){for(m=v=b=y=l=h=c=u=0,d=P*(w=k[o]),p=P*(_=k[o+1]),g=P*(x=k[o+2]),f=P*(C=k[o+3]),l+=E*w,h+=E*_,c+=E*x,u+=E*C,L=R,A=0;A<P;A++)L.r=w,L.g=_,L.b=x,L.a=C,L=L.next;for(A=1;A<P;A++)l+=(L.r=w=k[r=o+((O<A?O:A)<<2)])*(M=P-A),h+=(L.g=_=k[r+1])*M,c+=(L.b=x=k[r+2])*M,u+=(L.a=C=k[r+3])*M,m+=w,v+=_,b+=x,y+=C,L=L.next;for(S=R,B=z,s=0;s<n;s++)k[o]=l*I>>q,k[o+1]=h*I>>q,k[o+2]=c*I>>q,k[o+3]=u*I>>q,l-=d,h-=p,c-=g,u-=f,d-=S.r,p-=S.g,g-=S.b,f-=S.a,r=F+((r=s+t+1)<O?r:O)<<2,l+=m+=S.r=k[r],h+=v+=S.g=k[r+1],c+=b+=S.b=k[r+2],u+=y+=S.a=k[r+3],S=S.next,d+=w=B.r,p+=_=B.g,g+=x=B.b,f+=C=B.a,m-=w,v-=_,b-=x,y-=C,B=B.next,o+=4;F+=n}for(s=0;s<n;s++){for(v=b=y=m=h=c=u=l=0,d=P*(w=k[o=s<<2]),p=P*(_=k[o+1]),g=P*(x=k[o+2]),f=P*(C=k[o+3]),l+=E*w,h+=E*_,c+=E*x,u+=E*C,L=R,A=0;A<P;A++)L.r=w,L.g=_,L.b=x,L.a=C,L=L.next;for($=n,A=1;A<=t;A++)l+=(L.r=w=k[o=$+s<<2])*(M=P-A),h+=(L.g=_=k[o+1])*M,c+=(L.b=x=k[o+2])*M,u+=(L.a=C=k[o+3])*M,m+=w,v+=_,b+=x,y+=C,L=L.next,A<G&&($+=n);for(o=s,S=R,B=z,T=0;T<i;T++)k[r=o<<2]=l*I>>q,k[r+1]=h*I>>q,k[r+2]=c*I>>q,k[r+3]=u*I>>q,l-=d,h-=p,c-=g,u-=f,d-=S.r,p-=S.g,g-=S.b,f-=S.a,r=s+((r=T+P)<G?r:G)*n<<2,l+=m+=S.r=k[r],h+=v+=S.g=k[r+1],c+=b+=S.b=k[r+2],u+=y+=S.a=k[r+3],S=S.next,d+=w=B.r,p+=_=B.g,g+=x=B.b,f+=C=B.a,m-=w,v-=_,b-=x,y-=C,B=B.next,o+=n}unpremultiplyAlpha(a),e.putImageData(a,V,N)}}function stackBlurCanvasRGB(e,n,i,a,s,t){if(!(isNaN(t)||t<1)){t|=0;var r,e=document.getElementById(e).getContext("2d");try{try{r=e.getImageData(n,i,a,s)}catch(t){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),r=e.getImageData(n,i,a,s)}catch(t){throw alert("Cannot access local image"),new Error("unable to access local image data: "+t)}}}catch(t){throw alert("Cannot access image"),new Error("unable to access image data: "+t)}for(var o,l,h,c,u,d,p,g,f,m,v,b,y,w,_,x,C,M=r.data,V=t+t+1,k=a-1,N=s-1,P=t+1,E=P*(P+1)/2,R=new BlurStack,L=R,A=1;A<V;A++){var $,L=L.next=new BlurStack;A==P&&($=L)}L.next=R;for(var S=null,B=null,D=c=0,I=mul_table[t],q=shg_table[t],T=0;T<s;T++){for(v=b=y=u=d=p=0,g=P*(w=M[c]),f=P*(_=M[c+1]),m=P*(x=M[c+2]),u+=E*w,d+=E*_,p+=E*x,L=R,A=0;A<P;A++)L.r=w,L.g=_,L.b=x,L=L.next;for(A=1;A<P;A++)u+=(L.r=w=M[l=c+((k<A?k:A)<<2)])*(C=P-A),d+=(L.g=_=M[l+1])*C,p+=(L.b=x=M[l+2])*C,v+=w,b+=_,y+=x,L=L.next;for(S=R,B=$,o=0;o<a;o++)M[c]=u*I>>q,M[c+1]=d*I>>q,M[c+2]=p*I>>q,u-=g,d-=f,p-=m,g-=S.r,f-=S.g,m-=S.b,l=D+((l=o+t+1)<k?l:k)<<2,u+=v+=S.r=M[l],d+=b+=S.g=M[l+1],p+=y+=S.b=M[l+2],S=S.next,g+=w=B.r,f+=_=B.g,m+=x=B.b,v-=w,b-=_,y-=x,B=B.next,c+=4;D+=a}for(o=0;o<a;o++){for(b=y=v=d=p=u=0,g=P*(w=M[c=o<<2]),f=P*(_=M[c+1]),m=P*(x=M[c+2]),u+=E*w,d+=E*_,p+=E*x,L=R,A=0;A<P;A++)L.r=w,L.g=_,L.b=x,L=L.next;for(h=a,A=1;A<=t;A++)u+=(L.r=w=M[c=h+o<<2])*(C=P-A),d+=(L.g=_=M[c+1])*C,p+=(L.b=x=M[c+2])*C,v+=w,b+=_,y+=x,L=L.next,A<N&&(h+=a);for(c=o,S=R,B=$,T=0;T<s;T++)M[l=c<<2]=u*I>>q,M[l+1]=d*I>>q,M[l+2]=p*I>>q,u-=g,d-=f,p-=m,g-=S.r,f-=S.g,m-=S.b,l=o+((l=T+P)<N?l:N)*a<<2,u+=v+=S.r=M[l],d+=b+=S.g=M[l+1],p+=y+=S.b=M[l+2],S=S.next,g+=w=B.r,f+=_=B.g,m+=x=B.b,v-=w,b-=_,y-=x,B=B.next,c+=a}e.putImageData(r,n,i)}}function BlurStack(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}!function(t){"use strict";var c,u=t.Uint8Array,t=t.HTMLCanvasElement,e=t&&t.prototype,r=/\s*;\s*base64\s*(?:;|$)/i,o="toDataURL";u&&(c=new u([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),!t||e.toBlob&&e.toBlobHD||(e.toBlob||(e.toBlob=function(t,e){var n,i,a,s;e=e||"image/png",this.mozGetAsFile?t(this.mozGetAsFile("canvas",e)):this.msToBlob&&/^\s*image\/png\s*(?:$|;)/i.test(e)?t(this.msToBlob()):(a=Array.prototype.slice.call(arguments,1),n=(a=this[o].apply(this,a)).indexOf(","),i=a.substring(n+1),a=r.test(a.substring(0,n)),Blob.fake?((s=new Blob).encoding=a?"base64":"URI",s.data=i,s.size=i.length):u&&(s=a?new Blob([function(t){for(var e,n,i=t.length,a=new u(i/4*3|0),s=0,r=0,o=[0,0],l=0,h=0;i--;)n=t.charCodeAt(s++),255!==(e=c[n-43])&&void 0!==e&&(o[1]=o[0],o[0]=n,h=h<<6|e,4===++l&&(a[r++]=h>>>16,61!==o[1]&&(a[r++]=h>>>8),61!==o[0]&&(a[r++]=h),l=0));return a}(i)],{type:e}):new Blob([decodeURIComponent(i)],{type:e})),t(s))}),!e.toBlobHD&&e.toDataURLHD?e.toBlobHD=function(){o="toDataURLHD";var t=this.toBlob();return o="toDataURL",t}:e.toBlobHD=e.toBlob)}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this);var saveAs=saveAs||function(o){"use strict";var l,h,c,u,d,p,e,g,f,i,t;if(!(void 0===o||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent)))return t=o.document,l=function(){return o.URL||o.webkitURL||o},h=t.createElementNS("http://www.w3.org/1999/xhtml","a"),c="download"in h,u=/constructor/i.test(o.HTMLElement)||o.safari,d=/CriOS\/[\d]+/.test(navigator.userAgent),p=function(t){(o.setImmediate||o.setTimeout)(function(){throw t},0)},e=4e4,g=function(t){setTimeout(function(){"string"==typeof t?l().revokeObjectURL(t):t.remove()},e)},f=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob([String.fromCharCode(65279),t],{type:t.type}):t},t=(i=function(t,n,e){e||(t=f(t));var i,a,s=this,e="application/octet-stream"===t.type,r=function(){for(var t=s,e="writestart progress write writeend".split(" "),n=void 0,i=(e=[].concat(e)).length;i--;){var a=t["on"+e[i]];if("function"==typeof a)try{a.call(t,n||t)}catch(t){p(t)}}};s.readyState=s.INIT,c?(i=l().createObjectURL(t),setTimeout(function(){var t,e;h.href=i,h.download=n,t=h,e=new MouseEvent("click"),t.dispatchEvent(e),r(),g(i),s.readyState=s.DONE})):(d||e&&u)&&o.FileReader?((a=new FileReader).onloadend=function(){var t=d?a.result:a.result.replace(/^data:[^;]*;/,"data:attachment/file;");o.open(t,"_blank")||(o.location.href=t),s.readyState=s.DONE,r()},a.readAsDataURL(t),s.readyState=s.INIT):(i=i||l().createObjectURL(t),!e&&o.open(i,"_blank")||(o.location.href=i),s.readyState=s.DONE,r(),g(i))}).prototype,"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(t,e,n){return e=e||t.name||"download",n||(t=f(t)),navigator.msSaveOrOpenBlob(t,e)}:(t.abort=function(){},t.readyState=t.INIT=0,t.WRITING=1,t.DONE=2,t.error=t.onwritestart=t.onprogress=t.onwrite=t.onabort=t.onerror=t.onwriteend=null,function(t,e,n){return new i(t,e||t.name||"download",n)})}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);function svgToPNG(t,e){null==e&&(e="structure.png");var n=window.URL||window.webkitURL||window,t=(t=$("<div>").append($("[id="+t+"] svg:eq(0)").clone()).html()).replace('xmlns="http://www.w3.org/2000/svg" xmlns:NS1="" NS1:xmlns:xlink="http://www.w3.org/1999/xlink"',""),t=new Blob([t],{type:"image/svg+xml"}),n=n.createObjectURL(t);$("body").append('<canvas display="none" id="tmpcanvas"></canvas>'),canvg("tmpcanvas",n,{renderCallback:function(){var t=document.getElementById("tmpcanvas");t.toBlob(function(t){saveAs(t,e)}),t.parentNode.removeChild(t)}})}function qmeanLocalColour(t,e){return.4<t?null==e?"rgb("+Math.round(255*(1-t)*(1/.6))+",80,"+Math.round(255*(t-.4)*(1/.6))+")":"rgba("+Math.round(255*(1-t)*(1/.6))+",80,"+Math.round(255*(t-.4)*(1/.6))+","+e+")":null==e?"rgb(255,80,0)":"rgba(255,80,0,"+e+")"}function drawQMEANLocal(t,g,f,m,e,v,b){var y=v?"qmb":"qm",w=["lq-chart"+(f?"-"+f:"")];if(e||!(0<$("#"+w[0]+" svg").length)){var _=chainMapping.structures[t];for(let t=0;t<Object.keys(_).length;t++){var n="lq-chart"+(f?"-"+f:"");if(0==t&&(0==$("#"+n).length?$("body").append("<div"+(f?' rel="'+f+'"':"")+' id="'+n+'" style="display:none"></div>'):$("#"+n).empty(),$("#"+n+"-thumb").empty()),1==Object.keys(_).length)break;n+="-"+Object.keys(_)[t],w.push(n),0==$("#"+n).length?$("body").append("<div"+(f?' rel="'+f+'"':"")+' id="'+n+'" style="display:none"></div>'):$("#"+n).empty(),0==$('a[href="#'+n+'"]').length&&$("body").append('<a href="#'+n+'" rel="lq-'+(f||"")+'" class="fancybox"/>')}let p=!0;b=b||200;for(let d=0;d<w.length;d++){let a,s,r,o=0,l=0,h=0,t=!1;if(p){if($("#"+w[d]+"-thumb").attr("title","Click to enlarge"),a=$("#"+w[d]+"-thumb").closest(":visible").width(),s=$("#"+w[d]+"-thumb").closest(":visible").height(),null==a||null==s)return;(s=0==s?Math.min(b,.5*a):s)>=b?(r=12,o=45,l=30,h=40,t=!0):(m&&(o=30,l=16),r=Math.max(15,s/10))}else r=20,o=45,l=30,h=40,a=.7*$(window).width()+o,s=.7*$(window).height()+h+l;var x=Raphael(w[d]+(p?"-thumb":""),a,s),C=99999,M=0;let e=0,n=0,c=999,i=0;for(var k=Object.keys(_),P=0;P<k.length;P++)if(!(0<d&&d-1!=P))for(var E=0;E<_[k[P]].length;E++)_[k[P]][E]&&_[k[P]][E][y]&&(c=Math.min(c,_[k[P]][E][y]),i=Math.max(i,_[k[P]][E][y]),C=Math.min(_[k[P]][E].resno,C),M=Math.max(_[k[P]][E].resno,M),n+=1,e+=_[k[P]][E][y]);var R=i<=1;let u=1;c=R?Math.min(.3,c):(u=100,Math.min(70,c)),null==g&&(g=e/n),$("#avgLocalQMEAN,#avgLocalScore_"+f).html(isNaN(g)?"-":g.toFixed(2));var L=s-h-l,A=(a-o)/(M-C);if(x.rect(0,0,a,s).attr({fill:"#FFF",stroke:"#FFF"}),p&&!t)x.rect(o,l,a-o,L).attr({stroke:"#DDD"}),m&&(x.text(a/2,8,"Local Quality Estimate").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,s/24)}),x.text(6,s/2+l/2,"Predicted Local").attr({"text-anchor":"middle",fill:"#666","font-size":Math.max(8,s/26)}).rotate(270,6,s/2+l/2),x.text(18,s/2+l/2,"Similarity to Target").attr({"text-anchor":"middle",fill:"#666","font-size":Math.max(8,s/26)}).rotate(270,18,s/2+l/2));else{x.rect(o,l,a-o,L).attr({stroke:"#DDD"});let t=14,e="Local Quality Estimate",n=(v&&(e+=" (QMEANBrane) "),0==d?1==k.length?e+=" - Chain "+k[0]:e+=" - All Chains":e+=" - Chain "+k[d-1],x.text(a/2,10,e).attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,s/26)}),p?(x.text(6,s/2,"Predicted Local").attr({"text-anchor":"middle",fill:"#666","font-size":r}).rotate(270,6,s/2),x.text(18,s/2,"Similarity to Target").attr({"text-anchor":"middle",fill:"#666","font-size":r}).rotate(270,18,s/2),t=.8*r):x.text(10,s/2,"Predicted Local Similarity to Target").attr({dy:10,"text-anchor":"middle",fill:"#666","font-size":r}).rotate(270,10,s/2),x.text(o+(a-o)/2,s-8,"Residue Number").attr({"text-anchor":"middle",fill:"#666","font-size":r}),null);for(P=u;P>=c;P-=R?.1:10){x.path("M"+o+" "+(L/(u-c)*(u-P)+l)+"L"+(o-5)+" "+(L/(u-c)*(u-P)+l)).attr({stroke:"#CCC","stroke-width":1});var S=L/(u-c)*(u-P)+l;(!S||n+t<S)&&(x.text(o-12,S,P.toFixed(R?1:0)).attr({fill:"#444","font-size":t}),n=S)}var B=Math.floor((M-C)/8);B-=B%10,B=Math.max(10,B);let i=null;for(var I,q,P=C;P<M;P++)P%B==0&&(I=o+(P-C)/(M-C)*(a-o),i&&i>I||(q=x.text(I,s-h+12,P).attr({fill:"#444","font-size":t}),i=I+q.getBBox().width))}var T=["#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"],V=0;for(let i=0;i<k.length;i++){let n=null;if(0==d||d-1==i){var N=L/(u-Math.min(c,g))*(u-g)+l;for(let e=0;e<_[k[i]].length;e++)if(_[k[i]][e]){var D=_[k[i]][e][y];if(null!=D){var O,G=o+A*(_[k[i]][e].resno-C);let t=N-L/(u-c)*(D-g);0==d&&1<k.length?(t=Math.min(t,L+l),null==n?n="M"+G+" "+t:n+="L"+G+" "+t,n+="L"+(G+A)+" "+t):(bar=g<D?x.rect(G,t,A,L/(u-c)*(D-g)):(O=L/(u-c)*(g-D),O=Math.min(O,L-N+l),x.rect(G,N,A,O)),G=qmeanLocalColour(R?D:D/100),bar.attr({stroke:G,"stroke-width":.7,fill:G,"fill-opacity":.4}))}}0==d&&1<k.length&&((n=x.path(n)).attr({stroke:T[V],"stroke-width":p?1:1.5}),p||$("#lq-chart"+(f?"-"+f:"")).append((0==i?"<br>Key: ":"")+' <span style="margin-right:4px; color:'+T[V]+'">Chain '+k[i]+";</span>"))}V=++V%T.length}p&&(p=!1,d--)}}}function drawQMEANGlobal(t,e,n,p,i){var a=$("#qn-chart"+(n?"-"+n:"")+"-thumb,#qn-chart"+(n?"-"+n:""));if(t){var s="qmeanGlobalTbl"+(n||"");if(i||!(0<$("#"+s+" tr").length)){a.empty(),$("#"+s+" tr").remove(),t.QMEAN4&&(t.qmean4_norm_score=t.qmean4_norm,delete t.qmean4_norm,t.qmean4_z_score=t.QMEAN4,delete t.QMEAN4,t.cbeta_z_score=t.cbeta,delete t.cbeta,t.interaction_z_score=t.all_atom,delete t.all_atom,t.packing_z_score=t.solvation,delete t.solvation,t.torsion_z_score=t.torsion,delete t.torsion),t.qmean4&&(t.qmean4_norm_score=parseFloat(t.qmean4.norm),t.qmean4_z_score=parseFloat(t.qmean4.zscore),delete t.qmean4,t.cbeta_z_score=parseFloat(t.cbeta.zscore),delete t.cbeta,t.interaction_z_score=parseFloat(t.all_atom.zscore),delete t.all_atom,t.packing_z_score=parseFloat(t.solvation.zscore),delete t.solvation,t.torsion_z_score=parseFloat(t.torsion.zscore),delete t.torsion,delete t.acc_agreement,delete t.ss_agreement,delete t.qmean6);for(var r=[["qmean4_z_score","QMEAN"],["cbeta_z_score","C"],["interaction_z_score","All Atom"],["packing_z_score","solvation"],["torsion_z_score","torsion"]],o="",l=0;l<r.length;l++)null!=t[r[l][0]]&&(o+='<tr><td width="1">'+r[l][1]+'</td><td width="100%" style="padding:0px 2px 0px 2px;"><div id="'+s+"_"+r[l][0]+'">&nbsp;</div></td><td width="1" nowrap="nowrap" style="text-align:right">'+t[r[l][0]].toFixed(2)+"</td></tr>");$("#"+s).append(o);var h=$("#"+s+"_"+r[0][0]).innerWidth(),c=$("#"+s+"_"+r[0][0]).parent().innerHeight();(h<1||c<1)&&(h=290,c=20);for(l=0;l<r.length;l++)$("#"+s+"_"+r[l][0]).html("");for(var u=h/8,d=0;d<r.length;d++)if(null!=t[r[d][0]]){for(var g,f=Raphael(s+"_"+r[d][0],h,c),m=(f.rect(0,0,h,c).attr({fill:"0-rgb(245,61,61)-#fff:75-rgb(77,77,255)"}),c/4),l=1;l<8;l++)f.path("M"+u*l+" 0L"+u*l+" "+m).attr({stroke:"#555"}),f.path("M"+u*l+" "+(c-m)+"L"+u*l+" "+c).attr({stroke:"#555"});t&&(g=t[r[d][0]],g=Math.min(g,1.95),g=Math.max(g,-5.95),f.path("M"+(u*g+6*u)+" 0L"+(u*g+6*u)+" "+c).attr({stroke:"#222","stroke-width":3}))}var v=t.qmean4_norm_score,b=Math.min(600,e),y=!0;a.each(function(t,e){let n,i,a,s=0,r=0,o=0;y?($(this).attr("title","Click to enlarge"),340<(n=$(this).closest(":visible").width())?(a=12,s=45,r=30,o=40,n-=s,i=400/620*n-o+r):(i=.5*n,p&&(s=15,r=30),a=Math.max(15,i/10))):(a=20,s=45,r=30,o=40,n=617+s,i=398+o+r);var l=Raphael($(this).attr("id"),n,i),h=i-o-r,c=b/600*(n-s)+s,u=h-v/1.5*h+r;l.rect(0,0,n,i).attr({fill:"#FFF",stroke:"#FFF"}),"undefined"==typeof localQMEANNormImage?l.image("/static/images/qmean_norm.png",s,r,n-s,h):l.image(localQMEANNormImage,s,r,n-s,h),l.rect(s,r,n-s,h).attr({stroke:"#DDD"}),l.text(c,u,String.fromCharCode(9733)).attr({"text-anchor":"middle",fill:"#F44","font-size":a});if(y)p&&(l.text((n+s)/2,8,"Comparison with Non-redundant").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,n/32)}),l.text((n+s)/2,22,"Set of PDB Structures").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,n/32)}),l.text(6,i/2+r/2,"Normalized QMEAN4").attr({"text-anchor":"middle",fill:"#666","font-size":Math.max(8,n/32)}).rotate(270,6,i/2+r/2)),l.rect(s+1,i-Math.max(16,n/16),n-s-2,Math.max(16,n/16)).attr({fill:"#FFF","stroke-width":0}),l.text(n/2,i-8,"Protein Size (Residues)").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,n/32)});else{l.text((n+s)/2,10,"Comparison with Non-redundant Set of PDB Structures").attr({"text-anchor":"middle",fill:"#444","font-size":a}),l.text(10,i/2,"Normalized QMEAN4 Score").attr({"text-anchor":"middle",fill:"#666","font-size":a}).rotate(270,10,i/2),l.text(s+(n-s)/2,i-12,"Protein Size (Residues)").attr({"text-anchor":"middle",fill:"#666","font-size":a});for(var d=100;d<600;d+=100)l.text(s+d*(n-s)/600,i-o+8,d).attr({fill:"#444","font-size":14});for(d=1.5;0<=d;d-=.5)l.text(s-12,d/1.5*h+r,(1.5-d).toFixed(1)).attr({fill:"#444","font-size":14})}y=!1})}}}"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});